<%- include('includes/header2', { title: 'Task Details' }) %>

<style>
    /* --- Dark Theme Palette --- */
    :root {
        --chat-bg: #0f172a;       /* Very dark blue/slate for background */
        --chat-surface: #1e293b;  /* Slightly lighter for cards/bubbles */
        --chat-border: #334155;   /* Border color */
        --chat-text: #f1f5f9;     /* Main text */
        --chat-meta: #94a3b8;     /* Secondary text */
        --primary-accent: #3b82f6;
    }

    /* --- Chat Layout --- */
    .chat-card {
        background-color: var(--chat-surface);
        border: 1px solid var(--chat-border);
        border-radius: 12px;
        overflow: hidden;
    }

    .chat-header {
        padding: 15px 20px;
        border-bottom: 1px solid var(--chat-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-body {
        padding: 20px;
        background-color: var(--chat-bg);
        min-height: 300px;
        max-height: 600px;
        overflow-y: auto;
    }

    .chat-footer {
        padding: 15px 20px;
        background-color: var(--chat-surface);
        border-top: 1px solid var(--chat-border);
        position: relative; /* For emoji picker positioning */
    }

    /* --- Comments --- */
    .comment-item {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        animation: fadeIn 0.2s ease-in;
    }
    
    .comment-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--chat-border);
    }

    .comment-content {
        max-width: 80%;
    }

    .comment-bubble {
        background-color: var(--chat-surface);
        border: 1px solid var(--chat-border);
        padding: 10px 14px;
        border-radius: 0 12px 12px 12px;
        color: var(--chat-text);
        position: relative;
    }
    
    /* Author Header */
    .comment-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }
    .comment-author { font-weight: 600; font-size: 0.9rem; color: #fff; }
    .comment-time { font-size: 0.75rem; color: var(--chat-meta); }

    /* Text & Files */
    .comment-text {
        font-size: 0.95rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .comment-image-preview {
        display: block;
        max-width: 100%;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
        border: 1px solid var(--chat-border);
    }

    .comment-file-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255,255,255,0.05);
        padding: 6px 10px;
        border-radius: 6px;
        color: var(--primary-accent);
        text-decoration: none;
        margin-top: 5px;
        font-size: 0.85rem;
    }
    .comment-file-link:hover { background: rgba(255,255,255,0.1); }

    /* --- New Input Styling (Pill Shape) --- */
    .input-container {
        display: flex;
        align-items: flex-end;
        background-color: var(--chat-bg);
        border: 1px solid var(--chat-border);
        border-radius: 24px;
        padding: 8px 16px;
        transition: all 0.2s ease;
    }

    .input-container:focus-within {
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .chat-input {
        flex: 1;
        background: transparent;
        border: none;
        color: #fff;
        max-height: 100px;
        resize: none;
        padding: 8px 0;
        font-size: 0.95rem;
    }
    .chat-input:focus { outline: none; }
    .chat-input::placeholder { color: var(--chat-meta); }

    .input-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px; /* Align with single line text */
        margin-right: 8px;
    }

    .input-btn {
        background: transparent;
        border: none;
        color: var(--chat-meta);
        cursor: pointer;
        padding: 6px;
        border-radius: 50%;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .input-btn:hover { background-color: rgba(255,255,255,0.1); color: #fff; }
    .input-btn i { font-size: 1.2rem; }

    .send-btn {
        background-color: var(--primary-accent);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin-bottom: 2px;
        transition: 0.2s;
    }
    .send-btn:hover { background-color: #2563eb; transform: scale(1.05); }

    /* --- Emoji Picker (Floating Modal) --- */
    .emoji-picker-modal {
        position: absolute;
        bottom: 70px; /* Floats above footer */
        left: 20px;
        background-color: var(--chat-surface);
        border: 1px solid var(--chat-border);
        border-radius: 12px;
        padding: 12px;
        width: 300px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 50;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .emoji-btn {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        border-radius: 6px;
        transition: 0.2s;
    }
    .emoji-btn:hover { background-color: rgba(255,255,255,0.1); transform: scale(1.1); }

    /* --- File Preview --- */
    .file-preview-area {
        margin-bottom: 10px;
        display: none;
    }
    .preview-chip {
        display: inline-flex;
        align-items: center;
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.2);
        border-radius: 8px;
        padding: 6px 12px;
        color: #fff;
        font-size: 0.85rem;
    }
    .preview-chip img { width: 30px; height: 30px; border-radius: 4px; margin-right: 8px; object-fit: cover; }
    
    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
</style>

<div class="page">
    <%- include(sidebar) %>

    <div class="main-content app-content">
        <div class="container-fluid">

            <div class="d-flex align-items-center justify-content-between my-4">
                <h4 class="mb-0 fw-bold text-white">Task Details</h4>
                <button class="btn btn-dark btn-sm border-secondary text-light" onclick="history.back()">
                    <i class="ri-arrow-left-line"></i> Back
                </button>
            </div>

            <div class="row">
                <div class="col-xl-4 mb-4">
                    <div class="card custom-card h-100 border-0" style="background: #1e293b; color: white;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-1" id="task-title">Loading...</h5>
                                    <div id="status-badge"></div>
                                </div>
                                <button class="btn btn-primary btn-sm" id="btnEditTask" style="display:none;">Edit</button>
                            </div>

                            <div id="acceptance-box" class="p-3 mb-3 rounded border border-warning bg-warning bg-opacity-10 text-warning" style="display:none;">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span><i class="ri-alert-line me-1"></i> Action Required</span>
                                    <button class="btn btn-sm btn-warning text-dark fw-bold" id="btnAccept">Accept</button>
                                </div>
                            </div>

                            <p class="text-secondary mb-4" id="task-desc"></p>

                            <div class="table-responsive">
                                <table class="table table-borderless text-white mb-0">
                                    <tbody>
                                        <tr><td class="text-secondary ps-0">Priority</td><td class="text-end" id="task-priority">-</td></tr>
                                        <tr><td class="text-secondary ps-0">Due Date</td><td class="text-end" id="task-due">-</td></tr>
                                        <tr><td class="text-secondary ps-0">Assigned To</td><td class="text-end" id="task-assignee">-</td></tr>
                                        <tr><td class="text-secondary ps-0">Created By</td><td class="text-end" id="task-creator">-</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-4">
                                <label class="text-secondary fs-12 fw-bold text-uppercase mb-2">Attachments</label>
                                <div id="attachments-container" class="d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-8 mb-4">
                    <div class="chat-card">
                        <div class="chat-header">
                            <h6 class="mb-0 text-white fw-bold">Discussion <span class="badge bg-primary rounded-pill ms-2" id="msg-count">0</span></h6>
                        </div>
                        
                        <div class="chat-body" id="chat-thread">
                            <div class="text-center text-muted mt-5">Loading discussion...</div>
                        </div>

                        <div class="chat-footer">
                            <div class="file-preview-area" id="file-preview"></div>

                            <div class="emoji-picker-modal" id="emoji-picker">
                                <div class="emoji-grid">
                                    <button class="emoji-btn" onclick="addEmoji('üëç')">üëç</button>
                                    <button class="emoji-btn" onclick="addEmoji('üòÇ')">üòÇ</button>
                                    <button class="emoji-btn" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                                    <button class="emoji-btn" onclick="addEmoji('üî•')">üî•</button>
                                    <button class="emoji-btn" onclick="addEmoji('üòÆ')">üòÆ</button>
                                    <button class="emoji-btn" onclick="addEmoji('üò¢')">üò¢</button>
                                    <button class="emoji-btn" onclick="addEmoji('üò°')">üò°</button>
                                    <button class="emoji-btn" onclick="addEmoji('üéâ')">üéâ</button>
                                    <button class="emoji-btn" onclick="addEmoji('‚úÖ')">‚úÖ</button>
                                    <button class="emoji-btn" onclick="addEmoji('üëÄ')">üëÄ</button>
                                    <button class="emoji-btn" onclick="addEmoji('üíØ')">üíØ</button>
                                    <button class="emoji-btn" onclick="addEmoji('üöÄ')">üöÄ</button>
                                </div>
                            </div>

                            <div class="input-container">
                                <div class="input-actions">
                                    <button class="input-btn" onclick="toggleEmoji()" title="Add Emoji"><i class="ri-emotion-line"></i></button>
                                    <button class="input-btn" onclick="triggerFile()" title="Attach File"><i class="ri-attachment-2"></i></button>
                                </div>
                                <textarea id="chat-input" class="chat-input" rows="1" placeholder="Write a comment..." oninput="autoResize(this)"></textarea>
                                <button class="send-btn" id="btnSend" onclick="sendMessage()">
                                    <i class="ri-send-plane-fill"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="file" id="hidden-file" style="display:none" onchange="handleFile(this)">

<%- include('includes/footer2') %>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    const token = localStorage.getItem('token');
    const taskId = window.location.pathname.split('/').pop();
    let currentTask = null;
    let currentUser = null;
    let selectedFile = null;

    document.addEventListener('DOMContentLoaded', async () => {
        if (!token) window.location.href = '/login';
        
        await fetchUser();
        await loadTask();
        await loadMessages();

        // Listeners
        document.getElementById('btnAccept').addEventListener('click', acceptTask);
        
        // Close emoji picker on outside click
        document.addEventListener('click', (e) => {
            const picker = document.getElementById('emoji-picker');
            const btn = document.querySelector('.input-btn[onclick="toggleEmoji()"]');
            if (picker.style.display === 'block' && !picker.contains(e.target) && !btn.contains(e.target)) {
                picker.style.display = 'none';
            }
        });

        // Enter key to send
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
    });

    // --- Data Loading ---
    async function fetchUser() {
        try {
            const res = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
            currentUser = (await res.json()).user;
            if (currentUser.role === 'employer') document.getElementById('btnEditTask').style.display = 'block';
        } catch(e) {}
    }

    async function loadTask() {
        try {
            const res = await fetch(`/api/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            currentTask = data.task;
            renderTask(currentTask);
        } catch(e) {}
    }

    function renderTask(t) {
        document.getElementById('task-title').textContent = t.title;
        document.getElementById('task-desc').innerHTML = t.description ? t.description.replace(/\n/g, '<br>') : 'No description';
        document.getElementById('task-priority').innerHTML = `<span class="badge bg-secondary">${t.priority.toUpperCase()}</span>`;
        
        // FIX: Readable Date Format
        if (t.due_date) {
            const d = new Date(t.due_date);
            document.getElementById('task-due').textContent = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        } else {
            document.getElementById('task-due').textContent = '-';
        }

        document.getElementById('task-assignee').textContent = t.assignee?.full_name || 'Unassigned';
        document.getElementById('task-creator').textContent = t.creator?.full_name || 'Unknown';

        // Acceptance Logic
        const badge = document.getElementById('status-badge');
        const box = document.getElementById('acceptance-box');
        
        if (t.is_accepted) {
            badge.innerHTML = `<span class="badge bg-success"><i class="ri-check-double-line"></i> Accepted</span>`;
            box.style.display = 'none';
        } else {
            badge.innerHTML = `<span class="badge bg-secondary">Pending</span>`;
            // Show accept button only if I am the assignee
            if (currentUser.id === t.assigned_to) {
                box.style.display = 'block';
            }
        }

        // Attachments
        const attDiv = document.getElementById('attachments-container');
        if (t.attachments?.length) {
            attDiv.innerHTML = t.attachments.map(a => `
                <a href="${a.url}" target="_blank" class="btn btn-sm btn-dark border border-secondary">
                    <i class="ri-attachment-2"></i> ${a.file_name}
                </a>
            `).join('');
        } else {
            attDiv.innerHTML = '<span class="text-muted fs-12">No files</span>';
        }
    }

    async function acceptTask() {
        const btn = document.getElementById('btnAccept');
        btn.innerHTML = '...'; btn.disabled = true;
        try {
            await fetch(`/api/tasks/${taskId}/accept`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}` } });
            loadTask();
        } catch(e) { btn.innerHTML = 'Accept'; btn.disabled = false; }
    }

    // --- Chat Logic ---
    async function loadMessages() {
        const res = await fetch(`/api/tasks/${taskId}/comments`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        document.getElementById('msg-count').textContent = data.comments.length;
        renderMessages(data.comments);
    }

    function renderMessages(msgs) {
        const container = document.getElementById('chat-thread');
        if (!msgs.length) {
            container.innerHTML = '<div class="text-center text-muted mt-5 opacity-50">No messages yet. Start the conversation!</div>';
            return;
        }

        container.innerHTML = msgs.map(m => {
            const isMe = m.author.id === currentUser.id;
            const avatar = m.author.profile_picture_url || '/build/assets/images/faces/9.jpg';
            
            // Parse Content (Handle Brackets/Images)
            let content = m.content || "";
            let mediaHtml = "";
            
            // Regex to find [Attachment: name](url)
            // Updated regex to handle potentially nested brackets if any slipped through, 
            // but primarily relying on the Sanitizer in sendMessage()
            const regex = /\[(Attachment|Image): (.*?)\]\((.*?)\)/g;
            
            content = content.replace(regex, (match, type, name, url) => {
                const ext = url.split('.').pop().toLowerCase().split('?')[0];
                if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                    mediaHtml += `<img src="${url}" class="comment-image-preview" onclick="window.open('${url}')">`;
                } else {
                    mediaHtml += `<a href="${url}" target="_blank" class="comment-file-link"><i class="ri-file-text-line"></i> ${name}</a>`;
                }
                return ""; // Remove markdown from text
            });

            return `
            <div class="comment-item" style="flex-direction: ${isMe ? 'row-reverse' : 'row'};">
                <img src="${avatar}" class="comment-avatar">
                <div class="comment-content">
                    <div class="comment-header" style="justify-content: ${isMe ? 'flex-end' : 'flex-start'}">
                        <span class="comment-author">${m.author.full_name}</span>
                        <span class="comment-time">${new Date(m.createdAt).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="comment-bubble" style="${isMe ? 'background: #3b82f6; border-color: #3b82f6; border-radius: 12px 0 12px 12px;' : ''}">
                        <div class="comment-text">${content}</div>
                        ${mediaHtml}
                    </div>
                </div>
            </div>`;
        }).join('');
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
    }

    // --- Input Handling ---
    function toggleEmoji() {
        const picker = document.getElementById('emoji-picker');
        picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
    }

    function addEmoji(emoji) {
        const input = document.getElementById('chat-input');
        input.value += emoji;
        input.focus();
    }

    function triggerFile() {
        document.getElementById('hidden-file').click();
    }

    function handleFile(input) {
        if (input.files[0]) {
            selectedFile = input.files[0];
            const area = document.getElementById('file-preview');
            area.style.display = 'block';
            
            let icon = '<i class="ri-file-text-line"></i>';
            if (selectedFile.type.startsWith('image/')) {
                icon = `<img src="${URL.createObjectURL(selectedFile)}">`;
            }

            area.innerHTML = `
                <div class="preview-chip">
                    ${icon} <span>${selectedFile.name}</span>
                    <i class="ri-close-line ms-2 cursor-pointer" onclick="clearFile()"></i>
                </div>
            `;
        }
    }

    function clearFile() {
        selectedFile = null;
        document.getElementById('file-preview').style.display = 'none';
        document.getElementById('hidden-file').value = '';
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        const btn = document.getElementById('btnSend');
        
        if (!text && !selectedFile) return;

        // Loading UI
        const originalIcon = btn.innerHTML;
        btn.innerHTML = `<i class="ri-loader-4-line spin"></i>`;
        btn.disabled = true;

        try {
            let finalContent = text;

            if (selectedFile) {
                const formData = new FormData();
                formData.append('file', selectedFile);
                const upRes = await fetch('/api/tasks/upload', {
                    method: 'POST', 
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                if (upRes.ok) {
                    const data = await upRes.json();
                    // --- CRITICAL FIX: Sanitize filename ---
                    // Remove brackets [] to prevent Markdown parser breakage
                    const safeName = selectedFile.name.replace(/[\[\]]/g, '').trim();
                    finalContent += `\n\n[Attachment: ${safeName}](${data.url})`;
                }
            }

            await fetch(`/api/tasks/${taskId}/comments`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: finalContent })
            });

            // Cleanup
            input.value = '';
            input.style.height = 'auto';
            clearFile();
            loadMessages(); // Refresh UI

        } catch (e) {
            Toastify({ text: "Failed to send", backgroundColor: "#ef4444" }).showToast();
        } finally {
            btn.innerHTML = originalIcon;
            btn.disabled = false;
        }
    }
</script>