<%- include('includes/header2') %>

<style>
.page-hero {
    background: linear-gradient(135deg, #ff9f43 0%, #ffbe76 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
}

.page-hero h1 { font-weight: 700; font-size: 1.75rem; margin-bottom: 0.5rem; }

.data-card {
    background: var(--custom-white);
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.data-card .card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.data-table { width: 100%; }
.data-table th { background: rgba(255, 159, 67, 0.05); font-weight: 600; font-size: 0.85rem; padding: 1rem; }
.data-table td { padding: 0.75rem 1rem; vertical-align: middle; border-bottom: 1px solid rgba(0,0,0,0.03); }
.data-table tbody tr:hover { background: rgba(255, 159, 67, 0.03); }

.status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.status-badge.active, .status-badge.open { background: rgba(0, 176, 116, 0.15); color: #00b074; }
.status-badge.closed { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
.status-badge.draft { background: rgba(108, 117, 125, 0.15); color: #6c757d; }
.status-badge.paused { background: rgba(255, 159, 67, 0.15); color: #ff9f43; }

.job-type-badge { padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }
.job-type-badge.full_time, .job-type-badge.full-time { background: rgba(102, 126, 234, 0.15); color: #667eea; }
.job-type-badge.part_time, .job-type-badge.part-time { background: rgba(118, 75, 162, 0.15); color: #764ba2; }
.job-type-badge.contract { background: rgba(23, 162, 184, 0.15); color: #17a2b8; }
.job-type-badge.remote { background: rgba(0, 176, 116, 0.15); color: #00b074; }

.filters-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }
.filters-row .form-control, .filters-row .form-select { max-width: 180px; }

.pagination-wrapper { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
</style>

<div class="main-content app-content">
    <%- include(sidebar) %>
    <div class="container-fluid">
        
        <div class="page-hero">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="ri-briefcase-line me-2"></i>Job Management</h1>
                    <p class="mb-0 opacity-75">View and manage all job listings</p>
                </div>
                <a href="/dashboard/admin" class="btn btn-light btn-sm"><i class="ri-arrow-left-line me-1"></i> Dashboard</a>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-row">
            <input type="text" class="form-control" id="searchInput" placeholder="Search jobs...">
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="closed">Closed</option>
                <option value="draft">Draft</option>
            </select>
            <select class="form-select" id="typeFilter">
                <option value="">All Types</option>
                <option value="full_time">Full Time</option>
                <option value="part_time">Part Time</option>
                <option value="contract">Contract</option>
                <option value="remote">Remote</option>
            </select>
            <button class="btn btn-warning text-white" onclick="loadJobs()"><i class="ri-filter-line me-1"></i> Filter</button>
        </div>

        <!-- Jobs Table -->
        <div class="data-card">
            <div class="card-header">
                <h6 class="mb-0">All Jobs</h6>
                <span class="text-muted" id="jobCount">Loading...</span>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Job Title</th>
                            <th>Company</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Applications</th>
                            <th>Posted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobsTableBody">
                        <tr><td colspan="8" class="text-center py-4">Loading jobs...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination-wrapper">
                <span class="text-muted" id="paginationInfo">-</span>
                <nav><ul class="pagination pagination-sm mb-0" id="paginationControls"></ul></nav>
            </div>
        </div>
    </div>
</div>

<!-- View Job Modal -->
<div class="modal fade" id="viewJobModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Job Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="jobDetailsBody">Loading...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="updateJobStatus('active')"><i class="ri-check-line me-1"></i> Activate</button>
                <button type="button" class="btn btn-danger" onclick="updateJobStatus('closed')"><i class="ri-close-line me-1"></i> Close</button>
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<%- include('includes/footer2') %>

<script>
let currentPage = 1;
let currentJobId = null;

document.addEventListener('DOMContentLoaded', () => { loadJobs(); });

async function loadJobs(page = 1) {
    currentPage = page;
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
        page, limit: 20,
        search: document.getElementById('searchInput').value,
        status: document.getElementById('statusFilter').value,
        type: document.getElementById('typeFilter').value
    });
    
    try {
        const res = await fetch(`/api/admin/jobs?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        
        if (data.success) {
            renderJobs(data.jobs);
            document.getElementById('jobCount').textContent = `${data.pagination?.total || data.jobs.length} jobs`;
            if (data.pagination) {
                document.getElementById('paginationInfo').textContent = `Page ${data.pagination.page} of ${data.pagination.pages}`;
                renderPagination(data.pagination);
            }
        }
    } catch (e) { console.error(e); }
}

function renderJobs(jobs) {
    const tbody = document.getElementById('jobsTableBody');
    if (!jobs.length) { tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No jobs found</td></tr>'; return; }
    
    tbody.innerHTML = jobs.map(j => `
        <tr>
            <td><div class="fw-medium">${j.title}</div></td>
            <td>${j.Company?.company_name || j.company_name || '-'}</td>
            <td><span class="job-type-badge ${(j.job_type || '').replace(' ', '_')}">${j.job_type || '-'}</span></td>
            <td>${j.location || '-'}</td>
            <td><span class="status-badge ${j.status || 'active'}">${j.status || 'active'}</span></td>
            <td>${j.application_count || 0}</td>
            <td>${new Date(j.createdAt).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary me-1" onclick="viewJob('${j.id}')"><i class="ri-eye-line"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteJob('${j.id}')"><i class="ri-delete-bin-line"></i></button>
            </td>
        </tr>
    `).join('');
}

function renderPagination(p) {
    let html = '';
    if (p.page > 1) html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${p.page-1})">Prev</a></li>`;
    for (let i = 1; i <= Math.min(p.pages, 5); i++) html += `<li class="page-item ${i===p.page?'active':''}"><a class="page-link" href="#" onclick="loadJobs(${i})">${i}</a></li>`;
    if (p.page < p.pages) html += `<li class="page-item"><a class="page-link" href="#" onclick="loadJobs(${p.page+1})">Next</a></li>`;
    document.getElementById('paginationControls').innerHTML = html;
}

async function viewJob(id) {
    currentJobId = id;
    const token = localStorage.getItem('token');
    document.getElementById('jobDetailsBody').innerHTML = '<div class="text-center py-4">Loading...</div>';
    new bootstrap.Modal(document.getElementById('viewJobModal')).show();
    
    try {
        const res = await fetch(`/api/admin/jobs/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        if (data.success) {
            const j = data.job;
            document.getElementById('jobDetailsBody').innerHTML = `
                <h4>${j.title}</h4>
                <p class="text-muted">${j.Company?.company_name || 'Unknown Company'}</p>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Type:</strong> ${j.job_type || '-'}</p>
                        <p><strong>Location:</strong> ${j.location || '-'}</p>
                        <p><strong>Salary:</strong> ${j.salary_min || '-'} - ${j.salary_max || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong> <span class="status-badge ${j.status}">${j.status}</span></p>
                        <p><strong>Applications:</strong> ${j.application_count || 0}</p>
                        <p><strong>Posted:</strong> ${new Date(j.createdAt).toLocaleDateString()}</p>
                    </div>
                </div>
                <hr>
                <h6>Description</h6>
                <div class="bg-light p-3 rounded">${j.description || 'No description'}</div>
            `;
        }
    } catch (e) { console.error(e); }
}

async function updateJobStatus(status) {
    if (!currentJobId) return;
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`/api/admin/jobs/${currentJobId}`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ status })
        });
        if ((await res.json()).success) {
            bootstrap.Modal.getInstance(document.getElementById('viewJobModal')).hide();
            loadJobs(currentPage);
        }
    } catch (e) { console.error(e); }
}

async function deleteJob(id) {
    if (!confirm('Delete this job?')) return;
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`/api/admin/jobs/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if ((await res.json()).success) loadJobs(currentPage);
    } catch (e) { console.error(e); }
}

document.getElementById('searchInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') loadJobs(); });
</script>
