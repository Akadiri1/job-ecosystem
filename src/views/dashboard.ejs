<%- include('includes/header2', { title: 'Dashboard - Job Ecosystem' }) %>

<style>
    /* 1. CRITICAL: Hide everything by default to prevent "flickering" 
       (seeing employer content for a split second before JS runs) */
    .employer-only, .seeker-only, .employee-only, #dashboard-employer, #dashboard-seeker, #dashboard-employee {
        display: none !important;
    }

    /* ============================================
       MODERN DASHBOARD STYLES
       ============================================ */

    /* Stat Cards Enhancement */
    .stat-card-modern {
        background: var(--custom-white);
        border-radius: 16px;
        padding: 1.5rem;
        border: 1px solid rgba(255,255,255,0.08);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, var(--stat-color, #667eea), transparent);
    }
    
    .stat-card-modern:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0,0,0,0.1);
    }
    
    .stat-card-modern .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .stat-card-modern .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 0.25rem;
    }
    
    .stat-card-modern .stat-label {
        color: var(--text-muted);
        font-size: 0.85rem;
    }
    
    /* Color Variants */
    .stat-card-modern.primary { --stat-color: #667eea; }
    .stat-card-modern.secondary { --stat-color: #764ba2; }
    .stat-card-modern.success { --stat-color: #00b074; }
    .stat-card-modern.warning { --stat-color: #ff9f43; }
    
    /* Table Enhancement */
    .modern-table {
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.08);
        background: var(--custom-white);
    }
    
    .modern-table .table {
        margin-bottom: 0;
        background: transparent;
    }
    
    .modern-table thead {
        background: rgba(102, 126, 234, 0.15);
    }
    
    .modern-table thead th {
        border: none;
        padding: 1rem;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #667eea;
        background: transparent;
    }
    
    .modern-table tbody tr {
        transition: all 0.2s ease;
        background: transparent;
    }
    
    .modern-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.08);
    }
    
    .modern-table tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-color: rgba(255,255,255,0.05);
        background: transparent;
    }
    
    /* Card Enhancement */
    .card.custom-card {
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.08);
        overflow: hidden;
        transition: all 0.3s ease;
        background: var(--custom-white);
    }
    
    .card.custom-card:hover {
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background: transparent;
        border-bottom: 1px solid rgba(255,255,255,0.05);
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 1rem 1.25rem;
    }
    
    .card-title {
        font-weight: 600;
        font-size: 1rem;
    }
    
    /* Welcome Header */
    .welcome-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        color: #fff;
        position: relative;
        overflow: hidden;
    }
    
    .welcome-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }
    
    .welcome-header h2 {
        font-weight: 700;
        margin-bottom: 0.25rem;
        position: relative;
        z-index: 1;
    }
    
    .welcome-header p {
        color: rgba(255,255,255,0.8);
        margin-bottom: 0;
        position: relative;
        z-index: 1;
    }
    
    /* Quick Action Cards */
    .quick-action-card {
        background: var(--custom-white);
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.2s ease;
        cursor: pointer;
        text-decoration: none;
        display: block;
    }
    
    .quick-action-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
        border-color: #667eea;
    }
    
    .quick-action-card i {
        font-size: 1.5rem;
        color: #667eea;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .quick-action-card span {
        font-size: 0.85rem;
        color: var(--default-text-color);
    }
    
    /* Badge Improvements */
    .status-badge {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    /* Animation for numbers */
    @keyframes countUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .stat-value-animated {
        animation: countUp 0.5s ease forwards;
    }
    
    /* List Group for Pipeline */
    .list-group-flush {
        background: transparent;
    }
    
    .list-group-flush .list-group-item {
        background: transparent;
        border-color: rgba(255,255,255,0.05);
        padding: 1rem;
    }
    
    .list-group-flush .list-group-item:hover {
        background: rgba(102, 126, 234, 0.05);
    }
    
    /* Card Body Background */
    .card-body {
        background: transparent;
    }
</style>

<div class="page">
    <%- include(sidebar) %>

    <div class="main-content app-content">
        <div class="container-fluid">

            <!-- Modern Welcome Header -->
            <div class="welcome-header mt-3">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div>
                        <h2 class="mb-1">
                            Welcome back, <span id="welcome-name"><span class="skeleton-box" style="width:100px;height:24px;display:inline-block;"></span></span>!
                        </h2>
                        <p id="welcome-subtitle">Here's what's happening in your company.</p>
                    </div>
                    <div id="header-action-employer" class="employer-only">
                        <a href="/jobs/create" class="btn btn-light btn-lg px-4"> 
                            <i class="ri-add-line me-2"></i>Post a Job 
                        </a>
                    </div>
                </div>
            </div>

            <div id="dashboard-employer">
                <!-- Modern Stat Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                        <div class="stat-card-modern primary">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="stat-label">Active Jobs</div>
                                    <div class="stat-value" id="stats-active-jobs"><span class="skeleton-box" style="width:40px;height:32px;"></span></div>
                                </div>
                                <div class="stat-icon bg-primary-transparent text-primary">
                                    <i class="ri-briefcase-4-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                        <div class="stat-card-modern secondary">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="stat-label">Total Applicants</div>
                                    <div class="stat-value" id="stats-total-applicants"><span class="skeleton-box" style="width:40px;height:32px;"></span></div>
                                </div>
                                <div class="stat-icon bg-secondary-transparent text-secondary">
                                    <i class="ri-group-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                        <div class="stat-card-modern success">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="stat-label">Shortlisted</div>
                                    <div class="stat-value" id="stats-shortlisted"><span class="skeleton-box" style="width:40px;height:32px;"></span></div>
                                </div>
                                <div class="stat-icon bg-success-transparent text-success">
                                    <i class="ri-check-double-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                        <div class="stat-card-modern warning">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <div class="stat-label">Pending Review</div>
                                    <div class="stat-value" id="stats-pending"><span class="skeleton-box" style="width:40px;height:32px;"></span></div>
                                </div>
                                <div class="stat-icon bg-warning-transparent text-warning">
                                    <i class="ri-time-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-xl-8">
                        <div class="card custom-card">
                            <div class="card-header justify-content-between">
                                <div class="card-title"><i class="ri-file-list-3-line me-2 text-primary"></i>Recent Applications</div>
                                <a href="/dashboard/employer/jobs/manage" class="btn btn-sm btn-primary-light">View All Jobs</a>
                            </div>
                            <div class="card-body p-0">
                                <div class="modern-table">
                                    <table class="table text-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th scope="col">Candidate</th>
                                                <th scope="col">Job Applied For</th>
                                                <th scope="col">Applied Date</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-apps-tbody">
                                             <!-- Skeleton Loader -->
                                             <tr id="recent-apps-skeleton">
                                                <td><div class="d-flex align-items-center"><div class="skeleton-box skeleton-avatar me-2"></div><div><div class="skeleton-box skeleton-text" style="width: 100px;"></div><div class="skeleton-box skeleton-text" style="width: 60px;"></div></div></div></td>
                                                <td><div class="skeleton-box skeleton-text" style="width: 120px;"></div></td>
                                                <td><div class="skeleton-box skeleton-text" style="width: 80px;"></div></td>
                                                <td><div class="skeleton-box skeleton-btn"></div></td>
                                                <td><div class="skeleton-box skeleton-btn" style="width: 30px;"></div></td>
                                             </tr>
                                             <tr id="recent-apps-skeleton-2">
                                                <td><div class="d-flex align-items-center"><div class="skeleton-box skeleton-avatar me-2"></div><div><div class="skeleton-box skeleton-text" style="width: 100px;"></div><div class="skeleton-box skeleton-text" style="width: 60px;"></div></div></div></td>
                                                <td><div class="skeleton-box skeleton-text" style="width: 120px;"></div></td>
                                                <td><div class="skeleton-box skeleton-text" style="width: 80px;"></div></td>
                                                <td><div class="skeleton-box skeleton-btn"></div></td>
                                                <td><div class="skeleton-box skeleton-btn" style="width: 30px;"></div></td>
                                             </tr>
                                        </tbody>
                                        <!-- Empty state template (hidden) -->
                                        <tfoot id="recent-apps-empty" style="display:none;">
                                            <tr>
                                                 <td colspan="5" class="text-center p-5">
                                                    <span class="avatar avatar-lg bg-light mb-2"><i class="ri-inbox-line fs-24"></i></span>
                                                    <p class="text-muted mb-0">No applications received yet.</p>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- New Side Widget: Pipeline Summary -->
                    <div class="col-xl-4">
                        <div class="card custom-card">
                            <div class="card-header">
                                <div class="card-title">Hiring Pipeline</div>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush" id="pipeline-list">
                                    <!-- Populated by JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboard-seeker">
                <div class="row">
                    <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 text-muted fs-12 fw-medium">Applications Sent</p>
                                        <h4 class="mb-0 fw-semibold" id="stats-applications-sent"><span class="skeleton-box skeleton-text" style="width: 30px; height: 24px; margin-bottom:0;"></span></h4>
                                    </div>
                                    <span class="avatar avatar-md bg-info-transparent"><i class="ri-send-plane-fill fs-20"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 text-muted fs-12 fw-medium">Interviews Scheduled</p>
                                        <h4 class="mb-0 fw-semibold" id="stats-interviews-scheduled"><span class="skeleton-box skeleton-text" style="width: 30px; height: 24px; margin-bottom:0;"></span></h4>
                                    </div>
                                    <span class="avatar avatar-md bg-purple-transparent"><i class="ri-calendar-check-line fs-20"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                        <div class="card custom-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 text-muted fs-12 fw-medium">Saved Jobs</p>
                                        <h4 class="mb-0 fw-semibold" id="stats-saved-jobs"><span class="skeleton-box skeleton-text" style="width: 30px; height: 24px; margin-bottom:0;"></span></h4>
                                    </div>
                                    <span class="avatar avatar-md bg-danger-transparent"><i class="ri-heart-line fs-20"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Applications Table -->
                <div class="row mb-4">
                    <div class="col-xl-12">
                        <div class="card custom-card">
                            <div class="card-header justify-content-between">
                                <div class="card-title">Recent Applications</div>
                                <a href="/my-applications" class="btn btn-sm btn-light">View All</a>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table text-nowrap table-hover" id="seeker-recent-apps-table">
                                        <thead>
                                            <tr>
                                                <th>Job Title</th>
                                                <th>Company</th>
                                                <th>Applied On</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="seeker-recent-apps-body">
                                            <!-- JS will populate -->
                                            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recommended Jobs -->
                <div class="row">
                    <div class="col-xl-12">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                             <h5 class="fw-semibold mb-0">Recommended Jobs</h5>
                             <a href="/jobs/feed" class="btn btn-sm btn-light">Browse All</a>
                        </div>
                    </div>
                    <!-- Container for cards -->
                    <div class="col-xl-12">
                        <div class="row" id="recommended-jobs-container">
                             <!-- Skeleton Cards -->
                             <div class="col-xl-4 col-md-6 mb-4 skeleton-job-card">
                                 <div class="card custom-card">
                                     <div class="card-body">
                                         <div class="d-flex mb-3">
                                             <div class="skeleton-box skeleton-avatar me-3"></div>
                                             <div class="flex-grow-1">
                                                 <div class="skeleton-box skeleton-text" style="width: 70%;"></div>
                                                 <div class="skeleton-box skeleton-text" style="width: 40%;"></div>
                                             </div>
                                         </div>
                                         <div class="skeleton-box skeleton-text" style="width: 100%; height: 60px;"></div>
                                         <div class="d-flex justify-content-between mt-3">
                                             <div class="skeleton-box skeleton-btn"></div>
                                             <div class="skeleton-box skeleton-btn"></div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <div class="col-xl-4 col-md-6 mb-4 skeleton-job-card">
                                 <div class="card custom-card">
                                     <div class="card-body">
                                         <div class="d-flex mb-3">
                                             <div class="skeleton-box skeleton-avatar me-3"></div>
                                             <div class="flex-grow-1">
                                                 <div class="skeleton-box skeleton-text" style="width: 70%;"></div>
                                                 <div class="skeleton-box skeleton-text" style="width: 40%;"></div>
                                             </div>
                                         </div>
                                         <div class="skeleton-box skeleton-text" style="width: 100%; height: 60px;"></div>
                                         <div class="d-flex justify-content-between mt-3">
                                             <div class="skeleton-box skeleton-btn"></div>
                                             <div class="skeleton-box skeleton-btn"></div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

            </div>

            <!-- EMPLOYEE DASHBOARD (New Design) -->
            <div id="dashboard-employee" style="display: none;">
                <!-- 1. Welcome Banner -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card custom-card text-white overflow-hidden border-0" style="background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%);">
                            <div class="card-body p-4 position-relative">
                                <div class="d-flex align-items-center justify-content-between position-relative z-1">
                                    <div>
                                        <h4 class="fw-bold mb-1">Company Workspace</h4>
                                        <p class="mb-0 opacity-75">Welcome to your team hub. Track tasks and stay synchronized.</p>
                                    </div>
                                    <div class="d-none d-md-block">
                                        <div class="p-3 rounded-circle bg-white bg-opacity-10 d-flex align-items-center justify-content-center backdrop-blur-sm">
                                            <i class="ri-building-4-fill fs-24"></i>
                                        </div>
                                    </div>
                                </div>
                                <!-- Decorative Shapes (Subtle) -->
                                <div class="position-absolute top-0 end-0 p-5 mt-n4 me-n4 bg-white opacity-05 rounded-circle" style="opacity: 0.05;"></div>
                                <div class="position-absolute bottom-0 start-0 p-5 mb-n5 ms-n5 bg-white opacity-05 rounded-circle" style="opacity: 0.05;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Quick Stats Row -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                        <div class="card custom-card border-top-card border-top-primary rounded-3 shadow-none bg-light">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 fw-medium text-muted fs-12">Assigned Tasks</p>
                                        <h4 class="mb-0 fw-bold" id="stats-employee-tasks-count">--</h4>
                                    </div>
                                    <div class="avatar avatar-sm bg-primary-transparent">
                                        <i class="ri-task-line"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                         <div class="card custom-card border-top-card border-top-warning rounded-3 shadow-none bg-light">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 fw-medium text-muted fs-12">Pending Reviews</p>
                                        <h4 class="mb-0 fw-bold" id="stats-employee-pending-count">--</h4>
                                    </div>
                                    <div class="avatar avatar-sm bg-warning-transparent">
                                        <i class="ri-time-line"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                         <div class="card custom-card border-top-card border-top-success rounded-3 shadow-none bg-light">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 fw-medium text-muted fs-12">Completed</p>
                                        <h4 class="mb-0 fw-bold" id="stats-employee-completed-count">--</h4>
                                    </div>
                                    <div class="avatar avatar-sm bg-success-transparent">
                                        <i class="ri-checkbox-circle-line"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                         <div class="card custom-card border-top-card border-top-info rounded-3 shadow-none bg-light">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <p class="mb-1 fw-medium text-muted fs-12">Team Members</p>
                                        <h4 class="mb-0 fw-bold" id="stats-employee-team-count">--</h4>
                                    </div>
                                    <div class="avatar avatar-sm bg-info-transparent">
                                        <i class="ri-team-line"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- 3. My Tasks (Enhanced) -->
                    <div class="col-xl-8">
                        <div class="card custom-card">
                            <div class="card-header border-bottom-0 pb-0 justify-content-between">
                                <div class="card-title fs-15 fw-bold">My Tasks</div>
                                <div class="dropdown">
                                    <a href="javascript:void(0);" class="btn btn-sm btn-light-ghost text-muted" data-bs-toggle="dropdown">
                                        Sort By <i class="ri-arrow-down-s-line align-middle ms-1"></i>
                                    </a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a class="dropdown-item" href="javascript:void(0);">Date</a></li>
                                        <li><a class="dropdown-item" href="javascript:void(0);">Priority</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body pt-3">
                                <ul class="list-group list-group-flush border-0" id="employee-tasks-list">
                                    <!-- Populated by JS -->
                                    <li class="list-group-item text-center text-muted py-5 border-0">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading tasks...</span>
                                    </li>
                                </ul>
                                <div class="d-grid mt-2">
                                    <button class="btn btn-light btn-sm text-muted">View all tasks</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Activity Feed (Enhanced) -->
                    <div class="col-xl-4">
                        <div class="card custom-card">
                            <div class="card-header border-bottom-0 pb-0">
                                <div class="card-title fs-15 fw-bold">Recent Activity</div>
                            </div>
                            <div class="card-body pt-2">
                                <ul class="list-unstyled mb-0 activity-feed" id="employee-activity-list">
                                    <!-- Populated by JS -->
                                     <li class="text-center text-muted py-5">
                                        <small>No recent activity</small>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. Function to handle Logout
    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
    }

    // 2. Main Dashboard Initialization
    async function initDashboard() {
        // A. Check for Token
        const urlParams = new URLSearchParams(window.location.search);
        const tokenParam = urlParams.get('token');
        const userParam = urlParams.get('user');

        let token = localStorage.getItem('token');

        if (tokenParam && userParam) {
            token = tokenParam;
            localStorage.setItem('token', tokenParam);
            // decodeURIComponent isn't strictly necessary if it's already decoded by browser but good practice
            // Ideally backend sends it encoded, URLSearchParams decodes it automatically. 
            // We just need to ensure it's a valid string.
            localStorage.setItem('user', userParam);
            
            // Clean URL to remove sensitive token
            window.history.replaceState({}, document.title, "/dashboard");
        }

        try { // B. Fetch Current User Data
            // We use the 'getMe' endpoint we created in authController
            const response = await fetch('/api/auth/me', {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`, 
                    'Content-Type': 'application/json'
                }
            });

            // C. Handle Token Expiry / Invalid Token
            if (response.status === 401 || response.status === 403) {
                const errData = await response.json();
                
                // If Deactivated/Suspended
                if (errData.error && errData.error.includes("deactivated")) {
                    document.body.innerHTML = `
                        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; text-align: center; padding: 20px;">
                            <h1 style="color: #ff5b5c; font-size: 2rem; margin-bottom: 10px;">Access Revoked</h1>
                            <p style="color: #6c757d; font-size: 1.2rem; max-width: 500px;">${errData.error}</p>
                            <button onclick="localStorage.clear(); window.location.href='/login'" style="margin-top: 20px; padding: 10px 20px; background: #7b1fa2; color: white; border: none; border-radius: 5px; cursor: pointer;">Go to Login</button>
                        </div>
                    `;
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    return;
                }

                logout();
                return;
            }

            const responseText = await response.text();
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error("Failed to parse Dashboard Stats:", responseText);
                Toastify({ 
                    text: "Server Error: " + responseText.substring(0, 50).replace(/<[^>]*>?/gm, '') + "...", 
                    duration: 5000, 
                    backgroundColor: "#ff5b5c" 
                }).showToast();
                return; 
            }

            if (response.ok) {
                const user = data.user || data;
            
            // --- NEW: ROLE-BASED REDIRECTS ---
            const currentPath = window.location.pathname;
            const role = (user.role || '').toLowerCase();

            // 1. Redirect from generic Gateway to specific Dashboard
            if (currentPath === '/dashboard') {
                if (role === 'employer') {
                    window.location.replace('/dashboard/employer');
                    return;
                } else if (role === 'employee') {
                    window.location.replace('/dashboard/employee');
                    return;
                } else {
                    window.location.replace('/dashboard/seeker');
                    return;
                }
            }

            // 2. Cross-Role Protection (Prevent Seeker from viewing Employer Dashboard)
            if (currentPath.includes('/employer') && role !== 'employer') {
                window.location.replace('/dashboard/seeker'); // Fallback
                return;
            }
            if (currentPath.includes('/employee') && role !== 'employee') {
                 window.location.replace('/dashboard/seeker');
                 return;
            }
            // ----------------------------------
                
                // D. Update Text: Name & Role
                const welcomeName = document.getElementById('welcome-name');
                if(welcomeName) welcomeName.innerText = user.full_name || user.email;
                
                const roleBadge = document.getElementById('user-role-badge');
                if(roleBadge) {
                    roleBadge.innerText = user.role.toUpperCase();
                    roleBadge.style.display = 'inline-block';
                    // Color coding
                    if(user.role === 'employer') roleBadge.className = 'badge bg-primary-transparent ms-2 fs-12 align-middle';
                    if(user.role === 'employee') roleBadge.className = 'badge bg-secondary-transparent ms-2 fs-12 align-middle';
                    if(user.role === 'job_seeker') roleBadge.className = 'badge bg-info-transparent ms-2 fs-12 align-middle';
                }

                // E. ROLE-BASED TOGGLING
                // We use .style.setProperty('display', 'block', 'important') to override CSS !important
                
                // Sync latest user data to localStorage (fixes Sidebar mismatch if any)
                const cachedUser = JSON.parse(localStorage.getItem('user') || 'null');
                localStorage.setItem('user', JSON.stringify(user));

                if (user.role === 'employer') {
                    // --- EMPLOYER VIEW ---
                    const subtitle = document.getElementById('welcome-subtitle');
                    if(subtitle) subtitle.innerText = "Here's what's happening in your company.";
                    
                    // Show Main Dashboard
                    document.getElementById('dashboard-employer').style.setProperty('display', 'block', 'important');
                    document.getElementById('dashboard-seeker').style.setProperty('display', 'none', 'important');
                    
                    // Show Header Buttons
                    const headerAction = document.getElementById('header-action-employer');
                    if(headerAction) headerAction.style.setProperty('display', 'flex', 'important');

                    // Show Sidebar Links
                    document.querySelectorAll('.employer-only').forEach(el => {
                        el.style.setProperty('display', 'block', 'important');
                    });
                    document.querySelectorAll('.seeker-only').forEach(el => {
                        el.style.setProperty('display', 'none', 'important');
                    });

                } else if (user.role === 'employee') {
                    // --- EMPLOYEE VIEW ---
                    const subtitle = document.getElementById('welcome-subtitle');
                    if(subtitle) subtitle.innerText = "Welcome to your company workspace.";
                    
                    document.getElementById('dashboard-employee').style.setProperty('display', 'block', 'important');
                    document.getElementById('dashboard-employer').style.setProperty('display', 'none', 'important');
                    document.getElementById('dashboard-seeker').style.setProperty('display', 'none', 'important');

                    // Hide Employer Header Buttons
                    const headerAction = document.getElementById('header-action-employer');
                    if(headerAction) headerAction.style.setProperty('display', 'none', 'important');

                    // Show Sidebar Links (Use user logic or shared class if we add one)
                    // For now, employees see 'seeker-only' set to NONE, 'employer-only' set to NONE?
                    // Or we need a specific 'employee-only' class in sidebar.
                    // Ideally sidebar handles itself, but we can enforce:
                    document.querySelectorAll('.employer-only').forEach(el => el.style.setProperty('display', 'none', 'important'));
                    document.querySelectorAll('.seeker-only').forEach(el => el.style.setProperty('display', 'none', 'important'));
                    
                } else {
                    // --- JOB SEEKER VIEW ---
                    const subtitle = document.getElementById('welcome-subtitle');
                    if(subtitle) subtitle.innerText = "Here are the latest opportunities for you.";
                    
                    // Show Main Dashboard
                    document.getElementById('dashboard-seeker').style.setProperty('display', 'block', 'important');
                    document.getElementById('dashboard-employer').style.setProperty('display', 'none', 'important');
                    document.getElementById('dashboard-employee').style.setProperty('display', 'none', 'important');

                    // Hide Employer Header Buttons
                    const headerAction = document.getElementById('header-action-employer');
                    if(headerAction) headerAction.style.setProperty('display', 'none', 'important');

                    // Show Sidebar Links
                    document.querySelectorAll('.seeker-only').forEach(el => {
                        el.style.setProperty('display', 'block', 'important');
                    });
                    document.querySelectorAll('.employer-only').forEach(el => {
                        el.style.setProperty('display', 'none', 'important');
                    });
                     document.querySelectorAll('.employee-only').forEach(el => {
                        el.style.setProperty('display', 'none', 'important');
                    });
                }
                
                // --- ROLE CHANGE DETECTION (UX Improvement) ---
                if (cachedUser && cachedUser.role !== user.role) {
                    // Downgrade Detection
                    if ((cachedUser.role === 'employee' || cachedUser.role === 'employer') && user.role === 'job_seeker') {
                         Toastify({
                            text: "‚ö†Ô∏è Access Revoked: You have been removed from the team workspace.",
                            duration: 5000,
                            close: true,
                            gravity: "top", 
                            position: "center", 
                            backgroundColor: "#ff5b5c",
                        }).showToast();
                    }
                    // Upgrade Detection (Nice to have)
                    if (cachedUser.role === 'job_seeker' && user.role === 'employee') {
                         Toastify({
                            text: "üéâ Welcome to the Team! You now have employee access.",
                            duration: 5000,
                            backgroundColor: "#00e676",
                            position: "center",
                        }).showToast();
                    }
                }

                // F. FETCH DASHBOARD STATS
                let stats = null;
                try {
                    console.log("Fetching dashboard stats...");
                    const statsResponse = await fetch('/api/jobs/dashboard/stats', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    // ERROR HANDLING
                    if (!statsResponse.ok) {
                        const responseText = await statsResponse.text();
                        let errData;
                        try {
                            errData = JSON.parse(responseText);
                        } catch (e) {
                            // HTML Error (Backend Crash)
                             Toastify({ 
                                text: "Server Error: " + responseText.substring(0, 50).replace(/<[^>]*>?/gm, '') + "...", 
                                duration: 5000, 
                                backgroundColor: "#ff5b5c" 
                            }).showToast();
                            console.error("Dashboard Stats Crash:", responseText);
                            return; // Stop execution
                        }

                        // Deactivation Check
                        if (statsResponse.status === 403 && errData.error && errData.error.includes("deactivated")) {
                             document.body.innerHTML = `
                                <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8f9fa; text-align: center; padding: 20px;">
                                    <h1 style="color: #ff5b5c; font-size: 2rem; margin-bottom: 10px;">Access Revoked</h1>
                                    <p style="color: #6c757d; font-size: 1.2rem; max-width: 500px;">${errData.error}</p>
                                    <button onclick="localStorage.clear(); window.location.href='/login'" style="margin-top: 20px; padding: 10px 20px; background: #7b1fa2; color: white; border: none; border-radius: 5px; cursor: pointer;">Go to Login</button>
                                </div>
                            `;
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            return;
                        }

                        Toastify({ text: "Error: " + (errData.error || statsResponse.statusText), duration: 3000, backgroundColor: "#ff5b5c" }).showToast();
                        return; // Stop execution
                    }
                    
                    // SUCCESS: Parse JSON
                    stats = await statsResponse.json();
                    
                } catch (fetchErr) {
                     console.error("Failed to load stats:", fetchErr);
                     Toastify({
                        text: "Network error loading stats. Please check console.",
                        duration: 5000,
                        backgroundColor: "#ff5b5c",
                    }).showToast();
                    return;
                }

                // G. RENDER DASHBOARD STATS (Only if stats loaded)
                if (stats) {
                    console.log("Stats received:", stats);
                    
                    if (user.role === 'employer') {
                            // 1. Active Jobs
                            const activeJobsEl = document.getElementById('stats-active-jobs');
                            if(activeJobsEl) {
                                let val = stats.activeJobs;
                                if (val === undefined || val === null) val = 0;
                                activeJobsEl.innerText = val;
                            }

                            // 2. Total Applicants
                            const applicantsEl = document.getElementById('stats-total-applicants');
                            if(applicantsEl) {
                                let val = stats.totalApplicants;
                                if (val === undefined || val === null) val = 0;
                                applicantsEl.innerText = val;
                            }
                            
                            // 3. Shortlisted (Pipeline)
                            const shortlistedEl = document.getElementById('stats-shortlisted');
                            if(shortlistedEl) {
                                const count = (stats.pipeline && stats.pipeline.shortlisted) ? stats.pipeline.shortlisted : 0;
                                shortlistedEl.innerText = count;
                            }

                            // 4. Pending (Pipeline)
                            const pendingEl = document.getElementById('stats-pending');
                            if(pendingEl) {
                                const count = (stats.pipeline && stats.pipeline.pending) ? stats.pipeline.pending : 0;
                                pendingEl.innerText = count;
                            }

                            // 5. Render Recent Applications
                            try {
                                const recentTbody = document.getElementById('recent-apps-tbody');
                                const emptyState = document.getElementById('recent-apps-empty');
                                
                                if(recentTbody) {
                                    recentTbody.innerHTML = ''; // Clear loading state
                                    
                                    if (stats.recentApplications && stats.recentApplications.length > 0) {
                                        // Hide empty state
                                        if(emptyState) emptyState.style.display = 'none';

                                        stats.recentApplications.forEach(app => {
                                            const date = new Date(app.createdAt).toLocaleDateString();
                                            let statusBadge = `<span class="badge bg-light text-dark order-status">${app.status}</span>`;
                                            if(app.status === 'shortlisted') statusBadge = `<span class="badge bg-success-transparent">Shortlisted</span>`;
                                            if(app.status === 'rejected') statusBadge = `<span class="badge bg-danger-transparent">Rejected</span>`;
                                            if(app.status === 'pending') statusBadge = `<span class="badge bg-warning-transparent">Pending</span>`;
                                            if(app.status === 'hired') statusBadge = `<span class="badge bg-info-transparent">Hired</span>`;

                                            // Safety check for seeker object
                                            const seekerName = app.seeker && app.seeker.full_name ? app.seeker.full_name : 'Unknown';
                                            const seekerInitial = seekerName.charAt(0).toUpperCase();
                                            const seekerEmail = app.seeker && app.seeker.email ? app.seeker.email : '';
                                            const jobTitle = app.job && app.job.title ? app.job.title : 'Unknown Job';

                                            const row = `
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <span class="avatar avatar-sm fs-12 bg-primary-transparent me-2">
                                                            ${seekerInitial}
                                                        </span>
                                                        <div>
                                                            <span class="fw-medium d-block">${seekerName}</span>
                                                            <span class="fs-11 text-muted">${seekerEmail}</span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>${jobTitle}</td>
                                                <td>${date}</td>
                                                <td>${statusBadge}</td>
                                                <td>
                                                    <a href="/candidates" class="btn btn-icon btn-sm btn-light"><i class="ri-eye-line"></i></a>
                                                </td>
                                            </tr>
                                            `;
                                            recentTbody.innerHTML += row;
                                        });
                                    } else {
                                        if(emptyState) emptyState.style.display = 'table-footer-group'; // Show TFOOT
                                    }
                                }
                            } catch (tableErr) {
                                console.error("Error rendering table:", tableErr);
                            }

                            // 6. Render Pipeline List (Side Widget)
                            try {
                                const pipelineList = document.getElementById('pipeline-list');
                                if (pipelineList && stats.pipeline) {
                                    const p = stats.pipeline;
                                    const total = stats.totalApplicants || 1; // avoid div by zero
                                    
                                    const items = [
                                        { label: 'Pending Review', count: p.pending, color: 'warning', icon: 'ri-time-line' },
                                        { label: 'Shortlisted', count: p.shortlisted, color: 'success', icon: 'ri-check-double-line' },
                                        { label: 'Rejected', count: p.rejected, color: 'danger', icon: 'ri-close-circle-line' },
                                        { label: 'Hired', count: p.hired, color: 'info', icon: 'ri-shake-hands-line' }
                                    ];

                                    pipelineList.innerHTML = items.map(item => `
                                        <li class="list-group-item">
                                            <div class="d-flex align-items-center justify-content-between mb-1">
                                                <div class="d-flex align-items-center">
                                                    <span class="avatar avatar-sm bg-${item.color}-transparent me-2"><i class="${item.icon}"></i></span>
                                                    <span class="text-muted">${item.label}</span>
                                                </div>
                                                <span class="fw-semibold">${item.count || 0}</span>
                                            </div>
                                            <div class="progress progress-xs">
                                                <div class="progress-bar bg-${item.color}" role="progressbar" style="width: ${((item.count || 0) / total) * 100}%"></div>
                                            </div>
                                        </li>
                                    `).join('');
                                }
                            } catch (pipelineErr) {
                                console.error("Error rendering pipeline list:", pipelineErr);
                            }

                    } else if (user.role === 'employee') {
// EMPLOYEE DASHBOARD RENDER
                        
                        // 1. Stats Calculation (Mock logic if fields missing)
                        const taskCount = (stats.tasks && stats.tasks.length) || 0;
                        const pendingCount = (stats.tasks && stats.tasks.filter(t => t.status !== 'completed').length) || 0;
                        const completedCount = (stats.tasks && stats.tasks.filter(t => t.status === 'completed').length) || 0;
                        
                        // Update Quick Stats
                        const elTasks = document.getElementById('stats-employee-tasks-count');
                        if(elTasks) elTasks.innerText = taskCount;
                        
                        const elPending = document.getElementById('stats-employee-pending-count');
                        if(elPending) elPending.innerText = pendingCount;
                        
                        const elCompleted = document.getElementById('stats-employee-completed-count');
                        if(elCompleted) elCompleted.innerText = completedCount;
                        
                        // Mock Team Count (random for demo feel, or fetch real)
                        const elTeam = document.getElementById('stats-employee-team-count');
                        if(elTeam) elTeam.innerText = stats.teamCount || 12;

                        // 2. Render Tasks List
                        const tasksList = document.getElementById('employee-tasks-list');
                        if (tasksList) {
                            if (stats.tasks && stats.tasks.length > 0) {
                                tasksList.innerHTML = stats.tasks.map(task => {
                                    let badgeColor = 'warning';
                                    let icon = 'ri-time-line';
                                    if(task.status === 'completed') { badgeColor = 'success'; icon = 'ri-checkbox-circle-line'; }
                                    if(task.status === 'in_progress') { badgeColor = 'info'; icon = 'ri-loader-4-line'; }

                                    return `
                                    <li class="list-group-item d-flex justify-content-between align-items-center border-0 px-0 py-3 border-bottom-dashed">
                                        <div class="d-flex align-items-start">
                                            <span class="avatar avatar-sm bg-${badgeColor}-transparent rounded-circle me-3 mt-1">
                                                <i class="${icon}"></i>
                                            </span>
                                            <div>
                                                <span class="fw-semibold d-block text-dark">${task.title}</span>
                                                <span class="d-block fs-12 text-muted mt-1"><i class="ri-calendar-event-line me-1"></i> Due: ${task.due}</span>
                                            </div>
                                        </div>
                                        <span class="badge bg-${badgeColor}-transparent rounded-pill px-3 py-2 text-uppercase fs-11">${task.status.replace('_', ' ')}</span>
                                    </li>
                                    `;
                                }).join('');
                            } else {
                                tasksList.innerHTML = `
                                    <div class="text-center py-5">
                                        <div class="avatar avatar-lg bg-light mb-3 rounded-circle"><i class="ri-checkbox-multiple-blank-line fs-24 text-muted"></i></div>
                                        <p class="text-muted fw-medium">You're all caught up!</p>
                                        <button class="btn btn-sm btn-primary-light mt-2">Create Task</button>
                                    </div>
                                `;
                            }
                        }

                        // 3. Render Activity
                        const activityList = document.getElementById('employee-activity-list');
                        if (activityList && stats.activity) {
                            activityList.innerHTML = stats.activity.map((act, index) => `
                                <li class="d-flex gap-3 mb-4">
                                    <div class="d-flex flex-column align-items-center">
                                        <span class="avatar avatar-xs bg-light rounded-circle border border-2 border-white shadow-sm ring-2 ring-light">
                                            <span class="bg-${['primary','secondary','success','warning'][index % 4]} rounded-circle w-100 h-100"></span>
                                        </span>
                                        ${index !== stats.activity.length - 1 ? '<div class="vr h-100 bg-light mt-2" style="width: 2px;"></div>' : ''}
                                    </div>
                                    <div>
                                        <p class="mb-1 text-dark fw-medium fs-13">${act.text}</p>
                                        <span class="fs-11 text-muted"><i class="ri-time-line me-1"></i>${act.time}</span>
                                    </div>
                                </li>
                            `).join('');
                            activityList.innerHTML += `<li class="text-center mt-3"><a href="#" class="text-primary fs-12 fw-medium text-decoration-none">View All Activity <i class="ri-arrow-right-line ms-1"></i></a></li>`;
                        }

                    } else {
                        // SEEKER DASHBOARD RENDER
                        document.getElementById('stats-applications-sent').innerText = stats.applicationsSent || 0;
                        document.getElementById('stats-interviews-scheduled').innerText = stats.interviewsScheduled || 0;
                        document.getElementById('stats-saved-jobs').innerText = stats.savedJobs || 0;

                        // Render Recent Apps
                        const appsBody = document.getElementById('seeker-recent-apps-body');
                        if (stats.recentApplications && stats.recentApplications.length > 0) {
                            appsBody.innerHTML = stats.recentApplications.map(app => {
                                let statusBadge = '<span class="badge bg-warning-transparent">Pending</span>';
                                if(app.status === 'shortlisted') statusBadge = '<span class="badge bg-primary-transparent">Shortlisted</span>';
                                if(app.status === 'hired') statusBadge = '<span class="badge bg-success-transparent">Hired</span>';
                                if(app.status === 'rejected') statusBadge = '<span class="badge bg-danger-transparent">Rejected</span>';
                                
                                const companyName = (app.job && app.job.company) ? app.job.company.name : 'Unknown Company';
                                const jobTitle = (app.job) ? app.job.title : 'Unknown Job';

                                return `
                                    <tr>
                                        <td><h6 class="mb-0 fs-13 fw-semibold">${jobTitle}</h6></td>
                                        <td>${companyName}</td>
                                        <td>${new Date(app.createdAt).toLocaleDateString()}</td>
                                        <td>${statusBadge}</td>
                                    </tr>
                                `;
                            }).join('');
                        } else {
                            if(appsBody) appsBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">No applications yet. <a href="/jobs/feed">Start applying!</a></td></tr>`;
                        }

                        // Render Recommended Jobs
                        const jobsContainer = document.getElementById('recommended-jobs-container');
                        if (stats.recommendedJobs && stats.recommendedJobs.length > 0) {
                            jobsContainer.innerHTML = stats.recommendedJobs.map(job => {
                                const companyName = (job.company) ? job.company.name : 'Top Company';
                                const logoUrl = (job.company && job.company.logo_url) ? job.company.logo_url : '/assets/images/company-logos/1.png'; // fallback
                                const location = (job.company && job.company.location) ? job.company.location : 'Remote';
                                
                                return `
                                    <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
                                        <div class="card custom-card">
                                            <div class="card-body">
                                                <div class="d-flex align-items-center mb-3">
                                                    <span class="avatar avatar-sm bg-light p-1 me-2">
                                                        <img src="${logoUrl}" alt="img" class="language-img">
                                                    </span>
                                                    <a href="/jobs/${job.id}" class="text-dark fw-semibold mb-0 text-truncate" style="max-width: 150px;">${job.title}</a>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <p class="mb-0 fs-12 text-muted"><i class="ri-map-pin-line me-1 align-middle"></i>${location}</p>
                                                    <a href="/jobs/${job.id}" class="btn btn-sm btn-light-ghost">View</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        } else {
                           if(jobsContainer) jobsContainer.innerHTML = `<div class="col-12 text-center text-muted"><p>No relevant jobs found at the moment.</p></div>`;
                        }
                    }
                }
            } else {
                console.error("API Error:", data.error);
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "Failed to load user data: " + data.error,
                        duration: 5000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#ff5b5c",
                    }).showToast();
                }
            }

        } catch (err) {
            console.error("Dashboard Init Error:", err);
            // alert("Dashboard Error: " + err.message);
            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: "Dashboard Error: " + err.message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "#ff5b5c",
                }).showToast();
            }
        }
    }
    // Run Logic when page loads
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>

<%- include('includes/footer2') %>
