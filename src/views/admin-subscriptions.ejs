<%- include('includes/header2') %>

<style>
.page-hero {
    background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    color: white;
}

.page-hero h1 { font-weight: 700; font-size: 1.75rem; margin-bottom: 0.5rem; }

.data-card {
    background: var(--custom-white);
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.05);
    overflow: hidden;
}

.data-card .card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.data-table { width: 100%; }
.data-table th { background: rgba(118, 75, 162, 0.05); font-weight: 600; font-size: 0.85rem; padding: 1rem; }
.data-table td { padding: 0.75rem 1rem; vertical-align: middle; border-bottom: 1px solid rgba(0,0,0,0.03); }
.data-table tbody tr:hover { background: rgba(118, 75, 162, 0.03); }

.status-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.status-badge.active { background: rgba(0, 176, 116, 0.15); color: #00b074; }
.status-badge.cancelled, .status-badge.expired { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
.status-badge.pending { background: rgba(255, 159, 67, 0.15); color: #ff9f43; }

.plan-badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
.plan-badge.free { background: rgba(108, 117, 125, 0.15); color: #6c757d; }
.plan-badge.basic { background: rgba(23, 162, 184, 0.15); color: #17a2b8; }
.plan-badge.pro, .plan-badge.premium { background: rgba(118, 75, 162, 0.15); color: #764ba2; }
.plan-badge.enterprise { background: rgba(255, 215, 0, 0.2); color: #d4a000; }

.filters-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; }

.pagination-wrapper { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
</style>

<div class="main-content app-content">
    <%- include(sidebar) %>
    <div class="container-fluid">
        
        <div class="page-hero">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="ri-vip-crown-line me-2"></i>Subscriptions</h1>
                    <p class="mb-0 opacity-75">Manage user subscriptions and plans</p>
                </div>
                <a href="/dashboard/admin" class="btn btn-light btn-sm"><i class="ri-arrow-left-line me-1"></i> Dashboard</a>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-row">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by user...">
            <select class="form-select" id="statusFilter">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="cancelled">Cancelled</option>
                <option value="expired">Expired</option>
            </select>
            <select class="form-select" id="planFilter">
                <option value="">All Plans</option>
                <option value="free">Free</option>
                <option value="basic">Basic</option>
                <option value="pro">Pro</option>
                <option value="enterprise">Enterprise</option>
            </select>
            <button class="btn btn-purple text-white" style="background: #764ba2;" onclick="loadSubscriptions()"><i class="ri-filter-line me-1"></i> Filter</button>
        </div>

        <!-- Subscriptions Table -->
        <div class="data-card">
            <div class="card-header">
                <h6 class="mb-0">All Subscriptions</h6>
                <span class="text-muted" id="subCount">Loading...</span>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Plan</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subsTableBody">
                        <tr><td colspan="7" class="text-center py-4">Loading subscriptions...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination-wrapper">
                <span class="text-muted" id="paginationInfo">-</span>
                <nav><ul class="pagination pagination-sm mb-0" id="paginationControls"></ul></nav>
            </div>
        </div>
    </div>
</div>

<%- include('includes/footer2') %>

<script>
let currentPage = 1;

document.addEventListener('DOMContentLoaded', () => { loadSubscriptions(); });

async function loadSubscriptions(page = 1) {
    currentPage = page;
    const token = localStorage.getItem('token');
    const params = new URLSearchParams({
        page, limit: 20,
        search: document.getElementById('searchInput').value,
        status: document.getElementById('statusFilter').value,
        plan: document.getElementById('planFilter').value
    });
    
    try {
        const res = await fetch(`/api/admin/subscriptions?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const data = await res.json();
        
        if (data.success) {
            renderSubscriptions(data.subscriptions);
            document.getElementById('subCount').textContent = `${data.pagination?.total || data.subscriptions.length} subscriptions`;
            if (data.pagination) {
                document.getElementById('paginationInfo').textContent = `Page ${data.pagination.page} of ${data.pagination.pages}`;
                renderPagination(data.pagination);
            }
        }
    } catch (e) { console.error(e); }
}

function renderSubscriptions(subs) {
    const tbody = document.getElementById('subsTableBody');
    if (!subs.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No subscriptions found</td></tr>'; return; }
    
    tbody.innerHTML = subs.map(s => `
        <tr>
            <td>
                <div class="fw-medium">${s.User?.full_name || 'Unknown'}</div>
                <small class="text-muted">${s.User?.email || '-'}</small>
            </td>
            <td><span class="plan-badge ${(s.plan_name || 'free').toLowerCase()}">${s.plan_name || 'Free'}</span></td>
            <td><span class="status-badge ${s.status || 'active'}">${s.status || 'active'}</span></td>
            <td>${s.start_date ? new Date(s.start_date).toLocaleDateString() : '-'}</td>
            <td>${s.end_date ? new Date(s.end_date).toLocaleDateString() : '-'}</td>
            <td>$${s.amount || '0'}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="cancelSubscription('${s.id}')"><i class="ri-close-line"></i> Cancel</button>
            </td>
        </tr>
    `).join('');
}

function renderPagination(p) {
    let html = '';
    if (p.page > 1) html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${p.page-1})">Prev</a></li>`;
    for (let i = 1; i <= Math.min(p.pages, 5); i++) html += `<li class="page-item ${i===p.page?'active':''}"><a class="page-link" href="#" onclick="loadSubscriptions(${i})">${i}</a></li>`;
    if (p.page < p.pages) html += `<li class="page-item"><a class="page-link" href="#" onclick="loadSubscriptions(${p.page+1})">Next</a></li>`;
    document.getElementById('paginationControls').innerHTML = html;
}

async function cancelSubscription(id) {
    if (!confirm('Cancel this subscription?')) return;
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`/api/admin/subscriptions/${id}`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'cancelled' })
        });
        if ((await res.json()).success) loadSubscriptions(currentPage);
    } catch (e) { console.error(e); }
}

document.getElementById('searchInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') loadSubscriptions(); });
</script>
