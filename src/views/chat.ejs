<%- include('includes/header2') %>

<!-- CSS Fixes for Layout and Overlay Issues -->
<style>
    /* SKELETON LOADER ANIMATIONS */
    .skeleton-box {
        display: inline-block;
        height: 1em;
        position: relative;
        overflow: hidden;
        background-color: #DDDBDD;
        border-radius: 4px;
    }
    .skeleton-box::after {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        transform: translateX(-100%);
        background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0,
            rgba(255, 255, 255, 0.2) 20%,
            rgba(255, 255, 255, 0.5) 60%,
            rgba(255, 255, 255, 0)
        );
        animation: shimmer 2s infinite;
        content: '';
    }
    @keyframes shimmer {
        100% { transform: translateX(100%); }
    }
    
    /* Dark mode support for skeleton */
    [data-theme-mode="dark"] .skeleton-box, 
    .dark .skeleton-box {
        background-color: #2b3042; /* Darker bg for dark mode */
    }
    [data-theme-mode="dark"] .skeleton-box::after,
    .dark .skeleton-box::after {
        background-image: linear-gradient(
            90deg,
            rgba(255, 255, 255, 0) 0,
            rgba(255, 255, 255, 0.05) 20%,
            rgba(255, 255, 255, 0.1) 60%,
            rgba(255, 255, 255, 0)
        );
    }

    .skeleton-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    .skeleton-text {
        height: 12px;
        margin-bottom: 6px;
    }

    /* Mobile Chat Toggles */
    @media (max-width: 991.98px) {
        .chat-info { width: 100% !important; display: block; height: 100% !important; }
        .main-chat-area { display: none; width: 100% !important; height: 100% !important; }
        
        /* When chat is active */
        .main-chart-wrapper.mobile-chat-active .chat-info { display: none !important; }
        .main-chart-wrapper.mobile-chat-active .main-chat-area { display: flex !important; }
        
        .responsive-chat-close { display: block !important; }
    }
    @media (min-width: 992px) {
        .responsive-chat-close { display: none !important; }
    }

    /* ============================================
       ENHANCED CHAT UI - MODERN DESIGN
       ============================================ */

    /* Chat Container - Better spacing */
    .main-chart-wrapper {
        margin-top: 0.5rem;
        border-radius: 16px;
        overflow: hidden;
        background: var(--custom-white);
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    /* Sidebar Improvements */
    .chat-info {
        background: var(--custom-white) !important;
        border-right: 1px solid rgba(0,0,0,0.05) !important;
        border-radius: 16px 0 0 16px;
    }

    /* Chat Search Bar */
    .chat-search {
        padding: 1rem;
        background: transparent !important;
    }
    
    .chat-search .form-control {
        border-radius: 12px;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid rgba(0,0,0,0.08);
        background: rgba(0,0,0,0.02);
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    
    .chat-search .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        background: var(--custom-white);
    }

    /* Tab Navigation */
    .chat-info .nav-tabs {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 0 0.5rem;
    }
    
    .chat-info .nav-tabs .nav-link {
        border: none;
        color: #888;
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s ease;
    }
    
    .chat-info .nav-tabs .nav-link.active {
        color: #667eea;
        background: rgba(102, 126, 234, 0.1);
        border-bottom: 2px solid #667eea;
    }

    /* Chat List Items */
    .chat-users-tab li, .chat-groups-tab li, .chat-contacts-tab li {
        padding: 12px 16px;
        margin: 4px 8px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: none;
    }
    
    .chat-users-tab li:hover, .chat-groups-tab li:hover, .chat-contacts-tab li:hover {
        background: rgba(102, 126, 234, 0.08);
    }
    
    .checkforactive.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.1)) !important;
        border-left: 3px solid #667eea;
    }

    /* Avatar Improvements */
    .chat-users-tab .avatar, .chat-groups-tab .avatar, .chat-contacts-tab .avatar {
        border-radius: 12px;
    }

    /* Main Chat Area */
    .main-chat-area {
        background: linear-gradient(180deg, rgba(248,249,250,0.5) 0%, rgba(255,255,255,0.8) 100%) !important;
        border-radius: 0 16px 16px 0;
    }

    /* Chat Header */
    .main-chat-head {
        padding: 1rem 1.5rem !important;
        background: var(--custom-white);
        border-bottom: 1px solid rgba(0,0,0,0.05) !important;
    }
    
    .main-chat-head .avatar {
        border-radius: 12px;
    }

    /* Message Bubbles - Compact WhatsApp Style */
    .main-chat-msg {
        display: inline-block;
        max-width: 85%; /* Increased from 70% per modern apps */
        padding: 6px 10px !important; /* Force compact padding */
        border-radius: 12px;
        position: relative;
        box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        word-wrap: break-word;
    }
    
    /* Ensure no nested backgrounds */
    .main-chat-msg > div,
    .main-chat-msg p,
    .main-chat-msg span:not(.msg-menu-btn) {
        background: transparent !important;
    }
    
    .main-chat-msg p {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1.3;
        font-size: 0.85rem !important;
    }
    
    /* Received Messages - Light gray bubble */
    .chat-item-start .main-chat-msg {
        background: #e4e6eb !important;
        color: #050505 !important;
        border-bottom-left-radius: 4px;
    }
    
    .chat-item-start .main-chat-msg p {
        color: #050505 !important;
    }
    
    /* Sent Messages - Gradient purple & Right Align */
    .chat-item-end .main-chat-msg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: #fff !important;
        border-bottom-right-radius: 4px;
        text-align: left; /* Text inside bubble */
    }
    
    /* ALIGNMENT FIX: Straighten Sent Messages */
    .chat-item-end .me-3,
    .chat-item-end .ms-3 {
        display: flex;
        flex-direction: column;
        align-items: flex-end !important;
    }
    
    .chat-item-end .main-chat-msg p {
        color: #fff !important;
    }
    
    .chat-item-end .main-chat-msg .msg-time,
    .chat-item-end .chatting-user-info {
        color: rgba(255,255,255,0.75) !important;
    }
    
    /* Message Time - Aligned inline */
    .msg-time, .msg-sent-time {
        font-size: 0.65rem;
        color: #8a8d91;
        margin-top: 2px;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .chatting-user-info {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 0.65rem;
        margin-bottom: 2px;
    }
    
    .chat-read-mark {
        font-size: 0.8rem;
    }

    /* Chat List Item Layout - Proper Alignment */
    .chat-list-inner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        width: 100%;
    }
    
    .chat-item-start .chat-list-inner {
        justify-content: flex-start;
    }
    
    .chat-item-end .chat-list-inner {
        justify-content: flex-end;
    }
    
    .chat-user-profile {
        flex-shrink: 0;
    }
    
    .chat-user-profile .avatar {
        width: 32px !important;
        height: 32px !important;
        min-width: 32px;
    }
    
    .chat-user-profile .avatar img {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover;
        border-radius: 50%;
    }

    /* Chat Footer - Fixed and Aligned */
    .chat-footer {
        display: flex !important;
        align-items: center;
        gap: 8px;
        padding: 12px 16px !important;
        background: var(--custom-white) !important;
        border-top: 1px solid rgba(0,0,0,0.08) !important;
    }
    
    .chat-footer .form-control {
        flex: 1;
        border-radius: 20px;
        padding: 10px 16px;
        border: 1px solid rgba(0,0,0,0.1);
        font-size: 0.9rem;
        background: #f5f5f5;
    }
    
    .chat-footer .form-control:focus {
        background: #fff;
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
    }
    
    .chat-footer .btn-icon {
        width: 40px !important;
        height: 40px !important;
        min-width: 40px;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        padding: 0 !important;
    }
    
    .chat-footer .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        border: none !important;
    }

    /* Message Menu Button */
    .msg-menu-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.1);
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        font-size: 12px;
        color: inherit;
    }
    
    .main-chat-msg:hover .msg-menu-btn {
        opacity: 1;
    }

    /* ============= DARK MODE ============= */
    [data-theme-mode="dark"] .chat-item-start .main-chat-msg,
    html[data-bs-theme="dark"] .chat-item-start .main-chat-msg,
    .dark .chat-item-start .main-chat-msg {
        background: #3a3b3c !important;
        color: #e4e6eb !important;
    }
    
    [data-theme-mode="dark"] .chat-item-start .main-chat-msg p,
    html[data-bs-theme="dark"] .chat-item-start .main-chat-msg p,
    .dark .chat-item-start .main-chat-msg p {
        color: #e4e6eb !important;
    }
    
    [data-theme-mode="dark"] .chat-footer,
    html[data-bs-theme="dark"] .chat-footer,
    .dark .chat-footer {
        background: #1a1a2e !important;
        border-top-color: rgba(255,255,255,0.08) !important;
    }
    
    [data-theme-mode="dark"] .chat-footer .form-control,
    html[data-bs-theme="dark"] .chat-footer .form-control,
    .dark .chat-footer .form-control {
        background: #252540 !important;
        border-color: rgba(255,255,255,0.1) !important;
        color: #e4e6eb !important;
    }
    
    [data-theme-mode="dark"] .chat-footer .form-control::placeholder,
    html[data-bs-theme="dark"] .chat-footer .form-control::placeholder,
    .dark .chat-footer .form-control::placeholder {
        color: #8a8d91 !important;
    }

    /* ============= MOBILE VIEW ============= */
    @media (max-width: 768px) {
        .main-chat-msg {
            max-width: 85%;
            padding: 8px 10px;
            border-radius: 10px;
        }
        
        .main-chat-msg p {
            font-size: 0.85rem;
        }
        
        .chat-user-profile .avatar {
            width: 28px !important;
            height: 28px !important;
            min-width: 28px;
        }
        
        .chat-footer {
            padding: 8px 12px !important;
            gap: 6px;
        }
        
        .chat-footer .form-control {
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        
        .chat-footer .btn-icon {
            width: 36px !important;
            height: 36px !important;
            min-width: 36px;
        }
        
        .chat-list-inner {
            gap: 6px;
        }
        
        /* Hide some icons on mobile to save space */
        .chat-footer .btn-icon:not(.btn-primary):nth-child(n+3) {
            display: none !important;
        }
    }

    /* Empty Chat State */
    .empty-chat-placeholder {
        background: transparent !important;
    }
    
    .empty-chat-placeholder .avatar {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
    }

    /* Typing Indicator */
    .typing-indicator {
        padding: 8px 16px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 16px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .typing-indicator span {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #667eea;
        animation: typingBounce 1.4s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-4px); }
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
        .main-chart-wrapper {
            margin-top: 0;
            border-radius: 0;
        }
        
        .chat-info, .main-chat-area {
            border-radius: 0 !important;
        }
        
        .main-chat-msg {
            max-width: 85%;
        }
    }

    /* FIX: Layout to push footer to bottom and enable normal scroll */
    .main-chat-area {
        display: flex !important;
        flex-direction: column !important;
        height: calc(100vh - 75px) !important; /* Adjusted height for full viewport */
        position: relative;
        background: transparent !important; /* Removed white background */
        border: none !important; /* Remove border to blend with main background */
    }

    /* Native Scrolling for Chat Content */
    .chat-content {
        flex: 1 1 0 !important; /* Grow to fill space, shrink if needed */
        overflow-y: auto !important; /* Enable native vertical scroll */
        overflow-x: hidden !important;
        position: relative;
        padding: 0; 
        display: flex;
        flex-direction: column;
        background: transparent !important; /* Transparent content area */
    }

    /* Ensure the list takes full height for centering the empty state */
    #chat-messages-ul {
        min-height: 100%;
        display: flex;
        flex-direction: column;
        padding: 1rem;
    }
    
    /* Ensure footer stays at bottom */
    .chat-footer {
        flex: 0 0 auto !important;
        margin-top: auto !important; /* Force footer to the bottom */
        position: relative !important;
        z-index: 1020 !important;
        background-color: transparent !important; /* Transparent footer */
        width: 100%;
        border-top: 1px solid rgba(0,0,0,0.05); /* Subtle border */
    }

    .chat-message-space {
        position: relative;
        z-index: 1021 !important;
    }

    /* Empty State Placeholder Styling */
    .empty-chat-placeholder {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
        color: #6c757d;
        background-color: transparent !important; /* Transparent placeholder */
        flex-grow: 1; 
    }

    /* Sidebar Transparency Fix */
    .chat-info {
        background: transparent !important; /* Make sidebar transparent */
        border: none !important; /* Remove border */
    }
    
    /* Adjust internal elements of sidebar to look good on transparent bg if needed */
    .chat-search, .nav-tabs, .tab-content {
        background: transparent !important;
        border-color: rgba(0,0,0,0.05) !important;
    }

    /* FIX: Chat List Item Background & Spacing */
    .chat-users-tab li, .chat-groups-tab li, .chat-contacts-tab li {
        width: 100%;
        padding: 10px 15px; /* Ensure padding inside LI for hover effect */
        cursor: pointer;
        border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .chat-users-tab li:hover, .chat-groups-tab li:hover, .chat-contacts-tab li:hover,
    .checkforactive.active {
        background-color: rgba(0, 0, 0, 0.03); /* Subtle hover/active bg */
    }

    /* Remove padding/margin from anchor tags inside li to let li handle spacing */
    .chat-users-tab li a, .chat-groups-tab li a {
        display: block;
        padding: 0; 
        color: inherit;
        text-decoration: none;
    }

    /* ============ MESSAGE POP ANIMATION ============ */
    @keyframes messagePop {
        0% {
            opacity: 0;
            transform: scale(0.8) translateY(10px);
        }
        50% {
            transform: scale(1.02) translateY(-2px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    .chat-item-start, .chat-item-end {
        animation: messagePop 0.3s ease-out forwards;
    }
    
    .chat-item-start .main-chat-msg,
    .chat-item-end .main-chat-msg {
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        position: relative;
    }
    
    .chat-item-start .main-chat-msg:hover,
    .chat-item-end .main-chat-msg:hover {
        transform: scale(1.01);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* ============ HOVER DROPDOWN BUTTON ============ */
    .msg-menu-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0,0,0,0.3);
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s ease;
        color: #fff;
        font-size: 16px;
        z-index: 10;
    }
    .chat-item-start .msg-menu-btn { right: -35px; }
    .chat-item-end .msg-menu-btn { left: -35px; }
    
    .chat-list-inner:hover .msg-menu-btn { opacity: 1; }
    .msg-menu-btn:hover { background: rgba(0,0,0,0.5); }

    /* ============ SWIPE GESTURE STYLING ============ */
    .chat-item-start, .chat-item-end {
        position: relative;
        touch-action: pan-y;
        user-select: none;
    }
    
    .swipe-action-indicator {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: var(--primary-color, #0d6efd);
        color: white;
        padding: 8px;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.2s ease;
        font-size: 18px;
    }
    .swipe-action-indicator.reply { left: -50px; }
    .swipe-action-indicator.forward { right: -50px; }
    .swipe-action-indicator.show { opacity: 1; }

    /* ============ MESSAGE CONTEXT MENU - Glassmorphism ============ */
    .message-context-menu {
        position: fixed;
        background: rgba(30, 30, 45, 0.85);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 9999;
        display: none;
        min-width: 140px;
        max-height: 320px;
        overflow-y: auto;
    }
    
    /* Light mode support */
    [data-theme-mode="light"] .message-context-menu,
    .light .message-context-menu {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }
    [data-theme-mode="light"] .context-menu-item,
    .light .context-menu-item {
        color: #333;
    }
    [data-theme-mode="light"] .context-menu-item i,
    .light .context-menu-item i {
        color: #7c3aed;
    }
    
    .message-context-menu.show { display: block; }
    
    .context-reactions {
        display: flex;
        gap: 2px;
        padding: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.08);
        justify-content: center;
    }
    .context-reactions span {
        font-size: 20px;
        cursor: pointer;
        transition: transform 0.15s;
        padding: 4px 6px;
        border-radius: 8px;
    }
    .context-reactions span:hover { 
        transform: scale(1.15); 
        background: rgba(255,255,255,0.1);
    }
    .context-reactions .more-emoji {
        width: 28px;
        height: 28px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: rgba(255,255,255,0.6);
    }
    
    /* Force Dark Inputs (Fixes white autofill box) */
    .unread-dot-container {
        display: inline-block;
        position: relative;
        width: 10px;
        height: 10px;
        margin-left: auto;
        vertical-align: middle;
    }
    .unread-dot {
        width: 10px;
        height: 10px;
        background-color: #00e676; /* Green glow */
        border-radius: 50%;
        display: block;
        box-shadow: 0 0 8px #00e676;
        animation: pulse-green 2s infinite;
    }
    @keyframes pulse-green {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(0, 230, 118, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); }
    }

    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0px 1000px #1a1a2e inset !important;
        -webkit-text-fill-color: #fff !important;
        caret-color: #fff !important;
    }
    
    /* Drag handle for context menu */
    .context-menu-drag-handle {
        display: flex;
        justify-content: center;
        padding: 6px;
        cursor: grab;
        color: rgba(255,255,255,0.4);
        border-bottom: 1px solid rgba(255,255,255,0.05);
        touch-action: none;
    }
    .context-menu-drag-handle:active { cursor: grabbing; }
    .context-menu-drag-handle i { font-size: 14px; }
    [data-theme-mode="light"] .context-menu-drag-handle,
    .light .context-menu-drag-handle { color: rgba(0,0,0,0.3); }
    
    .context-menu-item {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        color: rgba(255, 255, 255, 0.9);
        cursor: pointer;
        transition: background 0.15s;
        font-size: 14px;
        font-weight: 400;
    }
    .context-menu-item:hover { 
        background: rgba(139, 92, 246, 0.2); 
    }
    .context-menu-item i { 
        margin-right: 10px; 
        font-size: 16px; 
        color: rgba(139, 92, 246, 0.8);
        width: 18px;
    }
    .context-menu-item.danger { color: #ef4444; }
    .context-menu-item.danger i { color: #ef4444; }

    /* Reply preview in chat footer */
    .reply-preview {
        display: none;
        background: rgba(0,0,0,0.05);
        padding: 8px 12px;
        border-left: 3px solid var(--primary-color, #0d6efd);
        margin-bottom: 8px;
        border-radius: 4px;
        position: relative;
    }
    .reply-preview.show { display: block; }
    .reply-preview .close-reply {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #666;
    }
    
    /* Message reactions display - WhatsApp style below bubble */
    .message-reactions {
        display: flex;
        gap: 2px;
        margin-top: -6px;
        margin-left: 8px;
        position: relative;
        z-index: 5;
    }
    .chat-item-end .message-reactions {
        justify-content: flex-end;
        margin-right: 8px;
        margin-left: 0;
    }
    .message-reactions .reaction-badge {
        background: #1f2c33;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        transition: transform 0.1s;
    }
    .message-reactions .reaction-badge:hover {
        transform: scale(1.1);
    }
    
    /* Pinned Message Banner - WhatsApp style at top of chat */
    .pinned-message-banner {
        display: none;
        background: #1f2c33;
        padding: 10px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        cursor: pointer;
        align-items: center;
        gap: 12px;
    }
    .pinned-message-banner.show { display: flex; }
    .pinned-message-banner .pin-icon {
        color: #00a884;
        font-size: 18px;
    }
    .pinned-message-banner .pin-content {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #e9edef;
        font-size: 14px;
    }
    .pinned-message-banner .pin-close {
        color: #8696a0;
        cursor: pointer;
        font-size: 16px;
    }
    .pinned-message-banner .pin-close:hover { color: #e9edef; }
    
    /* Pin icon on message */
    .msg-pin-indicator {
        display: inline-flex;
        align-items: center;
        color: #8696a0;
        margin-left: 4px;
    }
    .msg-pin-indicator i { font-size: 12px; }

    /* ============================================
       DARK MODE SUPPORT - Complete Override
       ============================================ */
    
    /* Dark mode detection - covers multiple attribute patterns */
    [data-theme-mode="dark"],
    html[data-bs-theme="dark"],
    .dark {
        --chat-bg-primary: #1e1e2d;
        --chat-bg-secondary: #2b2b40;
        --chat-bg-tertiary: #323248;
        --chat-text-primary: #e4e6eb;
        --chat-text-secondary: #b0b3b8;
        --chat-text-muted: #8a8d91;
        --chat-border-color: rgba(255, 255, 255, 0.08);
        --chat-hover-bg: rgba(255, 255, 255, 0.05);
        --chat-bubble-received: #3a3b3c;
        --chat-bubble-sent: linear-gradient(135deg, #667eea, #764ba2);
    }

    /* Light mode defaults */
    :root {
        --chat-bg-primary: #ffffff;
        --chat-bg-secondary: #f8f9fa;
        --chat-bg-tertiary: #f0f2f5;
        --chat-text-primary: #1c1e21;
        --chat-text-secondary: #65676b;
        --chat-text-muted: #8a8d91;
        --chat-border-color: rgba(0, 0, 0, 0.08);
        --chat-hover-bg: rgba(0, 0, 0, 0.03);
        --chat-bubble-received: #f0f2f5;
        --chat-bubble-sent: linear-gradient(135deg, #667eea, #764ba2);
    }

    /* Chat Container - Dark Mode */
    [data-theme-mode="dark"] .main-chart-wrapper,
    html[data-bs-theme="dark"] .main-chart-wrapper,
    .dark .main-chart-wrapper {
        background: var(--chat-bg-primary) !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    /* Sidebar - Dark Mode */
    [data-theme-mode="dark"] .chat-info,
    html[data-bs-theme="dark"] .chat-info,
    .dark .chat-info {
        background: var(--chat-bg-primary) !important;
        border-right-color: var(--chat-border-color) !important;
    }

    /* Search Input - Dark Mode */
    [data-theme-mode="dark"] .chat-search .form-control,
    html[data-bs-theme="dark"] .chat-search .form-control,
    .dark .chat-search .form-control {
        background: var(--chat-bg-tertiary) !important;
        border-color: var(--chat-border-color) !important;
        color: var(--chat-text-primary) !important;
    }

    [data-theme-mode="dark"] .chat-search .form-control::placeholder,
    html[data-bs-theme="dark"] .chat-search .form-control::placeholder,
    .dark .chat-search .form-control::placeholder {
        color: var(--chat-text-muted) !important;
    }

    /* Tab Navigation - Dark Mode */
    [data-theme-mode="dark"] .chat-info .nav-tabs,
    html[data-bs-theme="dark"] .chat-info .nav-tabs,
    .dark .chat-info .nav-tabs {
        border-bottom-color: var(--chat-border-color) !important;
    }

    [data-theme-mode="dark"] .chat-info .nav-tabs .nav-link,
    html[data-bs-theme="dark"] .chat-info .nav-tabs .nav-link,
    .dark .chat-info .nav-tabs .nav-link {
        color: var(--chat-text-secondary) !important;
    }

    [data-theme-mode="dark"] .chat-info .nav-tabs .nav-link.active,
    html[data-bs-theme="dark"] .chat-info .nav-tabs .nav-link.active,
    .dark .chat-info .nav-tabs .nav-link.active {
        color: #667eea !important;
        background: rgba(102, 126, 234, 0.15) !important;
    }

    /* Chat List Items - Dark Mode */
    [data-theme-mode="dark"] .chat-users-tab li,
    [data-theme-mode="dark"] .chat-groups-tab li,
    [data-theme-mode="dark"] .chat-contacts-tab li,
    html[data-bs-theme="dark"] .chat-users-tab li,
    html[data-bs-theme="dark"] .chat-groups-tab li,
    html[data-bs-theme="dark"] .chat-contacts-tab li,
    .dark .chat-users-tab li,
    .dark .chat-groups-tab li,
    .dark .chat-contacts-tab li {
        border-bottom-color: var(--chat-border-color) !important;
    }

    [data-theme-mode="dark"] .chat-users-tab li:hover,
    [data-theme-mode="dark"] .chat-groups-tab li:hover,
    [data-theme-mode="dark"] .chat-contacts-tab li:hover,
    html[data-bs-theme="dark"] .chat-users-tab li:hover,
    html[data-bs-theme="dark"] .chat-groups-tab li:hover,
    html[data-bs-theme="dark"] .chat-contacts-tab li:hover,
    .dark .chat-users-tab li:hover,
    .dark .chat-groups-tab li:hover,
    .dark .chat-contacts-tab li:hover {
        background: var(--chat-hover-bg) !important;
    }

    [data-theme-mode="dark"] .checkforactive.active,
    html[data-bs-theme="dark"] .checkforactive.active,
    .dark .checkforactive.active {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.15)) !important;
    }

    /* Chat List Text - Dark Mode */
    [data-theme-mode="dark"] .chat-users-tab .fw-medium,
    [data-theme-mode="dark"] .chat-groups-tab .fw-medium,
    [data-theme-mode="dark"] .chat-contacts-tab .fw-medium,
    [data-theme-mode="dark"] .chat-contacts-tab .fw-semibold,
    html[data-bs-theme="dark"] .chat-users-tab .fw-medium,
    html[data-bs-theme="dark"] .chat-groups-tab .fw-medium,
    html[data-bs-theme="dark"] .chat-contacts-tab .fw-medium,
    html[data-bs-theme="dark"] .chat-contacts-tab .fw-semibold,
    .dark .chat-users-tab .fw-medium,
    .dark .chat-groups-tab .fw-medium,
    .dark .chat-contacts-tab .fw-medium,
    .dark .chat-contacts-tab .fw-semibold {
        color: var(--chat-text-primary) !important;
    }

    [data-theme-mode="dark"] .chat-msg,
    html[data-bs-theme="dark"] .chat-msg,
    .dark .chat-msg {
        color: var(--chat-text-secondary) !important;
    }

    /* Main Chat Area - Dark Mode */
    [data-theme-mode="dark"] .main-chat-area,
    html[data-bs-theme="dark"] .main-chat-area,
    .dark .main-chat-area {
        background: var(--chat-bg-secondary) !important;
    }

    /* Chat Header - Dark Mode */
    [data-theme-mode="dark"] .main-chat-head,
    html[data-bs-theme="dark"] .main-chat-head,
    .dark .main-chat-head {
        background: var(--chat-bg-primary) !important;
        border-bottom-color: var(--chat-border-color) !important;
    }

    [data-theme-mode="dark"] .chatnameperson,
    html[data-bs-theme="dark"] .chatnameperson,
    .dark .chatnameperson {
        color: var(--chat-text-primary) !important;
    }

    [data-theme-mode="dark"] .chatpersonstatus,
    html[data-bs-theme="dark"] .chatpersonstatus,
    .dark .chatpersonstatus {
        color: var(--chat-text-secondary) !important;
    }

    /* Message Bubbles - Dark Mode */
    [data-theme-mode="dark"] .chat-item-start .main-chat-msg,
    html[data-bs-theme="dark"] .chat-item-start .main-chat-msg,
    .dark .chat-item-start .main-chat-msg {
        background: var(--chat-bubble-received) !important;
        color: var(--chat-text-primary) !important;
    }

    [data-theme-mode="dark"] .chat-item-start .main-chat-msg p,
    html[data-bs-theme="dark"] .chat-item-start .main-chat-msg p,
    .dark .chat-item-start .main-chat-msg p {
        color: var(--chat-text-primary) !important;
    }

    /* Chat Footer - Dark Mode */
    [data-theme-mode="dark"] .chat-footer,
    html[data-bs-theme="dark"] .chat-footer,
    .dark .chat-footer {
        background: var(--chat-bg-primary) !important;
        border-top-color: var(--chat-border-color) !important;
    }

    [data-theme-mode="dark"] .chat-footer .form-control,
    html[data-bs-theme="dark"] .chat-footer .form-control,
    .dark .chat-footer .form-control {
        background: var(--chat-bg-tertiary) !important;
        border-color: var(--chat-border-color) !important;
        color: var(--chat-text-primary) !important;
    }

    [data-theme-mode="dark"] .chat-footer .form-control::placeholder,
    html[data-bs-theme="dark"] .chat-footer .form-control::placeholder,
    .dark .chat-footer .form-control::placeholder {
        color: var(--chat-text-muted) !important;
    }

    /* Empty State - Dark Mode */
    [data-theme-mode="dark"] .empty-chat-placeholder h5,
    html[data-bs-theme="dark"] .empty-chat-placeholder h5,
    .dark .empty-chat-placeholder h5 {
        color: var(--chat-text-primary) !important;
    }

    [data-theme-mode="dark"] .empty-chat-placeholder p,
    html[data-bs-theme="dark"] .empty-chat-placeholder p,
    .dark .empty-chat-placeholder p {
        color: var(--chat-text-secondary) !important;
    }

    /* ============================================
       ENHANCED ONLINE STATUS INDICATOR
       ============================================ */
    
    /* Pulsing Online Indicator */
    .avatar.online::before,
    .avatar-status-online::before {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background: #22c55e;
        border: 2px solid var(--chat-bg-primary, #fff);
        border-radius: 50%;
        animation: pulse-online 2s infinite;
        z-index: 10;
    }

    .avatar.offline::before,
    .avatar-status-offline::before {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background: #9ca3af;
        border: 2px solid var(--chat-bg-primary, #fff);
        border-radius: 50%;
        z-index: 10;
    }

    @keyframes pulse-online {
        0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.5); }
        70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
        100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
    }

    /* Status Text Colors */
    .chatpersonstatus {
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Online Status - Green */
    .avatar.online ~ .chatpersonstatus,
    .chatstatusperson.online ~ .flex-fill .chatpersonstatus {
        color: #22c55e !important;
    }

    /* ============================================
       ENHANCED MESSAGE INPUT AREA
       ============================================ */
    
    .chat-footer {
        display: flex !important;
        align-items: center;
        gap: 12px;
        padding: 1rem 1.5rem !important;
    }

    .chat-footer .form-control {
        flex: 1;
        border-radius: 24px !important;
        padding: 12px 20px !important;
        font-size: 0.95rem !important;
        border: 2px solid transparent !important;
        background: var(--chat-bg-tertiary, #f0f2f5) !important;
        transition: all 0.3s ease !important;
    }

    .chat-footer .form-control:focus {
        border-color: #667eea !important;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15) !important;
        background: var(--chat-bg-primary, #fff) !important;
    }

    .chat-footer .btn-icon {
        width: 44px !important;
        height: 44px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease !important;
    }

    .chat-footer .btn-icon:hover {
        transform: scale(1.1);
    }

    .chat-footer .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
    }

    .chat-footer .btn-primary:hover {
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6) !important;
        transform: scale(1.1) !important;
    }

    /* ============================================
       ENHANCED MESSAGE TIME DISPLAY
       ============================================ */
    
    .msg-time {
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .chat-item-end .msg-time {
        color: rgba(255, 255, 255, 0.7);
        justify-content: flex-end;
    }

    .chat-item-start .msg-time {
        color: var(--chat-text-muted);
    }

    /* Message Read Checkmarks */
    .msg-time .read-status {
        font-size: 0.85rem;
    }

    .msg-time .read-status.read {
        color: #667eea;
    }

    /* ============================================
       UNREAD MESSAGE INDICATOR
       ============================================ */
    
    .unread-dot {
        width: 10px;
        height: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border-radius: 50%;
        display: inline-block;
        animation: pulse-unread 2s infinite;
    }

    @keyframes pulse-unread {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Unread Count Badge */
    .badge.bg-success {
        background: linear-gradient(135deg, #667eea, #764ba2) !important;
        font-size: 0.65rem;
        padding: 4px 8px;
        border-radius: 12px;
    }

    /* ============================================
       SMOOTH SCROLLBAR STYLING
       ============================================ */
    
    .chat-content::-webkit-scrollbar,
    #chat-msg-scroll::-webkit-scrollbar,
    .chat-contacts-tab::-webkit-scrollbar {
        width: 6px;
    }

    .chat-content::-webkit-scrollbar-track,
    #chat-msg-scroll::-webkit-scrollbar-track,
    .chat-contacts-tab::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-content::-webkit-scrollbar-thumb,
    #chat-msg-scroll::-webkit-scrollbar-thumb,
    .chat-contacts-tab::-webkit-scrollbar-thumb {
        background: rgba(102, 126, 234, 0.3);
        border-radius: 10px;
    }

    .chat-content::-webkit-scrollbar-thumb:hover,
    #chat-msg-scroll::-webkit-scrollbar-thumb:hover,
    .chat-contacts-tab::-webkit-scrollbar-thumb:hover {
        background: rgba(102, 126, 234, 0.5);
    }

    /* ============================================
       FORCE DARK MODE - MAIN CONTAINERS
       ============================================ */
    
    /* Main Chat Wrapper - Dark */
    html[data-theme-mode="dark"] .main-chart-wrapper,
    [data-theme-mode="dark"] .main-chart-wrapper {
        background: #1a1a2e !important;
    }
    
    /* Sidebar - Dark */
    html[data-theme-mode="dark"] .chat-info,
    [data-theme-mode="dark"] .chat-info {
        background: #1a1a2e !important;
        border-color: rgba(255,255,255,0.08) !important;
    }
    
    /* Main Chat Area - Dark */
    html[data-theme-mode="dark"] .main-chat-area,
    [data-theme-mode="dark"] .main-chat-area {
        background: #16213e !important;
    }
    
    /* Chat Content - Dark */
    html[data-theme-mode="dark"] .chat-content,
    [data-theme-mode="dark"] .chat-content {
        background: #16213e !important;
    }
    
    /* Chat Header - Dark */
    html[data-theme-mode="dark"] .main-chat-head,
    [data-theme-mode="dark"] .main-chat-head {
        background: #1a1a2e !important;
        border-color: rgba(255,255,255,0.08) !important;
    }
    
    /* Chat Footer - Dark */
    html[data-theme-mode="dark"] .chat-footer,
    [data-theme-mode="dark"] .chat-footer {
        background: #1a1a2e !important;
        border-color: rgba(255,255,255,0.08) !important;
    }
    
    /* Chat Search - Dark */
    html[data-theme-mode="dark"] .chat-search,
    [data-theme-mode="dark"] .chat-search {
        background: transparent !important;
    }
    
    /* Tab Content - Dark */
    html[data-theme-mode="dark"] .tab-content,
    [data-theme-mode="dark"] .tab-content {
        background: transparent !important;
    }
    
    /* Tab Pane - Dark */
    html[data-theme-mode="dark"] .tab-pane,
    [data-theme-mode="dark"] .tab-pane {
        background: transparent !important;
    }
    
    /* Nav Tabs - Dark */
    html[data-theme-mode="dark"] .nav-tabs,
    [data-theme-mode="dark"] .nav-tabs {
        background: transparent !important;
        border-color: rgba(255,255,255,0.08) !important;
    }
    
    /* Container Fluid - Dark */
    html[data-theme-mode="dark"] .container-fluid,
    [data-theme-mode="dark"] .container-fluid {
        background: transparent !important;
    }
    
    /* Input Fields - Dark */
    html[data-theme-mode="dark"] .chat-info .form-control,
    [data-theme-mode="dark"] .chat-info .form-control {
        background: #252540 !important;
        border-color: rgba(255,255,255,0.1) !important;
        color: #e4e6eb !important;
    }
    
    html[data-theme-mode="dark"] .chat-footer .form-control,
    [data-theme-mode="dark"] .chat-footer .form-control {
        background: #252540 !important;
        border-color: rgba(255,255,255,0.1) !important;
        color: #e4e6eb !important;
    }
    
    /* Header Avatar Default Image */
    .chatimageperson[src=""],
    .chatimageperson:not([src]) {
        content: url('https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg');
    }

    /* Date Labels - Dark Mode */
    html[data-theme-mode="dark"] .chat-day-label span,
    [data-theme-mode="dark"] .chat-day-label span {
        background: #252540 !important;
        color: #e4e6eb !important;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    /* FORCE Message Bubbles - Dark Mode (High Specificity) */
    html[data-theme-mode="dark"] .chat-item-start .main-chat-msg,
    [data-theme-mode="dark"] .chat-item-start .main-chat-msg {
        background-color: #3a3b3c !important; 
        color: #e4e6eb !important;
    }
    
    html[data-theme-mode="dark"] .chat-item-start .main-chat-msg p,
    [data-theme-mode="dark"] .chat-item-start .main-chat-msg p {
        color: #e4e6eb !important;
    }
    
    /* Fix Sent Message Text Visibility */
    .chat-item-end .main-chat-msg p {
        color: #fff !important;
        opacity: 1 !important;
        visibility: visible !important;
        display: block !important;
    }
    
    html[data-theme-mode="dark"] .chat-item-end .main-chat-msg p,
    [data-theme-mode="dark"] .chat-item-end .main-chat-msg p {
        color: #fff !important;
    }

    /* ============================================
       MOBILE RESPONSIVE VIEW REDESIGN
       ============================================ */
    @media (max-width: 991px) {
        /* Default State: Show Sidebar, Hide Chat */
        .main-chart-wrapper .chat-info {
            display: block !important;
            width: 100% !important;
        }
        .main-chart-wrapper .main-chat-area {
            display: none !important;
            width: 100% !important;
        }

        /* Active Chat State: Hide Sidebar, Show Chat */
        .main-chart-wrapper.mobile-chat-active .chat-info {
            display: none !important;
        }
        .main-chart-wrapper.mobile-chat-active .main-chat-area {
            display: block !important;
            height: calc(100vh - 130px); /* Ensure full height */
        }
        
        /* Ensure Chat Content scrolls properly */
        .chat-content {
            height: calc(100% - 130px) !important;
        }
        
        /* Mobile Toggle Buttons */
        .responsive-chat-close {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        /* Reduce Container Padding on Mobile */
        .page-header-breadcrumb {
            margin-bottom: 0.5rem !important;
        }
        
        /* AGGRESSIVE MOBILE RESET For Full Width */
        .container-fluid {
            padding-left: 0 !important;
            padding-right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .row {
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        .col-xl-9, .col-xl-3, .col-12 {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }
        
        .main-chart-wrapper {
            margin: 0 !important;
            width: 100% !important;
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
        }
        
        /* MAXIMIZE SPACE: Remove Main Content Padding & Hide Breadcrumb */
        .main-content, .app-content {
            padding: 0 !important;
            margin-top: 60px !important; /* keep space for top header if needed */
            min-height: 100vh !important;
        }
        
        .page-header-breadcrumb {
            display: none !important;
        }
        
        /* Remove footer margin if present */
        .footer {
            display: none !important; /* Hide dashboard footer on chat */
        }
    }

    /* ============================================
       CALL OVERLAY STYLES
       ============================================ */
    .call-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: #1a1a2e;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    #remote-video {
        width: 100%; height: 100%; object-fit: cover;
        position: absolute; top: 0; left: 0;
    }
    #local-video {
        width: 120px; height: 160px; object-fit: cover;
        position: absolute; bottom: 20px; right: 20px;
        border-radius: 12px;
        border: 2px solid #fff;
        background: #000;
        z-index: 2;
    }
    .call-controls-wrapper {
        position: absolute; bottom: 30px; left: 0; width: 100%;
        display: flex; justify-content: center; gap: 20px;
        z-index: 10;
    }
    .call-info-wrapper {
        position: relative; z-index: 5;
        text-align: center;
    }
    .pulse-avatar {
        animation: pulse-ring 2s infinite;
    }
    @keyframes pulse-ring {
        0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(102, 126, 234, 0); }
        100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
    }

    /* FORCE SIDEBAR TEXT VISIBILITY - DARK MODE */
    [data-theme-mode="dark"] .chat-info .fw-semibold,
    [data-theme-mode="dark"] .chat-info .fw-medium,
    [data-theme-mode="dark"] .chat-info span,
    [data-theme-mode="dark"] .chat-info p,
    [data-theme-mode="dark"] .chat-info h6,
    html[data-bs-theme="dark"] .chat-info .fw-semibold {
        color: #e4e6eb !important;
    }
    
    [data-theme-mode="dark"] .chat-info .text-muted,
    html[data-bs-theme="dark"] .chat-info .text-muted {
        color: #9ca3af !important;
    }

</style>

<div class="main-content app-content">
<%- include(sidebar || 'includes/sidebar-employer') %>
    <div class="container-fluid">

        <!-- Page Header -->
        <div class="d-flex align-items-center justify-content-between page-header-breadcrumb flex-wrap gap-2">
            <div>

                <h1 class="page-title fw-medium fs-18 mb-0">Chat</h1>
            </div>

        </div>
        <!-- Page Header Close -->
    
        <div class="main-chart-wrapper gap-lg-2 gap-0 mb-2 d-lg-flex">
            <div class="chat-info border">
                <div class="chat-search p-3 border-bottom"> 
                    <div class="input-group"> 
                        <input type="text" class="form-control" id="chat-search-input" placeholder="Search Chat" aria-describedby="button-addon01"> 
                        <button aria-label="button" class="btn btn-primary" type="button" id="button-addon01">
                            <i class="ri-search-line"></i>
                        </button> 
                    </div> 
                </div>
                <ul class="nav nav-tabs tab-style-6 nav-justified mb-0 border-bottom d-flex gap-1 gap-sm-2 flex-wrap" id="myTab1" role="tablist">
                    <li class="nav-item me-0" role="presentation">
                        <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts-tab-pane" type="button" role="tab" aria-controls="contacts-tab-pane" aria-selected="true">Chats</button>
                    </li>
                    <li class="nav-item me-0" role="presentation">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-tab-pane" type="button" role="tab" aria-controls="users-tab-pane" aria-selected="false" tabindex="-1">Recent</button>
                    </li>
                    <% if (sidebar !== 'includes/sidebar-seeker') { %>
                    <li class="nav-item me-0" role="presentation">
                        <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-tab-pane" type="button" role="tab" aria-controls="groups-tab-pane" aria-selected="false" tabindex="-1">Groups</button>
                    </li>
                    <li class="nav-item me-0" role="presentation">
                        <button class="nav-link" id="channels-tab" data-bs-toggle="tab" data-bs-target="#channels-tab-pane" type="button" role="tab" aria-controls="channels-tab-pane" aria-selected="false" tabindex="-1">Channels</button>
                    </li>
                    <% } %>
                </ul>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane show active border-0 chat-contacts-tab" id="contacts-tab-pane" role="tabpanel" aria-labelledby="contacts-tab" tabindex="0">
                        <ul class="list-unstyled mb-0 chat-contacts-tab" style="height: calc(100vh - 280px); overflow-y: auto;">
                            <!-- Dynamic Content Will Be Loaded Here -->
                            <!-- SKELETON LOADER (Initial State) -->
                            <li class="p-3">
                                <div class="d-flex align-items-top">
                                    <div class="me-2"><span class="skeleton-box skeleton-avatar"></span></div>
                                    <div class="flex-fill">
                                        <div class="skeleton-box skeleton-text" style="width: 60%"></div>
                                        <div class="skeleton-box skeleton-text" style="width: 40%"></div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-pane border-0 chat-users-tab" id="users-tab-pane" role="tabpanel" aria-labelledby="users-tab" tabindex="0">
                        <ul class="list-unstyled mb-0 mt-2 chat-users-tab simplebar-scrollable-y" id="chat-msg-scroll" data-simplebar="init">
                            <div class="simplebar-wrapper" style="margin: 0px;">
                                <div class="simplebar-height-auto-observer-wrapper"><div class="simplebar-height-auto-observer"></div></div>
                                <div class="simplebar-mask">
                                    <div class="simplebar-offset" style="right: 0px; bottom: 0px;">
                                        <div class="simplebar-content-wrapper" tabindex="0" role="region" aria-label="scrollable content" style="height: auto; overflow: hidden scroll;">
                                            <div class="simplebar-content" style="padding: 0px;">
                                                <!-- Dynamic Content Will Be Loaded Here -->
                                                <!-- SKELETON LOADER (Initial State) -->
                                                <li class="p-3">
                                                    <div class="d-flex align-items-top">
                                                        <div class="me-2"><span class="skeleton-box skeleton-avatar"></span></div>
                                                        <div class="flex-fill">
                                                            <div class="skeleton-box skeleton-text" style="width: 60%"></div>
                                                            <div class="skeleton-box skeleton-text" style="width: 40%"></div>
                                                        </div>
                                                    </div>
                                                </li>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="simplebar-placeholder" style="width: 326px; height: 692px;"></div>
                            </div>
                            <div class="simplebar-track simplebar-horizontal" style="visibility: hidden;"><div class="simplebar-scrollbar" style="width: 0px; display: none; transform: translate3d(0px, 0px, 0px);"></div></div>
                            <div class="simplebar-track simplebar-vertical" style="visibility: visible;"><div class="simplebar-scrollbar" style="height: 216px; transform: translate3d(0px, 0px, 0px); display: block;"></div></div>
                        </ul>
                    </div>
                    <% if (sidebar !== 'includes/sidebar-seeker') { %>
                    <div class="tab-pane border-0 chat-groups-tab" id="groups-tab-pane" role="tabpanel" aria-labelledby="groups-tab" tabindex="0">

                        <ul class="list-unstyled mb-0 mt-2" style="height: calc(100vh - 280px); overflow-y: auto;">
                            <!-- Dynamic Content -->
                            <!-- SKELETON LOADER (Initial State) -->
                            <li class="p-3">
                                <div class="d-flex align-items-top">
                                    <div class="me-2"><span class="skeleton-box skeleton-avatar"></span></div>
                                    <div class="flex-fill">
                                        <div class="skeleton-box skeleton-text" style="width: 60%"></div>
                                        <div class="skeleton-box skeleton-text" style="width: 40%"></div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <!-- CHANNELS TAB -->
                    <div class="tab-pane border-0 chat-channels-tab" id="channels-tab-pane" role="tabpanel" aria-labelledby="channels-tab" tabindex="0">
                         <!-- Create Button Removed as per request -->
                         <div class="p-3 border-bottom d-none"> 
                            <!-- Hidden for now, maybe remove completely later if desired -->
                        </div>
                         <ul class="list-unstyled mb-0 mt-2" id="channels-list" style="height: calc(100vh - 280px); overflow-y: auto;">
                            <!-- Dynamic Content -->
                            <li class="p-3 text-center text-muted">Loading channels...</li>
                         </ul>
                    </div>
                    <% } %>
                </div>
            </div>
            
            <div class="main-chat-area border-0"> <!-- Removed border class here too -->
                <div class="d-flex align-items-center border-bottom main-chat-head flex-wrap" id="main-chat-header" style="display:none !important;">
                    <span class="avatar avatar-md avatar-rounded online chatstatusperson me-2 lh-1">
                        <img class="chatimageperson" src="" alt="img">
                    </span>
                    <div class="flex-fill">
                        <p class="mb-0 fw-medium fs-14 lh-1">
                            <a href="javascript:void(0);" data-bs-toggle="offcanvas" data-bs-target="#offcanvasRight" aria-controls="offcanvasRight" class="chatnameperson responsive-userinfo-open">Select User</a>
                        </p>
                        <p class="text-muted mb-0 chatpersonstatus">online</p>
                    </div>
                    <div class="d-flex flex-wrap rightIcons gap-2">
                        <!-- Video Call Icon Restored -->
                        <button aria-label="button" type="button" class="btn btn-icon btn-success-light my-0 btn-sm">
                            <i class="ri-video-add-line"></i>
                        </button>
                        <button aria-label="button" type="button" class="btn btn-icon btn-primary-light my-0 btn-sm">
                            <i class="ti ti-phone"></i>
                        </button>

                        <button aria-label="button" type="button" class="btn btn-icon btn-primary-light my-0 responsive-chat-close btn-sm">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Pinned Message Banner -->
                <div class="pinned-message-banner" id="pinnedMessageBanner" onclick="scrollToPinnedMessage()">
                    <i class="ri-pushpin-fill pin-icon"></i>
                    <span class="pin-content" id="pinnedMessageText">No pinned message</span>
                    <i class="ri-close-line pin-close" onclick="event.stopPropagation(); unpinMessage()"></i>
                </div>
                
                <!-- Chat Content Area -->
                <div class="chat-content" id="main-chat-content">
                    <ul class="list-unstyled" id="chat-messages-ul">
                        <!-- Default "No Chat Selected" State -->
                        <li class="chat-item-start" style="width: 100%; height: 100%; margin: 0;">
                            <div class="empty-chat-placeholder">
                                <span class="avatar avatar-xxl avatar-rounded bg-light text-primary mb-3">
                                    <i class="ri-chat-smile-2-line fs-1"></i>
                                </span>
                                <h5 class="fw-medium mb-1">Welcome to Job Ecosystem</h5>
                                <p class="text-muted mb-3">Select a conversation from the left to start messaging.</p>

                            </div>
                        </li>
                    </ul>
                </div>

                <div class="chat-footer" id="main-chat-footer" style="display: none;">
                    <input type="file" id="chat-file-input" style="display: none;">
                    
                    <div class="emoji-picker-container" id="main-emoji-picker" style="display: none; position: absolute; bottom: 80px; left: 20px; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 300px; height: 300px; overflow-y: auto; z-index: 100; padding: 10px;">
                        <!-- Emojis will be loaded here -->
                        <div class="d-flex flex-wrap gap-2" id="emoji-list"></div>
                    </div>

                    <a aria-label="anchor" class="btn btn-success-light me-2 btn-icon btn-send" href="javascript:void(0)" onclick="document.getElementById('chat-file-input').click()">
                        <i class="ri-attachment-2"></i>
                    </a>
                    <a aria-label="anchor" class="btn btn-icon me-2 btn-info emoji-picker" href="javascript:void(0)" onclick="toggleEmojiPicker()">
                        <i class="ri-emotion-line"></i>
                    </a>
                    <a aria-label="anchor" class="btn btn-icon me-2 btn-warning-light voice-note-btn" href="javascript:void(0)" id="btn-voice-note">
                        <i class="ri-mic-line"></i>
                    </a>
                    <input class="form-control chat-message-space" id="chat-input" placeholder="Type your message here..." type="text">
                    <a aria-label="anchor" class="btn btn-primary ms-2 btn-icon btn-send" href="javascript:void(0)" onclick="sendMessage()">
                        <i class="ri-send-plane-2-line"></i>
                    </a>
                </div>
            </div>
            
        </div>

        <!-- Start::chat user details offcanvas -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight">
            <div class="offcanvas-body">
                <button type="button" class="btn btn-sm btn-icon btn-outline-light border" data-bs-dismiss="offcanvas" aria-label="Close"><i class="ri-close-line lh-1 align-center"></i></button>
                <div class="chat-user-details" id="chat-user-details">
                    <div class="text-center mb-4">
                        <span class="avatar avatar-rounded online avatar-xxl me-2 mb-3 chatstatusperson">
                            <img class="chatimageperson" src="" alt="img">
                        </span>
                        <p class="mb-1 fs-15 fw-medium text-dark lh-1 chatnameperson">Select User</p>
                        <p class="fs-12 text-muted chatpersonemail"></p>
                        <p class="text-center mb-0 d-flex gap-2 flex-wrap">
                            <button type="button" aria-label="button" class="btn btn-primary-light btn-wave flex-fill waves-effect waves-light"><i class="ri-phone-line me-2 align-middle"></i>Call</button>
                            <button type="button" aria-label="button" class="btn btn-success-light btn-wave flex-fill waves-effect waves-light"><i class="ri-video-add-line me-2 align-middle"></i>Video Call</button>
                            <button type="button" aria-label="button" class="btn btn-info-light btn-wave flex-fill waves-effect waves-light"><i class="ri-chat-1-line me-2 align-middle"></i>Message</button>
                        </p>
                    </div>
                    <div class="mb-4 pt-2">
                        <div class="fw-medium mb-4">Shared Files
                            <span class="badge bg-info ms-1 rounded-pill">0</span>
                            <span class="float-end fs-11"><a href="javascript:void(0);" class="fs-12 text-muted"> View All<i class="ti ti-arrow-narrow-right ms-1"></i> </a></span>
                        </div>
                        <ul class="shared-files list-unstyled">
                            <li class="text-center text-muted">No shared files</li>
                        </ul>
                    </div>
                    <div class="mb-0 pt-2">
                        <div class="fw-medium mb-4">Photos &amp; Media
                            <span class="badge bg-secondary ms-1 rounded-pill">0</span>
                            <span class="float-end fs-11"><a href="javascript:void(0);" class="fs-12 text-muted"> View All<i class="ti ti-arrow-narrow-right ms-1"></i> </a></span>
                        </div>
                        <div class="row gy-3">
                            <div class="col-12 text-center text-muted">No media</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End::chat user details offcanvas -->

    </div>
</div>

<!-- Message Context Menu (WhatsApp Style) -->
<div class="message-context-menu" id="messageContextMenu">
    <div class="context-menu-drag-handle" id="contextMenuDragHandle"><i class="ri-drag-move-2-fill"></i></div>
    <div class="context-reactions">
        <span onclick="addReactionFromMenu('👍')">👍</span>
        <span onclick="addReactionFromMenu('❤️')">❤️</span>
        <span onclick="addReactionFromMenu('😂')">😂</span>
        <span onclick="addReactionFromMenu('😮')">😮</span>
        <span onclick="addReactionFromMenu('😢')">😢</span>
        <span onclick="addReactionFromMenu('🙏')">🙏</span>
        <span class="more-emoji" onclick="showEmojiPicker()">+</span>
    </div>
    <div class="context-menu-item" onclick="replyToMessage()">
        <i class="ri-reply-line"></i> Reply
    </div>
    <div class="context-menu-item" onclick="copyMessage()">
        <i class="ri-file-copy-line"></i> Copy
    </div>
    <div class="context-menu-item" onclick="forwardMessage()">
        <i class="ri-share-forward-line"></i> Forward
    </div>
    <div class="context-menu-item" onclick="pinMessage()">
        <i class="ri-pushpin-line"></i> Pin
    </div>
    <div class="context-menu-item" onclick="starMessage()">
        <i class="ri-star-line"></i> Star
    </div>
    <div class="context-menu-item" onclick="editMessage()" id="ctx-edit-btn">
        <i class="ri-pencil-line"></i> Edit
    </div>
    <div class="context-menu-item danger" onclick="deleteMessage()">
        <i class="ri-delete-bin-line"></i> Delete
    </div>
</div>

<!-- Reaction Emoji Picker Overlay -->
<div class="reaction-picker-overlay" id="reactionPickerOverlay" onclick="closeReactionPicker()"></div>

<!-- Reaction Emoji Picker - Redesigned -->
<div class="reaction-emoji-picker" id="reactionEmojiPicker">
    <div class="reaction-picker-header" id="reactionPickerDragHandle">
        <span>Choose Reaction</span>
        <i class="ri-close-line" onclick="closeReactionPicker()"></i>
    </div>
    <div class="reaction-picker-search">
        <i class="ri-search-line"></i>
        <input type="text" id="reactionSearch" placeholder="Search emoji..." oninput="filterReactionEmojis(this.value)">
    </div>
    <div class="reaction-picker-grid" id="reactionGrid">
        <!-- SMILEYS -->
        <div class="reaction-category">Smileys</div>
        <span onclick="selectReactionEmoji('😀')">😀</span><span onclick="selectReactionEmoji('😃')">😃</span><span onclick="selectReactionEmoji('😄')">😄</span><span onclick="selectReactionEmoji('😁')">😁</span><span onclick="selectReactionEmoji('😆')">😆</span><span onclick="selectReactionEmoji('😅')">😅</span>
        <span onclick="selectReactionEmoji('😂')">😂</span><span onclick="selectReactionEmoji('🤣')">🤣</span><span onclick="selectReactionEmoji('😊')">😊</span><span onclick="selectReactionEmoji('😇')">😇</span><span onclick="selectReactionEmoji('🙂')">🙂</span><span onclick="selectReactionEmoji('🙃')">🙃</span>
        <span onclick="selectReactionEmoji('😉')">😉</span><span onclick="selectReactionEmoji('😍')">😍</span><span onclick="selectReactionEmoji('🥰')">🥰</span><span onclick="selectReactionEmoji('😘')">😘</span><span onclick="selectReactionEmoji('😗')">😗</span><span onclick="selectReactionEmoji('😚')">😚</span>
        <span onclick="selectReactionEmoji('😋')">😋</span><span onclick="selectReactionEmoji('😛')">😛</span><span onclick="selectReactionEmoji('😜')">😜</span><span onclick="selectReactionEmoji('🤪')">🤪</span><span onclick="selectReactionEmoji('😎')">😎</span><span onclick="selectReactionEmoji('🤩')">🤩</span>
        <span onclick="selectReactionEmoji('🥳')">🥳</span><span onclick="selectReactionEmoji('😏')">😏</span><span onclick="selectReactionEmoji('😒')">😒</span><span onclick="selectReactionEmoji('🙄')">🙄</span><span onclick="selectReactionEmoji('😬')">😬</span><span onclick="selectReactionEmoji('🤗')">🤗</span>
        <span onclick="selectReactionEmoji('🤔')">🤔</span><span onclick="selectReactionEmoji('🤫')">🤫</span><span onclick="selectReactionEmoji('🤭')">🤭</span><span onclick="selectReactionEmoji('🤥')">🤥</span><span onclick="selectReactionEmoji('😌')">😌</span><span onclick="selectReactionEmoji('😔')">😔</span>
        <span onclick="selectReactionEmoji('😪')">😪</span><span onclick="selectReactionEmoji('🤤')">🤤</span><span onclick="selectReactionEmoji('😴')">😴</span><span onclick="selectReactionEmoji('😷')">😷</span><span onclick="selectReactionEmoji('🤒')">🤒</span><span onclick="selectReactionEmoji('🤕')">🤕</span>
        <span onclick="selectReactionEmoji('🤢')">🤢</span><span onclick="selectReactionEmoji('🤮')">🤮</span><span onclick="selectReactionEmoji('🥴')">🥴</span><span onclick="selectReactionEmoji('😵')">😵</span><span onclick="selectReactionEmoji('🤯')">🤯</span><span onclick="selectReactionEmoji('🤠')">🤠</span>
        <span onclick="selectReactionEmoji('😈')">😈</span><span onclick="selectReactionEmoji('👿')">👿</span><span onclick="selectReactionEmoji('👹')">👹</span><span onclick="selectReactionEmoji('👺')">👺</span><span onclick="selectReactionEmoji('💀')">💀</span><span onclick="selectReactionEmoji('👻')">👻</span>
        <span onclick="selectReactionEmoji('👽')">👽</span><span onclick="selectReactionEmoji('🤖')">🤖</span><span onclick="selectReactionEmoji('💩')">💩</span><span onclick="selectReactionEmoji('😺')">😺</span><span onclick="selectReactionEmoji('😸')">😸</span><span onclick="selectReactionEmoji('😹')">😹</span>
        <!-- GESTURES -->
        <div class="reaction-category">Gestures</div>
        <span onclick="selectReactionEmoji('👍')">👍</span><span onclick="selectReactionEmoji('👎')">👎</span><span onclick="selectReactionEmoji('👊')">👊</span><span onclick="selectReactionEmoji('✊')">✊</span><span onclick="selectReactionEmoji('🤛')">🤛</span><span onclick="selectReactionEmoji('🤜')">🤜</span>
        <span onclick="selectReactionEmoji('🤞')">🤞</span><span onclick="selectReactionEmoji('✌️')">✌️</span><span onclick="selectReactionEmoji('🤟')">🤟</span><span onclick="selectReactionEmoji('🤘')">🤘</span><span onclick="selectReactionEmoji('👌')">👌</span><span onclick="selectReactionEmoji('🤌')">🤌</span>
        <span onclick="selectReactionEmoji('👈')">👈</span><span onclick="selectReactionEmoji('👉')">👉</span><span onclick="selectReactionEmoji('👆')">👆</span><span onclick="selectReactionEmoji('👇')">👇</span><span onclick="selectReactionEmoji('☝️')">☝️</span><span onclick="selectReactionEmoji('✋')">✋</span>
        <span onclick="selectReactionEmoji('🤚')">🤚</span><span onclick="selectReactionEmoji('🖐️')">🖐️</span><span onclick="selectReactionEmoji('🖖')">🖖</span><span onclick="selectReactionEmoji('👋')">👋</span><span onclick="selectReactionEmoji('🤙')">🤙</span><span onclick="selectReactionEmoji('💪')">💪</span>
        <span onclick="selectReactionEmoji('🙏')">🙏</span><span onclick="selectReactionEmoji('🤝')">🤝</span><span onclick="selectReactionEmoji('👏')">👏</span><span onclick="selectReactionEmoji('🙌')">🙌</span><span onclick="selectReactionEmoji('👐')">👐</span><span onclick="selectReactionEmoji('✍️')">✍️</span>
        <!-- HEARTS -->
        <div class="reaction-category">Hearts & Love</div>
        <span onclick="selectReactionEmoji('❤️')">❤️</span><span onclick="selectReactionEmoji('🧡')">🧡</span><span onclick="selectReactionEmoji('💛')">💛</span><span onclick="selectReactionEmoji('💚')">💚</span><span onclick="selectReactionEmoji('💙')">💙</span><span onclick="selectReactionEmoji('💜')">💜</span>
        <span onclick="selectReactionEmoji('🖤')">🖤</span><span onclick="selectReactionEmoji('🤍')">🤍</span><span onclick="selectReactionEmoji('🤎')">🤎</span><span onclick="selectReactionEmoji('💔')">💔</span><span onclick="selectReactionEmoji('❣️')">❣️</span><span onclick="selectReactionEmoji('💕')">💕</span>
        <span onclick="selectReactionEmoji('💞')">💞</span><span onclick="selectReactionEmoji('💓')">💓</span><span onclick="selectReactionEmoji('💗')">💗</span><span onclick="selectReactionEmoji('💖')">💖</span><span onclick="selectReactionEmoji('💘')">💘</span><span onclick="selectReactionEmoji('💝')">💝</span>
        <span onclick="selectReactionEmoji('😍')">😍</span><span onclick="selectReactionEmoji('🥰')">🥰</span><span onclick="selectReactionEmoji('😘')">😘</span><span onclick="selectReactionEmoji('💋')">💋</span><span onclick="selectReactionEmoji('💏')">💏</span><span onclick="selectReactionEmoji('💑')">💑</span>
        <!-- SYMBOLS -->
        <div class="reaction-category">Symbols & Objects</div>
        <span onclick="selectReactionEmoji('🔥')">🔥</span><span onclick="selectReactionEmoji('⭐')">⭐</span><span onclick="selectReactionEmoji('🌟')">🌟</span><span onclick="selectReactionEmoji('✨')">✨</span><span onclick="selectReactionEmoji('💫')">💫</span><span onclick="selectReactionEmoji('⚡')">⚡</span>
        <span onclick="selectReactionEmoji('💯')">💯</span><span onclick="selectReactionEmoji('✅')">✅</span><span onclick="selectReactionEmoji('❌')">❌</span><span onclick="selectReactionEmoji('❓')">❓</span><span onclick="selectReactionEmoji('❗')">❗</span><span onclick="selectReactionEmoji('💢')">💢</span>
        <span onclick="selectReactionEmoji('🎉')">🎉</span><span onclick="selectReactionEmoji('🎊')">🎊</span><span onclick="selectReactionEmoji('🎁')">🎁</span><span onclick="selectReactionEmoji('🏆')">🏆</span><span onclick="selectReactionEmoji('🥇')">🥇</span><span onclick="selectReactionEmoji('🎯')">🎯</span>
        <span onclick="selectReactionEmoji('💡')">💡</span><span onclick="selectReactionEmoji('💰')">💰</span><span onclick="selectReactionEmoji('💎')">💎</span><span onclick="selectReactionEmoji('🎵')">🎵</span><span onclick="selectReactionEmoji('🎶')">🎶</span><span onclick="selectReactionEmoji('🔔')">🔔</span>
        <span onclick="selectReactionEmoji('📌')">📌</span><span onclick="selectReactionEmoji('📍')">📍</span><span onclick="selectReactionEmoji('📎')">📎</span><span onclick="selectReactionEmoji('✏️')">✏️</span><span onclick="selectReactionEmoji('📝')">📝</span><span onclick="selectReactionEmoji('📅')">📅</span>
        <!-- ANIMALS -->
        <div class="reaction-category">Animals & Nature</div>
        <span onclick="selectReactionEmoji('🐶')">🐶</span><span onclick="selectReactionEmoji('🐱')">🐱</span><span onclick="selectReactionEmoji('🐭')">🐭</span><span onclick="selectReactionEmoji('🐹')">🐹</span><span onclick="selectReactionEmoji('🐰')">🐰</span><span onclick="selectReactionEmoji('🦊')">🦊</span>
        <span onclick="selectReactionEmoji('🐻')">🐻</span><span onclick="selectReactionEmoji('🐼')">🐼</span><span onclick="selectReactionEmoji('🐨')">🐨</span><span onclick="selectReactionEmoji('🐯')">🐯</span><span onclick="selectReactionEmoji('🦁')">🦁</span><span onclick="selectReactionEmoji('🐮')">🐮</span>
        <span onclick="selectReactionEmoji('🐷')">🐷</span><span onclick="selectReactionEmoji('🐸')">🐸</span><span onclick="selectReactionEmoji('🐵')">🐵</span><span onclick="selectReactionEmoji('🐔')">🐔</span><span onclick="selectReactionEmoji('🐧')">🐧</span><span onclick="selectReactionEmoji('🐦')">🐦</span>
        <span onclick="selectReactionEmoji('🦋')">🦋</span><span onclick="selectReactionEmoji('🌸')">🌸</span><span onclick="selectReactionEmoji('🌹')">🌹</span><span onclick="selectReactionEmoji('🌺')">🌺</span><span onclick="selectReactionEmoji('🌻')">🌻</span><span onclick="selectReactionEmoji('🌼')">🌼</span>
        <span onclick="selectReactionEmoji('🌈')">🌈</span><span onclick="selectReactionEmoji('☀️')">☀️</span><span onclick="selectReactionEmoji('🌙')">🌙</span><span onclick="selectReactionEmoji('⛅')">⛅</span><span onclick="selectReactionEmoji('🌧️')">🌧️</span><span onclick="selectReactionEmoji('❄️')">❄️</span>
        <!-- FOOD -->
        <div class="reaction-category">Food & Drink</div>
        <span onclick="selectReactionEmoji('🍎')">🍎</span><span onclick="selectReactionEmoji('🍊')">🍊</span><span onclick="selectReactionEmoji('🍋')">🍋</span><span onclick="selectReactionEmoji('🍌')">🍌</span><span onclick="selectReactionEmoji('🍉')">🍉</span><span onclick="selectReactionEmoji('🍇')">🍇</span>
        <span onclick="selectReactionEmoji('🍓')">🍓</span><span onclick="selectReactionEmoji('🍒')">🍒</span><span onclick="selectReactionEmoji('🍑')">🍑</span><span onclick="selectReactionEmoji('🥑')">🥑</span><span onclick="selectReactionEmoji('🍔')">🍔</span><span onclick="selectReactionEmoji('🍕')">🍕</span>
        <span onclick="selectReactionEmoji('🌮')">🌮</span><span onclick="selectReactionEmoji('🍿')">🍿</span><span onclick="selectReactionEmoji('🍩')">🍩</span><span onclick="selectReactionEmoji('🍪')">🍪</span><span onclick="selectReactionEmoji('🎂')">🎂</span><span onclick="selectReactionEmoji('🍰')">🍰</span>
        <span onclick="selectReactionEmoji('☕')">☕</span><span onclick="selectReactionEmoji('🍵')">🍵</span><span onclick="selectReactionEmoji('🍺')">🍺</span><span onclick="selectReactionEmoji('🍷')">🍷</span><span onclick="selectReactionEmoji('🍸')">🍸</span><span onclick="selectReactionEmoji('🥤')">🥤</span>
    </div>
</div>

<style>
    /* Reaction Picker Overlay - prevents page scroll */
    .reaction-picker-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.25s ease, visibility 0.25s ease;
    }
    .reaction-picker-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    
    .reaction-emoji-picker {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        width: 90%;
        max-width: 380px;
        max-height: 70vh;
        min-height: 300px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.25s ease, transform 0.25s ease, visibility 0.25s ease;
    }
    .reaction-emoji-picker.show {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }
    
    /* Header */
    .reaction-picker-header {
        padding: 16px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #333;
        font-weight: 600;
        font-size: 16px;
        flex-shrink: 0;
        cursor: grab;
    }
    .reaction-picker-header:active { cursor: grabbing; }
    .reaction-picker-header i {
        cursor: pointer;
        font-size: 20px;
        color: #666;
        transition: color 0.15s;
    }
    .reaction-picker-header i:hover { color: #333; }
    
    /* Search bar */
    .reaction-picker-search {
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }
    .reaction-picker-search i {
        color: #999;
        font-size: 16px;
    }
    .reaction-picker-search input {
        flex: 1;
        border: none;
        outline: none;
        font-size: 14px;
        background: transparent;
        color: #333;
    }
    .reaction-picker-search input::placeholder { color: #aaa; }
    
    /* Emoji grid */
    .reaction-picker-grid {
        padding: 12px 16px;
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 4px;
        overflow-y: auto;
        flex: 1;
        touch-action: pan-y; /* Allow vertical scroll on touch */
        -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
    }
    .reaction-picker-grid span {
        font-size: 28px;
        text-align: center;
        cursor: pointer;
        padding: 8px 4px;
        border-radius: 10px;
        transition: transform 0.1s, background 0.15s;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .reaction-picker-grid span:hover {
        background: rgba(139, 92, 246, 0.15);
        transform: scale(1.1);
    }
    
    /* Category */
    .reaction-category {
        grid-column: 1 / -1;
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        padding: 12px 0 6px;
        margin-top: 4px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    .reaction-category:first-child { margin-top: 0; padding-top: 4px; }
    
    /* Dark mode */
    [data-theme-mode="dark"] .reaction-emoji-picker,
    .dark .reaction-emoji-picker,
    html[data-theme="dark"] .reaction-emoji-picker {
        background: #1e1e2e;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    [data-theme-mode="dark"] .reaction-picker-header,
    .dark .reaction-picker-header,
    html[data-theme="dark"] .reaction-picker-header {
        color: #fff;
        border-bottom-color: rgba(255,255,255,0.1);
    }
    [data-theme-mode="dark"] .reaction-picker-header i,
    .dark .reaction-picker-header i,
    html[data-theme="dark"] .reaction-picker-header i { color: #aaa; }
    [data-theme-mode="dark"] .reaction-picker-search,
    .dark .reaction-picker-search,
    html[data-theme="dark"] .reaction-picker-search { border-bottom-color: rgba(255,255,255,0.1); }
    [data-theme-mode="dark"] .reaction-picker-search input,
    .dark .reaction-picker-search input,
    html[data-theme="dark"] .reaction-picker-search input { color: #fff; }
    [data-theme-mode="dark"] .reaction-category,
    .dark .reaction-category,
    html[data-theme="dark"] .reaction-category { color: #888; }
    
    /* Responsive - mobile */
    @media (max-width: 768px) {
        .reaction-emoji-picker {
            width: 280px;
            max-width: 85%;
            max-height: 55vh;
            border-radius: 12px;
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) scale(0.9);
            z-index: 99999 !important;
        }
        .reaction-emoji-picker.show {
            transform: translate(-50%, -50%) scale(1);
        }
        .reaction-picker-overlay {
            z-index: 99998 !important;
        }
        .reaction-picker-header {
            cursor: default; /* Disable drag cursor on mobile */
            padding: 12px 14px;
            font-size: 14px;
        }
        .reaction-picker-grid {
            grid-template-columns: repeat(5, 1fr);
            padding: 8px 12px;
        }
        .reaction-picker-grid span {
            font-size: 22px;
            padding: 4px;
        }
        .reaction-picker-search {
            padding: 8px 12px;
        }
        .reaction-picker-search input {
            font-size: 13px;
        }
        .reaction-category {
            font-size: 10px;
            padding: 8px 0 4px;
        }
    }
    
    @media (max-width: 400px) {
        .reaction-emoji-picker {
            width: 260px;
            max-height: 50vh;
        }
        .reaction-picker-grid {
            grid-template-columns: repeat(4, 1fr);
        }
        .reaction-picker-grid span {
            font-size: 20px;
        }
    }
    
    /* Light mode context menu + button */
    [data-theme-mode="light"] .context-reactions .more-emoji,
    .light .context-reactions .more-emoji {
        background: rgba(0,0,0,0.08);
        color: #666;
    }
</style>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Group Name</label>
                    <input type="text" class="form-control" id="new-group-name" placeholder="Enter group name">
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Members</label>
                    <div class="list-group" id="group-creation-members" style="max-height: 200px; overflow-y: auto;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>
</div>
<!-- Group Info Modal -->
<div class="modal fade" id="groupInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="group-info-name">Group Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold">Members</h6>
                <ul class="list-group mb-3" id="group-info-members" style="max-height: 200px; overflow-y: auto;">
                    <!-- Dynamic -->
                </ul>

                <hr>
                <h6 class="fw-bold">Add Member</h6>
                <div class="input-group mb-3">
                    <select class="form-select" id="group-add-member-select">
                        <option value="">Select user...</option>
                        <!-- Populated from contacts -->
                    </select>
                    <button class="btn btn-outline-secondary" type="button" onclick="addGroupMember()">Add</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger text-white" onclick="leaveCurrentGroup()">Leave Group</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<%- include('includes/footer2') %>

<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
    // ================== INITIALIZATION ==================
    const socket = io();
    window.socket = socket; // Expose globally for call logic
    let currentUserId = null;
    let currentChatType = 'private'; // 'private' or 'group'
    let currentChatId = null;
    let currentChatName = '';
    let currentChatAvatar = '';
    // let currentChatAvatar = '';
    let allContacts = [];
    let allGroups = [];

    // DOM Elements
    const msgInput = document.querySelector('.chat-message-space');
    const msgContainer = document.getElementById('chat-messages-ul'); // Stable ID selector
    
    // Updated: msgScrollArea now points directly to the container since we removed SimpleBar
    const msgScrollArea = document.getElementById('main-chat-content');
    
    // Tab content containers - with fallbacks
    function getTabContainer(selectorId) {
        const simpleContent = document.querySelector(`${selectorId} .simplebar-content`);
        if(simpleContent) return simpleContent;
        // Fallback: the element itself if simplebar hasn't wrapped it yet
        return document.querySelector(selectorId);
    }

    const recentTabContent = getTabContainer('#chat-msg-scroll');
    const groupsTabContent = getTabContainer('#groups-tab-pane');
    const contactsTabContent = getTabContainer('#contacts-tab-pane');

    // Init on page load
    document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem('token');
        
        const userStr = localStorage.getItem('user');
        if(userStr) {
            const user = JSON.parse(userStr);
            currentUserId = user.id;
            socket.emit('join', currentUserId);
        }
        
        // Re-grab containers - target UL elements directly
        const recentEl = document.querySelector('#chat-msg-scroll .simplebar-content') || document.querySelector('#chat-msg-scroll');
        const groupsUl = document.querySelector('#groups-tab-pane ul');
        const contactsUl = document.querySelector('#contacts-tab-pane ul');
        
        
        // Initial Loading State with Skeletons
        const skeletonHTML = `
            <li class="p-3">
                <div class="d-flex align-items-top">
                    <div class="me-2">
                        <span class="skeleton-box skeleton-avatar"></span>
                    </div>
                    <div class="flex-fill">
                        <div class="skeleton-box skeleton-text" style="width: 60%"></div>
                        <div class="skeleton-box skeleton-text" style="width: 40%"></div>
                    </div>
                </div>
            </li>
            <li class="p-3">
                <div class="d-flex align-items-top">
                    <div class="me-2">
                        <span class="skeleton-box skeleton-avatar"></span>
                    </div>
                    <div class="flex-fill">
                        <div class="skeleton-box skeleton-text" style="width: 50%"></div>
                        <div class="skeleton-box skeleton-text" style="width: 30%"></div>
                    </div>
                </div>
            </li>
        `;
        if(recentEl) recentEl.innerHTML = skeletonHTML;
        if(groupsUl) groupsUl.innerHTML = skeletonHTML;
        if(contactsUl) contactsUl.innerHTML = skeletonHTML;

        
        // Load all tabs
        await Promise.all([
            loadRecentChats(),
            loadGroups(),
            loadContacts()
        ]);
        
        // Check if we should auto-open a chat (e.g., from "Message Candidate" button)
        const openChatWith = sessionStorage.getItem('openChatWith');
        if(openChatWith) {
            try {
                const chatData = JSON.parse(openChatWith);
                sessionStorage.removeItem('openChatWith'); // Clear it so it doesn't keep opening
                
                // Auto-select the user
                if(chatData.userId) {
                    await selectUser(chatData.userId, chatData.name, chatData.avatar, 'offline');
                }
            } catch(e) {
                console.error('Failed to parse openChatWith:', e);
            }
        }
        
    });

    // ================== SOCKET EVENTS ==================
    socket.on('connect', () => {
        console.log("Socket connected:", socket.id);
    });
    
    socket.on('connect_error', (err) => {
        console.error("Socket connection error:", err);
    });

    socket.on('receive_message', (payload) => {
        console.log("Received message:", payload);
        const isCurrentChat = (currentChatType === 'private' && currentChatId == payload.sender_id) || 
                              (currentChatType === 'group' && currentChatId == payload.group_id) ||
                              (currentChatType === 'channel' && currentChatId == payload.channel_id);

        // 1. Handle Active Chat Window
        if (isCurrentChat) {
            if (currentChatType === 'group' && payload.sender_id == currentUserId) {
                // Ignore own messages
            } else {
                appendMessage(payload.message, 'received', payload.sender_name, payload.sender_avatar, payload.createdAt, payload.id);
                scrollToBottom();
                if(document.hasFocus()) {
                    markMessagesRead(currentChatId, currentChatType);
                }
            }
        } else {
            // Real-time Notification Toast
            if(typeof Toastify !== 'undefined') {
                let msg = `New message from ${payload.sender_name || 'Chat'}`;
                if(payload.type === 'group') msg = `New message in Group from ${payload.sender_name}`;
                if(payload.type === 'channel') msg = `New message in Channel from ${payload.sender_name}`;
                
                Toastify({ 
                    text: msg, 
                    backgroundColor: "#00b074", 
                    duration: 4000, 
                    close: true, 
                    gravity: "top", 
                    position: "right", 
                    stopOnFocus: true,
                    onClick: function() { 
                        // Optional: Navigate to chat logic could go here
                    } 
                }).showToast();
            }
        }

        // 2. OPTIMISTIC UI UPDATE (Instant Sidebar Update)
        const chatList = document.querySelector('#chat-msg-scroll .simplebar-content') || document.querySelector('#chat-msg-scroll');
        if (chatList) {
            // Find existing list item
            const partnerId = currentChatType === 'group' ? payload.group_id : payload.sender_id;
            let existingItem = chatList.querySelector(`li[data-id="${partnerId}"]`);

            if (existingItem) {
                // Move to top (but AFTER the "Recent Chats" header)
                const headerItem = chatList.querySelector('li.pb-0'); // The header li
                if (headerItem) {
                    headerItem.insertAdjacentElement('afterend', existingItem);
                } else {
                    chatList.prepend(existingItem);
                }
                
                // Update Text & Time
                const msgTextEl = existingItem.querySelector('.chat-msg');
                const timeEl = existingItem.querySelector('.float-end.text-muted'); // Time element
                
                let previewText = payload.message;
                if(payload.sender_id == currentUserId) {
                    previewText = 'You: ' + payload.message;
                } else if (payload.type === 'group' || payload.type === 'channel') {
                    previewText = (payload.sender_name || 'User') + ': ' + payload.message;
                }
                
                if (msgTextEl) msgTextEl.textContent = previewText;
                if (timeEl) timeEl.textContent = 'Just now'; // Or format payload.createdAt
                
                // Handle Unread Badge/Dot
                const unreadContainer = existingItem.querySelector('.unread-dot-container, .badge');
                
                if (isCurrentChat && document.hasFocus()) {
                    // If viewing, remove any badge/dot immediately
                    if (unreadContainer) unreadContainer.remove();
                } else {
                    // If NOT viewing, add/update badge
                    // This is complex to increment locally without current count, 
                    // so we'll rely on the Dot logic (show it if missing)
                    // or just let the fallback fetch handle the count.
                    // For now, at least show the DOT if nothing is there.
                    const pContainer = existingItem.querySelector('p.fs-12');
                    if (!unreadContainer && pContainer) {
                         pContainer.insertAdjacentHTML('beforeend', `<span class="unread-dot-container float-end"><span class="unread-dot"></span></span>`);
                    }
                }
            }
        }

        // 3. Fallback / Full Sync (Reduced Delay)
        setTimeout(() => {
            loadRecentChats();
            if(typeof fetchUnreadCount === 'function') fetchUnreadCount();
        }, 200); // reduced to 200ms for snappier feel
    });

    socket.on('user_status', ({ userId, status }) => {
        console.log(`User ${userId} is ${status}`);
        
        // 1. Update List Status (Optimistic)
        const chatList = document.querySelector('#chat-msg-scroll .simplebar-content') || document.querySelector('#chat-msg-scroll');
        if (chatList) {
             const existingItem = chatList.querySelector(`li[data-id="${userId}"]`);
             if(existingItem) {
                 const statusSpan = existingItem.querySelector('.avatar-status-component');
                 if(statusSpan) {
                     statusSpan.className = `avatar-status-component avatar-status-${status === 'online' ? 'online' : 'offline'}`;
                 }
             }
        }

        // 2. Update Header if Active
        if (currentChatType === 'private' && currentChatId == userId) {
            updateChatHeader(currentChatName, currentChatAvatar, status);
        }
    });

    // ================== REAL-TIME MESSAGE UPDATES ==================
    socket.on('message_updated', (data) => {
        const li = document.querySelector(`li[data-message-id="${data.id}"]`);
        if(li) {
            const p = li.querySelector('.main-chat-msg p');
            if(p) p.textContent = data.message;
            
            // Add (edited) flag if not present
            const meta = li.querySelector('.chatting-user-info');
            if(meta && !meta.innerText.includes('(edited)')) {
                 const editSpan = document.createElement('span');
                 editSpan.className = 'text-muted fst-italic ms-1 unique-edit-tag';
                 editSpan.style.fontSize = '0.75rem';
                 editSpan.innerText = '(edited)';
                 meta.prepend(editSpan);
            }
        }
    });

    socket.on('message_deleted', (data) => {
        const li = document.querySelector(`li[data-message-id="${data.id}"]`);
        if(li) {
            const p = li.querySelector('.main-chat-msg p');
            if(p) {
                p.innerHTML = '<em class="text-muted">This message was deleted</em>';
            }
            // Remove actions/reactions
            const reactions = li.querySelector('.message-reactions');
            if(reactions) reactions.remove();
        }
    });

    socket.on('reaction_updated', (data) => {
        const li = document.querySelector(`li[data-message-id="${data.messageId}"]`);
        if(li) {
             let reactionContainer = li.querySelector('.message-reactions');
             const hasReactions = data.reactions && Object.keys(data.reactions).length > 0;
             
             if(reactionContainer) {
                 if(!hasReactions) {
                     reactionContainer.remove();
                 } else {
                     refreshReactions(reactionContainer, data.reactions);
                 }
             } else if(hasReactions) {
                 // Create container
                 const mainDiv = li.querySelector('.ms-3') || li.querySelector('.me-3');
                 if(mainDiv) {
                    reactionContainer = document.createElement('div');
                    reactionContainer.className = 'message-reactions';
                    const mainMsg = mainDiv.querySelector('.main-chat-msg');
                    if(mainMsg) mainMsg.insertAdjacentElement('afterend', reactionContainer);
                    refreshReactions(reactionContainer, data.reactions);
                 }
             }
        }
    });
    
    function refreshReactions(container, reactions) {
         const reactionEntries = Object.entries(reactions);
         container.innerHTML = reactionEntries.map(([emoji, users]) => 
            `<span class="reaction-badge" title="${users.length} reaction(s)">${emoji}${users.length > 1 ? ' ' + users.length : ''}</span>`
         ).join('');
    }

    // ================== SELECT USER/GROUP ==================
    window.selectUser = async function(userId, name, avatar, status) { 
        console.log("Selected User:", userId, name);
        currentChatType = 'private';
        currentChatId = userId;
        
        // EXPOSE TO GLOBAL SCOPE for header2.ejs updates
        window.currentChatId = userId; 

        currentChatName = name;
        currentChatAvatar = avatar;
        
        updateChatHeader(name, avatar, status);
        updateActiveState(userId);
        showMobileChat(); 
        document.getElementById('main-chat-footer').style.display = 'flex'; 
        await loadChatHistory(userId, 'private');
        
        // Mark messages as read
        markMessagesRead(userId, 'private');
        
        // Verify container exists before appending
        if(!msgContainer) msgContainer = document.querySelector('#main-chat-content ul');
        
        // Update Sidebar
        updateSidebarInfo(userId, name, avatar, 'private');
    };

    // [NEW] Robust Header Update Function
    window.updateChatHeader = function(name, avatar, status) {
        const header = document.getElementById('main-chat-header');
        if(!header) return;
        
        header.style.display = 'flex';
        
        // Update Name
        const nameEl = header.querySelector('.chatnameperson');
        if(nameEl) nameEl.textContent = name;
        
        // Update Status
        const statusEl = header.querySelector('.chatpersonstatus');
        if(statusEl) statusEl.textContent = status === 'online' ? 'online' : 'offline';
        
        // Update Avatar
        const avatarEl = header.querySelector('.chatimageperson');
        if(avatarEl) {
            // Handle both relative and absolute paths
            let src = avatar || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg';
            // If it's a relative path starting with /uploads, it's good as is
            avatarEl.src = src;
            avatarEl.onerror = function() {
                this.src = 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg';
                this.onerror = null;
            };
        }
        
        // Update Status Dot on Avatar Wrapper
        const avatarWrapper = header.querySelector('.avatar');
        if(avatarWrapper) {
            if(status === 'online') avatarWrapper.classList.add('online');
            else avatarWrapper.classList.remove('online');
        }
    };

    window.selectGroup = async function(arg1, arg2) {
        let groupId, name;
        if(typeof arg1 === 'object' && arg1.dataset) {
            groupId = arg1.dataset.id;
            name = arg1.dataset.name;
        } else {
            groupId = arg1;
            name = arg2;
        }
        
        console.log("Selected Group:", groupId, name);
        currentChatType = 'group';
        currentChatId = groupId;
        currentChatName = name;
        currentChatAvatar = 'https://laravelui.spruko.com/zeno/build/assets/images/faces/12.jpg';
        
        updateChatHeader(name, currentChatAvatar, 'Group Chat');
        socket.emit('join_group', groupId);
        updateActiveState(groupId);
        showMobileChat(); // [NEW] Show chat on mobile
        document.getElementById('main-chat-footer').style.display = 'flex'; // Show footer
        await loadChatHistory(groupId, 'group');
        
        // Mark messages as read
        markMessagesRead(groupId, 'group');
        
        
        if(!msgContainer) msgContainer = document.querySelector('#main-chat-content ul');
        
        // Update Sidebar
        updateSidebarInfo(groupId, name, null, 'group');
    };

    // Keep template's changeTheInfo for hardcoded items
    window.changeTheInfo = function(element, name, imageNumber, status) {
        const avatar = `https://laravelui.spruko.com/zeno/build/assets/images/faces/${imageNumber}.jpg`;
        updateChatHeader(name, avatar, status);
        
        document.querySelectorAll('.checkforactive').forEach(li => li.classList.remove('active'));
        if(element && element.closest) {
            const li = element.closest('li');
            if(li) li.classList.add('active');
        }
        
        // Static user - just update UI, no API call
        currentChatType = 'private';
        currentChatId = `static-${imageNumber}`;
        currentChatName = name;
        currentChatAvatar = avatar;
    };

    // ================== LOAD TAB DATA ==================
    async function loadRecentChats() {
        const token = localStorage.getItem('token');
        const container = getTabContainer('#chat-msg-scroll');
        if(!token || !container) {
             console.error("Load Recent: Missing token or container");
             return;
        }
        
        try {
            const res = await fetch('/api/chat/recent', { 
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if(!data.success) {
                console.error("Recent chats API returned false success");
                container.innerHTML = '<li class="text-center p-3 text-danger">Failed to load chats</li>';
                return;
            }
            console.log("Recent chats loaded:", data.recent.length);

            let html = '<li class="pb-0"><p class="text-muted fs-11 fw-medium mb-2 op-7">RECENT CHATS</p></li>';
            
            if(data.recent.length === 0) {
                html += '<li class="text-center p-3 text-muted">No recent conversations</li>';
            } else {
                data.recent.forEach(chat => {
                    let onclick = '';
                    let avatar = chat.avatar || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg';
                    let status = chat.is_online ? 'online' : 'offline';
                    
                    let dataAttrs = `data-id="${chat.partnerId}" data-name="${escapeHtml(chat.name)}"`;
                    
                    if (chat.type === 'group') {
                         onclick = `selectGroup(this)`;
                         status = 'online'; 
                    } else {
                         onclick = `selectUser('${chat.partnerId}', '${escapeHtml(chat.name)}', '${avatar}', '${status}')`;
                    }

                    html += `
                    <li class="checkforactive" ${dataAttrs} onclick="${onclick}" style="cursor:pointer; padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.03);">
                        <a href="javascript:void(0);" style="padding:0;">
                            <div class="d-flex align-items-top">
                                <div class="me-1 lh-1">
                                    <span class="avatar avatar-md avatar-rounded ${status} me-2">
                                        <img src="${avatar}" alt="img">
                                    </span>
                                </div>
                                <div class="flex-fill">
                                    <p class="mb-0 fw-medium">
                                        ${escapeHtml(chat.name)} <span class="float-end text-muted fw-normal fs-11">${formatTime(chat.time)}</span>
                                    </p>
                                    <p class="fs-12 mb-0">
                                        <span class="chat-msg text-truncate">${escapeHtml(chat.lastMessage)}</span>
                                        ${chat.unread == 1 ? 
                                            `<span class="unread-dot-container float-end"><span class="unread-dot"></span></span>` : 
                                          chat.unread > 1 ?
                                            `<span class="badge bg-success rounded-pill float-end fs-8">${chat.unread}</span>` : ''
                                        }
                                    </p>
                                </div>
                            </div>
                        </a>
                    </li>`;
                });
            }
            container.innerHTML = html;
            if(typeof currentChatId !== 'undefined' && currentChatId) updateActiveState(currentChatId);
        } catch(e) { 
            console.error('Error loading recent:', e); 
            container.innerHTML = '<li class="text-center p-3 text-danger">Error loading data</li>';
        }
    }

    async function loadGroups() {
        const token = localStorage.getItem('token');
        const container = document.querySelector('#groups-tab-pane ul'); 
        if(!token || !container) return;
        
        try {
            const res = await fetch('/api/chat/groups', { 
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            if(!data.success) {
                container.innerHTML = '<li class="text-center p-3 text-danger">Failed to load groups</li>';
                return;
            }

            let html = '';
            
            if(data.groups.length === 0) {
                html += '<li class="text-center p-3 text-muted">No groups yet</li>';
            } else {
                allGroups = data.groups;
                data.groups.forEach(g => {
                    const memberCount = g.members ? g.members.length : 0;
                    html += `
                    <li class="checkforactive" data-id="${g.id}" data-name="${escapeHtml(g.name)}" onclick="selectGroup(this)" style="cursor:pointer; padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.03);">
                        <div class="d-flex align-items-center justify-content-between p-2">
                            <div>
                                <p class="mb-0 fw-medium"><i class="ri-checkbox-blank-circle-fill lh-1 text-primary me-1 fs-8 align-middle"></i>${escapeHtml(g.name)}</p>
                                <p class="mb-0"><span class="badge bg-secondary-transparent">${memberCount} Members</span></p>
                            </div>
                            <div class="avatar-list-stacked my-auto">
                                ${renderMemberAvatars(g.members || [])}
                            </div>
                        </div>
                    </li>`;
                });
            }
            container.innerHTML = html;
        } catch(e) { 
            console.error('Error loading groups:', e);
            if(container) container.innerHTML = '<li class="text-center p-3 text-danger">Failed to load groups.</li>';
        }
    }

    function renderMemberAvatars(members) {
        const maxShow = 4;
        let html = '';
        members.slice(0, maxShow).forEach(m => {
            html += `<span class="avatar avatar-sm avatar-rounded"><img src="${m.profile_picture_url || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg'}" alt="img"></span>`;
        });
        if(members.length > maxShow) {
            html += `<a class="avatar avatar-sm bg-primary text-fixed-white avatar-rounded" href="javascript:void(0);">+${members.length - maxShow}</a>`;
        }
        return html;
    }

    async function loadContacts() {
        const token = localStorage.getItem('token');
        if(!token) return;
        
        const container = document.getElementById('contacts-tab-pane');
        if(!container) return;
        
        try {
            const res = await fetch('/api/chat/contacts', { 
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if(!data.success) return;
            
            // Hide Groups tab for Job Seekers
            if (data.userRole === 'job_seeker') {
                const groupsTabBtn = document.getElementById('groups-tab');
                if (groupsTabBtn) {
                    // Hide the list item containing the tab button
                    groupsTabBtn.parentElement.style.display = 'none';
                }
            }

            if(!data.contacts || data.contacts.length === 0) {
                 container.innerHTML = '<div class="text-center p-3 text-muted">No chats found</div>';
                 return;
            }

            allContacts = data.contacts;
            
            let html = '<ul class="list-unstyled mb-0 mt-2" style="height: calc(100vh - 280px); overflow-y: auto;">';
            data.contacts.forEach(u => {
                html += `
                <li onclick="selectUser('${u.id}', '${escapeHtml(u.full_name)}', '${u.profile_picture_url || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg'}', 'offline')" style="cursor:pointer; padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.03);">
                    <div class="d-flex align-items-center gap-3">
                        <div class="lh-1">
                            <span class="avatar avatar-sm">
                                <img src="${u.profile_picture_url || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg'}" alt="">
                            </span>
                        </div>
                        <div class="flex-fill">
                            <span class="d-block fw-semibold">${escapeHtml(u.full_name)}</span>
                        </div>
                    </div>
                </li>`;
            });
            html += '</ul>';
            container.innerHTML = html;
            
            // Populate group creation modal
            populateGroupModal();
        } catch(e) { 
            console.error('Error loading chats:', e); 
            if(container) container.innerHTML = '<li class="text-center p-3 text-danger">Failed to load chats. Check console.</li>';
        }
    }

    // ================== CHAT HISTORY ==================
    async function loadChatHistory(id, type) {
        const token = localStorage.getItem('token');
        if(!token || !msgContainer) return;
        
        // msgContainer.innerHTML = '<li class="text-center py-5 text-muted">Loading messages...</li>';

        
        const url = type === 'private' ? `/api/chat/history/${id}` : `/api/chat/groups/${id}/messages`;
        
        try {
            const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` }});
            const data = await res.json();
            
            msgContainer.innerHTML = '<li class="chat-day-label"><span>Today</span></li>';
            
            if(data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    const isSent = msg.sender_id === currentUserId;
                    appendMessage(msg.message, isSent ? 'sent' : 'received', msg.sender_name, msg.sender_avatar, msg.createdAt, msg.id, msg.reactions);
                });
            }
            scrollToBottom();
        } catch(e) { 
            console.error('Error loading history:', e);
            msgContainer.innerHTML = '<li class="text-center py-5 text-muted">Could not load messages</li>';
        }
    }

    // ================== SEND MESSAGE ==================
    let lastSentLi = null;
    let editingMessageId = null; // Track if we are editing
    
    async function sendMessage(attachment = null) {
        let text = msgInput.value.trim();
        if(!text && !attachment) return;

        // --- HANDLE EDIT MODE ---
        if(editingMessageId) {
             const token = localStorage.getItem('token');
             try {
                const res = await fetch(`/api/chat/message/${editingMessageId}`, {
                    method: 'PUT',
                     headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                     body: JSON.stringify({ newMessage: text })
                 });
                 if(res.ok) {
                     editingMessageId = null;
                     msgInput.value = '';
                     msgInput.placeholder = "Type your message here...";
                     const btn = document.querySelector('.chat-footer .btn-primary i');
                     if(btn) btn.className = 'ri-send-plane-2-line';
                 }
             } catch(e) { console.error(e); }
             return;
        }

        // --- NORMAL SEND MODE ---
        if(!currentChatId || currentChatId.startsWith('static-')) return;

        let payload = { message: text };
        if(attachment) {
            payload.attachment_url = attachment.url;
            payload.attachment_type = attachment.type;
        }

        if (currentChatType === 'private') {
            socket.emit('private_message', { toUserId: currentChatId, ...payload });
        } else if (currentChatType === 'group') {
            socket.emit('group_message', { groupId: currentChatId, ...payload });
        } else if (currentChatType === 'channel') {
            socket.emit('channel_message', { channelId: currentChatId, ...payload });
        }

        // Store reference to get the ID on response
        // Note: appendMessage signature updated to accept attachment
        let myName = 'You';
        let myAvatar = null;
        try {
            const u = JSON.parse(localStorage.getItem('user'));
            if(u) {
                // if(u.full_name) myName = u.full_name; // Reverted to 'You' to avoid confusion
                if(u.profile_picture_url) myAvatar = u.profile_picture_url;
            }
        } catch(e){}

        appendMessage(text, 'sent', myName, myAvatar, new Date(), null, null, attachment);
        lastSentLi = msgContainer.lastElementChild;
        
        msgInput.value = '';
        scrollToBottom();
        
        // Optimistic UI Update for Sender (for sorting list)
        setTimeout(() => {
            const chatList = document.querySelector('#chat-msg-scroll .simplebar-content') || document.querySelector('#chat-msg-scroll');
            if (chatList) {
                let pid = currentChatId;
                // if(currentChatType === 'group') pid = currentChatId; 
                
                let existingItem = chatList.querySelector(`li[data-id="${pid}"]`);
                if (existingItem) {
                    // Move to top (AFTER header)
                    const headerItem = chatList.querySelector('li.pb-0');
                    if (headerItem) {
                        headerItem.insertAdjacentElement('afterend', existingItem);
                    } else {
                        chatList.prepend(existingItem);
                    }
                    
                    const msgTextEl = existingItem.querySelector('.chat-msg');
                    const timeEl = existingItem.querySelector('.float-end.text-muted');
                    if (msgTextEl) msgTextEl.textContent = text;
                    if (timeEl) timeEl.textContent = 'Just now';
                }
            }
        }, 0);

        // Background Sync (Reduced Delay)
        setTimeout(() => loadRecentChats(), 200);
    }
    
    // Update sent message with its database ID when server confirms
    socket.on('message_sent', (payload) => {
        if(lastSentLi && payload.id) {
            lastSentLi.dataset.messageId = payload.id;
            lastSentLi = null;
        }
    });

    // Bind send button
    const sendBtn = document.querySelector('.chat-footer .btn-primary');
    if(sendBtn) {
        sendBtn.addEventListener('click', (e) => {
            sendMessage();
        });
    }

    // ================== MOBILE RESPONSIVENESS ==================
    const chatWrapper = document.querySelector('.main-chart-wrapper');
    const closeChatBtn = document.querySelector('.responsive-chat-close');

    function showMobileChat() {
        if(window.innerWidth < 992 && chatWrapper) {
            chatWrapper.classList.add('mobile-chat-active');
        }
    }

    if(closeChatBtn) {
        closeChatBtn.addEventListener('click', () => {
            if(chatWrapper) chatWrapper.classList.remove('mobile-chat-active');
            // Optional: clear active state
            document.querySelectorAll('.checkforactive').forEach(li => li.classList.remove('active'));
            currentChatId = null;
        });
    }

    // Enter key
    if(msgInput) {
        msgInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    // ================== UI HELPERS ==================
    function updateChatHeader(name, avatar, status) {
        const header = document.getElementById('main-chat-header');
        if(header) {
            header.style.display = ''; // Remove inline display:none
            header.classList.remove('d-none');
        }

        document.querySelectorAll('.chatnameperson').forEach(el => el.textContent = name);
        document.querySelectorAll('.chatimageperson').forEach(el => el.src = avatar || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg');
        document.querySelectorAll('.chatpersonstatus').forEach(el => el.textContent = status);
        document.querySelectorAll('.chatstatusperson').forEach(el => {
            el.classList.remove('online', 'offline');
            el.classList.add(status === 'online' ? 'online' : 'offline');
        });
    }

    function updateActiveState(id) {
        document.querySelectorAll('.checkforactive').forEach(li => li.classList.remove('active'));
        const el = document.querySelector(`li[data-id="${id}"]`);
        if(el) el.classList.add('active');
    }

    // Mark messages as read - API call and update UI
    async function markMessagesRead(partnerId, type) {
        const token = localStorage.getItem('token');
        if(!token) return;
        
        try {
            await fetch('/api/chat/read', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ partnerId, type })
            });
            
            // Update UI - remove the unread badge for this conversation
            // Update UI - remove the unread badge AND dot for this conversation
            const listItem = document.querySelector(`li[data-id="${partnerId}"]`);
            if(listItem) {
                const badge = listItem.querySelector('.badge');
                const dotContainer = listItem.querySelector('.unread-dot-container');
                const dot = listItem.querySelector('.unread-dot');
                
                if(badge) badge.remove();
                if(dotContainer) dotContainer.remove();
                if(dot) dot.remove();
                
                // Also remove generic unread class if it exists
                listItem.classList.remove('chat-msg-unread');
            }
        } catch(e) {
            console.error('Failed to mark messages as read:', e);
        }
    }

    // ================== SEARCH FUNCTIONALITY ==================
    const searchInput = document.getElementById('chat-search-input');
    if(searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase().trim();
            
            // Determine which tab is active
            const activeTab = document.querySelector('#myTab1 .nav-link.active');
            let listContainer = null;
            
            if(activeTab) {
                const tabId = activeTab.getAttribute('data-bs-target');
                if(tabId === '#users-tab-pane') {
                    listContainer = document.querySelector('#chat-msg-scroll .simplebar-content') || document.querySelector('#chat-msg-scroll');
                } else if(tabId === '#groups-tab-pane') {
                    listContainer = document.querySelector('#groups-tab-pane ul');
                } else if(tabId === '#contacts-tab-pane') {
                    listContainer = document.querySelector('#contacts-tab-pane ul');
                }
            }
            
            if(!listContainer) return;
            
            // Filter list items
            const items = listContainer.querySelectorAll('li.checkforactive, li[onclick]');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if(query === '' || text.includes(query)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        // Clear search when switching tabs
        document.querySelectorAll('#myTab1 .nav-link').forEach(tab => {
            tab.addEventListener('click', () => {
                searchInput.value = '';
                // Show all items in all tabs
                document.querySelectorAll('.checkforactive, li[onclick]').forEach(li => li.style.display = '');
            });
        });
    }

    function appendMessage(text, type, senderName, avatar, time, messageId, reactions, attachmentUrl, attachmentType) {
        // Support legacy calls or object param
        if(typeof attachmentUrl === 'object' && attachmentUrl !== null) {
            attachmentType = attachmentUrl.type;
            attachmentUrl = attachmentUrl.url;
        }

        const isSent = type === 'sent';
        const li = document.createElement('li');
        li.className = isSent ? 'chat-item-end' : 'chat-item-start';
        if(messageId) li.dataset.messageId = messageId;
        const timeStr = time ? formatTime(time) : formatTime(new Date());
        
        // Build reactions HTML
        let reactionsHtml = '';
        if(reactions && Object.keys(reactions).length > 0) {
            reactionsHtml = '<div class="message-reactions">' +
                Object.entries(reactions).map(([e, u]) => `<span class="reaction-badge">${e}${u.length > 1 ? ' ' + u.length : ''}</span>`).join('') +
            '</div>';
        }

        // Build Attachment HTML
        let attachmentHtml = '';
        if(attachmentUrl) {
            if(attachmentType === 'image') {
                attachmentHtml = `<div class="mt-2"><a href="${attachmentUrl}" target="_blank"><img src="${attachmentUrl}" class="img-fluid rounded border" style="max-width: 200px; max-height: 200px;"></a></div>`;
            } else if (attachmentType === 'audio') {
                attachmentHtml = `<div class="mt-2"><audio controls src="${attachmentUrl}" style="max-width: 250px;"></audio></div>`;
            } else if (attachmentType === 'video') {
                attachmentHtml = `<div class="mt-2"><video controls src="${attachmentUrl}" style="max-width: 250px; border-radius: 8px;"></video></div>`;
            } else {
                attachmentHtml = `<div class="mt-2"><a href="${attachmentUrl}" target="_blank" class="btn btn-sm btn-light border"><i class="ri-file-line me-1"></i> Download File</a></div>`;
            }
        }
        
        const contentHtml = `
            <div class="main-chat-msg">
                <button class="msg-menu-btn" onclick="showMsgMenuAt(event, this)"><i class="ri-more-2-fill"></i></button>
                <div>
                    ${text ? `<p class="mb-0">${escapeHtml(text)}</p>` : ''}
                    ${attachmentHtml}
                </div>
            </div>`;

        if(isSent) {
            li.innerHTML = `
                <div class="chat-list-inner">
                    <div class="me-3">
                        ${senderName ? `<div class="d-flex align-items-center justify-content-end mb-1"><span class="fw-semibold text-muted fs-11">${escapeHtml(senderName)}</span></div>` : ''}
                        ${contentHtml}
                        ${reactionsHtml}
                        <span class="chatting-user-info">
                            <span class="msg-sent-time"><span class="chat-read-mark align-middle d-inline-flex"><i class="ri-check-double-line"></i></span>${timeStr}</span>
                        </span>
                    </div>
                    <div class="chat-user-profile">
                        <span class="avatar avatar-md avatar-rounded"><img src="${avatar || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/15.jpg'}" onerror="this.src='https://laravelui.spruko.com/zeno/build/assets/images/faces/15.jpg'; this.onerror=null;" alt="img"></span>
                    </div>
                </div>`;
        } else {
            li.innerHTML = `
                <div class="chat-list-inner">
                    <div class="chat-user-profile">
                        <span class="avatar avatar-md avatar-rounded"><img class="chatimageperson" src="${avatar || currentChatAvatar || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg'}" onerror="this.src='https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg'; this.onerror=null;" alt="img"></span>
                    </div>
                    <div class="ms-3">
                        ${senderName ? `<span class="d-block fw-semibold text-muted fs-11 mb-1">${escapeHtml(senderName)}</span>` : ''}
                        ${contentHtml}
                        ${reactionsHtml}
                        <span class="chatting-user-info">
                            <span class="msg-sent-time">${timeStr}</span>
                        </span>
                    </div>
                </div>`;
        }
        msgContainer.appendChild(li);
    }

    function scrollToBottom() {
        if(msgScrollArea) {
            setTimeout(() => { msgScrollArea.scrollTop = msgScrollArea.scrollHeight; }, 50);
        }
    }

    function formatTime(isoString) {
        try { return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        catch(e) { return ''; }
    }

    function escapeHtml(text) {
        if (!text) return '';
        return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // ================== GROUP CREATION ==================
    function populateGroupModal() {
        const container = document.getElementById('group-creation-members');
        if(!container || !allContacts.length) return;
        
        container.innerHTML = allContacts.map(u => `
            <label class="list-group-item">
                <input class="form-check-input me-1" type="checkbox" value="${u.id}">
                ${escapeHtml(u.full_name)}
            </label>
        `).join('');
    }

    window.createGroup = async function() {
        const nameInput = document.getElementById('new-group-name');
        const name = nameInput ? nameInput.value.trim() : '';
        const boxes = document.querySelectorAll('#group-creation-members input:checked');
        const memberIds = Array.from(boxes).map(cb => cb.value);

        if(!name) return alert("Please enter a group name");

        const token = localStorage.getItem('token');
        try {
            const res = await fetch('/api/chat/groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ name, members: memberIds })
            });
            const data = await res.json();
            if(data.success) {
                const modalEl = document.getElementById('createGroupModal');
                if(modalEl) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if(modal) modal.hide();
                }
                nameInput.value = '';
                loadGroups();
                if(typeof Toastify !== 'undefined') {
                   // Toast removed
                }
            } // Close data.success
        } catch(e) { console.error(e); }
    };

    // ================== GROUP MANAGEMENT ==================
    window.showGroupInfo = function() {
        if(currentChatType !== 'group' || !currentChatId) return;
        
        // Find group data
        // We need to store group data globally or re-fetch active group. 
        // Quickest way: Store 'groups' from loadGroups in a global var.
        const group = allGroups.find(g => g.id == currentChatId); // We need to add allGroups
        if(!group) return;

        document.getElementById('group-info-name').textContent = group.name;
        
        const list = document.getElementById('group-info-members');
        list.innerHTML = (group.members || []).map(m => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><img src="${m.profile_picture_url || '/assets/images/faces/9.jpg'}" class="avatar avatar-sm rounded-circle me-2"> ${escapeHtml(m.full_name)}</span>
            </li>
        `).join('');

        // Populate Add Select
        const select = document.getElementById('group-add-member-select');
        // Filter out existing members
        const memberIds = (group.members || []).map(m => m.id);
        const nonMembers = allContacts.filter(c => !memberIds.includes(c.id));
        
        select.innerHTML = '<option value="">Select user...</option>' + 
            nonMembers.map(u => `<option value="${u.id}">${escapeHtml(u.full_name)}</option>`).join('');

        const modal = new bootstrap.Modal(document.getElementById('groupInfoModal'));
        modal.show();
    };

    window.addGroupMember = async function() {
        const select = document.getElementById('group-add-member-select');
        const userId = select.value;
        if(!userId) return;
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/chat/groups/${currentChatId}/members`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ userId })
            });
            if(res.ok) {
                 // Refresh
                 loadGroups().then(() => {
                     // Hacky: Close modal or refresh it? Close for now
                     const modalEl = document.getElementById('groupInfoModal');
                     const modal = bootstrap.Modal.getInstance(modalEl);
                     modal.hide();
                     if(typeof Toastify !== 'undefined') Toastify({ text: "Member added", backgroundColor: "#28a745" }).showToast();
                 });
            }
        } catch(e) { console.error(e); }
    };

    window.leaveCurrentGroup = async function() {
        if(!confirm("Are you sure you want to leave this group?")) return;
        const token = localStorage.getItem('token');
        try {
             const res = await fetch(`/api/chat/groups/${currentChatId}/members`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok) {
                 location.reload(); // Hard refresh easiest to clear state
            }
        } catch(e) { console.error(e); }
    }

    // ================== CONTEXT MENU ==================
    let contextMenuTarget = null;
    let contextMenuMessageId = null;
    let contextMenuMessageText = null;
    let contextMenuIsMine = false;
    
    const contextMenu = document.getElementById('messageContextMenu');
    
    // Show context menu on right-click on messages
    document.addEventListener('contextmenu', function(e) {
        const msgEl = e.target.closest('.main-chat-msg');
        if(!msgEl) {
            hideContextMenu();
            return;
        }
        
        e.preventDefault();
        
        contextMenuTarget = msgEl;
        contextMenuMessageText = msgEl.querySelector('p')?.textContent || '';
        contextMenuMessageId = msgEl.closest('li')?.dataset?.messageId || null;
        
        const listItem = msgEl.closest('li');
        contextMenuIsMine = listItem?.classList.contains('chat-item-end');
        
        const editBtn = document.getElementById('ctx-edit-btn');
        if(editBtn) editBtn.style.display = contextMenuIsMine ? 'flex' : 'none';
        
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.classList.add('show');
    });
    
    document.addEventListener('click', function(e) {
        if(!e.target.closest('.message-context-menu')) {
            hideContextMenu();
        }
    });
    
    function hideContextMenu() {
        contextMenu.classList.remove('show');
        contextMenuTarget = null;
    }
    
    window.addReactionFromMenu = async function(emoji) {
        const targetMsg = contextMenuTarget; // Save reference before hideContextMenu clears it
        const msgId = contextMenuMessageId;
        
        if(!msgId) {
            if(typeof Toastify !== 'undefined') Toastify({ text: "Select a message first", backgroundColor: "#dc3545" }).showToast();
            hideContextMenu();
            return;
        }
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch('/api/chat/reaction', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ messageId: msgId, emoji })
            });
            const data = await res.json();
            
            if(res.ok && data.reactions) {
                // Update the UI with the new reactions
                updateMessageReactions(targetMsg, data.reactions);
                if(typeof Toastify !== 'undefined') Toastify({ text: "Reaction added!", backgroundColor: "#28a745" }).showToast();
            } else {
                if(typeof Toastify !== 'undefined') Toastify({ text: data.message || "Failed to add reaction", backgroundColor: "#dc3545" }).showToast();
            }
        } catch(e) { 
            console.error(e);
            if(typeof Toastify !== 'undefined') Toastify({ text: "Error adding reaction", backgroundColor: "#dc3545" }).showToast();
        }
        hideContextMenu();
    };
    
    // Helper to update reactions display on a message
    function updateMessageReactions(msgEl, reactions) {
        if(!msgEl) return;
        
        // Find or create reactions container
        let reactionsDiv = msgEl.querySelector('.message-reactions');
        if(!reactionsDiv) {
            reactionsDiv = document.createElement('div');
            reactionsDiv.className = 'message-reactions';
            msgEl.appendChild(reactionsDiv);
        }
        
        // Build reaction badges HTML
        const reactionEntries = Object.entries(reactions || {});
        if(reactionEntries.length === 0) {
            reactionsDiv.innerHTML = '';
            return;
        }
        
        reactionsDiv.innerHTML = reactionEntries.map(([emojiChar, users]) => 
            `<span class="reaction-badge" title="${users.length} reaction(s)">${emojiChar} ${users.length}</span>`
        ).join('');
    }
    
    window.copyMessage = function() {
        if(contextMenuMessageText) {
            navigator.clipboard.writeText(contextMenuMessageText);
            if(typeof Toastify !== 'undefined') Toastify({ text: "Copied!", backgroundColor: "#28a745" }).showToast();
        }
        hideContextMenu();
    };
    
    window.replyToMessage = function() {
        if(typeof Toastify !== 'undefined') Toastify({ text: "Reply: Coming soon!", backgroundColor: "#17a2b8" }).showToast();
        hideContextMenu();
    };
    
    window.deleteMessage = async function() {
        if(!contextMenuMessageId || !contextMenuIsMine) { hideContextMenu(); return; }
        if(!confirm("Delete this message?")) { hideContextMenu(); return; }
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/chat/message/${contextMenuMessageId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if(res.ok && contextMenuTarget) {
                const pEl = contextMenuTarget.querySelector('p');
                if(pEl) pEl.innerHTML = '<em class="text-muted">This message was deleted</em>';
            }
        } catch(e) { console.error(e); }
        hideContextMenu();
    };
    
    window.editMessage = function() {
        if(!contextMenuMessageId || !contextMenuIsMine) { hideContextMenu(); return; }
        
        // Enter Edit Mode
        editingMessageId = contextMenuMessageId;
        msgInput.value = contextMenuMessageText;
        msgInput.placeholder = "Editing message... (Press Enter to save)";
        msgInput.focus();
        
        // Change Icon to Checkmark or Save
        const btn = document.querySelector('.chat-footer .btn-primary i');
        if(btn) btn.className = 'ri-save-line';
        
        hideContextMenu();
    };
    let currentPinnedMessageId = null;
    
    window.pinMessage = async function() {
        const msgId = contextMenuMessageId;
        const msgText = contextMenuMessageText;
        const targetLi = contextMenuTarget?.closest('li');
        
        if(!msgId) { hideContextMenu(); return; }
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/chat/message/${msgId}/pin`, { 
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            if(res.ok && data.is_pinned) {
                // Show pinned banner
                currentPinnedMessageId = msgId;
                const banner = document.getElementById('pinnedMessageBanner');
                const pinnedText = document.getElementById('pinnedMessageText');
                if(banner && pinnedText) {
                    pinnedText.textContent = msgText;
                    banner.classList.add('show');
                }
                
                // Add pin indicator to the message
                if(targetLi) {
                    targetLi.dataset.isPinned = 'true';
                    const timeSpan = targetLi.querySelector('.msg-sent-time');
                    if(timeSpan && !timeSpan.querySelector('.msg-pin-indicator')) {
                        timeSpan.insertAdjacentHTML('beforeend', '<span class="msg-pin-indicator"><i class="ri-pushpin-fill"></i></span>');
                    }
                }
                
                if(typeof Toastify !== 'undefined') Toastify({ text: "You pinned a message", backgroundColor: "#28a745" }).showToast();
            } else if(res.ok && !data.is_pinned) {
                // Message was unpinned
                hidePinBanner();
                if(targetLi) {
                    targetLi.dataset.isPinned = 'false';
                    const pinIndicator = targetLi.querySelector('.msg-pin-indicator');
                    if(pinIndicator) pinIndicator.remove();
                }
                if(typeof Toastify !== 'undefined') Toastify({ text: "Message unpinned", backgroundColor: "#28a745" }).showToast();
            }
        } catch(e) { 
            console.error(e);
            if(typeof Toastify !== 'undefined') Toastify({ text: "Failed to pin message", backgroundColor: "#dc3545" }).showToast();
        }
        hideContextMenu();
    };
    
    function hidePinBanner() {
        const banner = document.getElementById('pinnedMessageBanner');
        if(banner) banner.classList.remove('show');
        currentPinnedMessageId = null;
    }
    
    window.scrollToPinnedMessage = function() {
        if(!currentPinnedMessageId) return;
        const pinnedLi = document.querySelector(`li[data-message-id="${currentPinnedMessageId}"]`);
        if(pinnedLi) {
            pinnedLi.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Highlight effect
            pinnedLi.style.background = 'rgba(0, 168, 132, 0.2)';
            setTimeout(() => { pinnedLi.style.background = ''; }, 1500);
        }
    };
    
    window.unpinMessage = async function() {
        if(!currentPinnedMessageId) return;
        const token = localStorage.getItem('token');
        try {
            await fetch(`/api/chat/message/${currentPinnedMessageId}/pin`, { 
                method: 'POST', 
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            // Remove pin indicator from message
            const pinnedLi = document.querySelector(`li[data-message-id="${currentPinnedMessageId}"]`);
            if(pinnedLi) {
                const pinIndicator = pinnedLi.querySelector('.msg-pin-indicator');
                if(pinIndicator) pinIndicator.remove();
            }
            
            hidePinBanner();
            if(typeof Toastify !== 'undefined') Toastify({ text: "Message unpinned", backgroundColor: "#28a745" }).showToast();
        } catch(e) { console.error(e); }
    };
    
    window.starMessage = async function() {
        if(!contextMenuMessageId) { hideContextMenu(); return; }
        const token = localStorage.getItem('token');
        await fetch(`/api/chat/message/${contextMenuMessageId}/star`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }});
        if(typeof Toastify !== 'undefined') Toastify({ text: "Starred!", backgroundColor: "#28a745" }).showToast();
        hideContextMenu();
    };
    
    window.forwardMessage = function() {
        if(typeof Toastify !== 'undefined') Toastify({ text: "Forward: Coming soon!", backgroundColor: "#17a2b8" }).showToast();
        hideContextMenu();
    };
    // Store context for reaction picker
    let reactionPickerMsgId = null;
    let reactionPickerTarget = null;
    
    window.showEmojiPicker = function() {
        // Store the context before hiding the menu
        reactionPickerMsgId = contextMenuMessageId;
        reactionPickerTarget = contextMenuTarget;
        hideContextMenu();
        
        // Show the reaction emoji picker with animation
        const reactionPicker = document.getElementById('reactionEmojiPicker');
        const pickerOverlay = document.getElementById('reactionPickerOverlay');
        if(reactionPicker) reactionPicker.classList.add('show');
        if(pickerOverlay) pickerOverlay.classList.add('show');
    };
    
    // Handle selecting an emoji from the reaction picker
    window.selectReactionEmoji = async function(emoji) {
        closeReactionPicker();
        
        if(!reactionPickerMsgId) return;
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch('/api/chat/reaction', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ messageId: reactionPickerMsgId, emoji })
            });
            const data = await res.json();
            
            if(res.ok && data.reactions) {
                updateMessageReactions(reactionPickerTarget, data.reactions);
                if(typeof Toastify !== 'undefined') Toastify({ text: "Reaction added!", backgroundColor: "#28a745" }).showToast();
            }
        } catch(e) { console.error(e); }
        
        reactionPickerMsgId = null;
        reactionPickerTarget = null;
    };
    
    window.closeReactionPicker = function() {
        const reactionPicker = document.getElementById('reactionEmojiPicker');
        const pickerOverlay = document.getElementById('reactionPickerOverlay');
        if(reactionPicker) reactionPicker.classList.remove('show');
        if(pickerOverlay) pickerOverlay.classList.remove('show');
        // Clear search
        const searchInput = document.getElementById('reactionSearch');
        if(searchInput) searchInput.value = '';
        filterReactionEmojis('');
        reactionPickerMsgId = null;
        reactionPickerTarget = null;
    };
    
    // Search/filter emojis in reaction picker
    window.filterReactionEmojis = function(query) {
        const grid = document.getElementById('reactionGrid');
        if(!grid) return;
        
        const items = grid.querySelectorAll('span');
        const categories = grid.querySelectorAll('.reaction-category');
        const lowerQuery = query.toLowerCase().trim();
        
        // Simple emoji-to-keyword map for search
        const emojiKeywords = {
            '😀': 'smile happy', '😃': 'smile happy', '😄': 'smile happy grin', '😁': 'grin smile',
            '😂': 'laugh cry tears joy', '🤣': 'laugh rolling floor', '😊': 'blush smile',
            '😍': 'love heart eyes', '🥰': 'love hearts', '😘': 'kiss blow',
            '😎': 'cool sunglasses', '🤩': 'star eyes excited', '🥳': 'party celebrate',
            '👍': 'thumbs up good yes ok like', '👎': 'thumbs down bad no dislike',
            '👏': 'clap applause bravo', '🙏': 'pray please thanks namaste',
            '💪': 'strong muscle flex', '🤝': 'handshake deal', '👋': 'wave hello hi bye',
            '❤️': 'heart love red', '💔': 'broken heart', '🔥': 'fire hot lit',
            '⭐': 'star', '✨': 'sparkle magic', '💯': '100 perfect',
            '✅': 'check yes done', '❌': 'x no cross wrong', '🎉': 'party celebrate confetti',
            '💡': 'idea bulb light', '🎯': 'target goal bullseye'
        };
        
        if(!lowerQuery) {
            // Show all
            items.forEach(s => s.style.display = '');
            categories.forEach(c => c.style.display = '');
            return;
        }
        
        // Hide categories during search
        categories.forEach(c => c.style.display = 'none');
        
        items.forEach(span => {
            const emoji = span.textContent;
            const keywords = emojiKeywords[emoji] || '';
            const matches = emoji.includes(lowerQuery) || keywords.includes(lowerQuery);
            span.style.display = matches ? '' : 'none';
        });
    };

    // ================== DRAGGABLE REACTION PICKER ==================
    (function() {
        const picker = document.getElementById('reactionEmojiPicker');
        const header = picker?.querySelector('.reaction-picker-header');
        if(!picker || !header) return;
        
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        header.style.cursor = 'grab';
        
        header.addEventListener('mousedown', function(e) {
            if(e.target.tagName === 'I') return; // Don't drag on close button
            isDragging = true;
            header.style.cursor = 'grabbing';
            
            const rect = picker.getBoundingClientRect();
            initialX = rect.left;
            initialY = rect.top;
            startX = e.clientX;
            startY = e.clientY;
            
            // Remove center transform for absolute positioning
            picker.style.transform = 'none';
            picker.style.left = initialX + 'px';
            picker.style.top = initialY + 'px';
        });
        
        document.addEventListener('mousemove', function(e) {
            if(!isDragging) return;
            e.preventDefault();
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            picker.style.left = (initialX + dx) + 'px';
            picker.style.top = (initialY + dy) + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            if(isDragging) {
                isDragging = false;
                header.style.cursor = 'grab';
            }
        });
        
        // Note: Touch dragging disabled on mobile to prevent positioning issues
        // Users can scroll inside the modal and close with X button
    })();
    
    // ================== DRAGGABLE CONTEXT MENU ==================
    (function() {
        const menu = document.getElementById('messageContextMenu');
        const handle = document.getElementById('contextMenuDragHandle');
        if(!menu || !handle) return;
        
        let isDragging = false;
        let startX, startY, initialX, initialY;
        
        handle.addEventListener('mousedown', function(e) {
            isDragging = true;
            handle.style.cursor = 'grabbing';
            
            const rect = menu.getBoundingClientRect();
            initialX = rect.left;
            initialY = rect.top;
            startX = e.clientX;
            startY = e.clientY;
            e.preventDefault();
        });
        
        handle.addEventListener('touchstart', function(e) {
            isDragging = true;
            
            const rect = menu.getBoundingClientRect();
            initialX = rect.left;
            initialY = rect.top;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        }, { passive: false });
        
        document.addEventListener('mousemove', function(e) {
            if(!isDragging) return;
            e.preventDefault();
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            
            menu.style.left = (initialX + dx) + 'px';
            menu.style.top = (initialY + dy) + 'px';
        });
        
        document.addEventListener('mouseup', function() {
            if(isDragging) {
                isDragging = false;
                handle.style.cursor = 'grab';
            }
        });
        
        document.addEventListener('touchmove', function(e) {
            if(!isDragging) return;
            
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            
            menu.style.left = (initialX + dx) + 'px';
            menu.style.top = (initialY + dy) + 'px';
        }, { passive: false });
        
        document.addEventListener('touchend', function() {
            isDragging = false;
        });
    })();

    // ================== SHOW MENU FROM ⋮ BUTTON ==================
    window.showMsgMenuAt = function(event, btn) {
        event.preventDefault();
        event.stopPropagation();
        
        const msgEl = btn.closest('.main-chat-msg');
        if(!msgEl) return;
        
        contextMenuTarget = msgEl;
        contextMenuMessageText = msgEl.querySelector('p')?.textContent || '';
        contextMenuMessageId = msgEl.closest('li')?.dataset?.messageId || null;
        
        const listItem = msgEl.closest('li');
        contextMenuIsMine = listItem?.classList.contains('chat-item-end');
        
        // Show/hide edit button based on ownership
        const editBtn = document.getElementById('ctx-edit-btn');
        if(editBtn) editBtn.style.display = contextMenuIsMine ? 'flex' : 'none';
        
        // Position near the button - check if near bottom of screen
        const rect = btn.getBoundingClientRect();
        const menuHeight = 350; // Estimated max height
        const spaceBelow = window.innerHeight - rect.bottom;
        const spaceAbove = rect.top;
        
        let top, left;
        
        // Position horizontally
        left = rect.left - 160;
        if(left < 10) left = 10;
        if(left + 160 > window.innerWidth) left = window.innerWidth - 170;
        
        // Position vertically - show above if not enough space below
        if(spaceBelow < menuHeight && spaceAbove > spaceBelow) {
            top = rect.top - Math.min(menuHeight, spaceAbove - 10);
        } else {
            top = rect.bottom + 5;
        }
        
        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';
        contextMenu.classList.add('show');
    };

    // ================== SWIPE GESTURES ==================
    let touchStartX = 0;
    let touchCurrentX = 0;
    let swipeTarget = null;
    const SWIPE_THRESHOLD = 80;

    document.addEventListener('touchstart', function(e) {
        const li = e.target.closest('.chat-item-start, .chat-item-end');
        if(!li) return;
        
        touchStartX = e.touches[0].clientX;
        swipeTarget = li;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
        if(!swipeTarget) return;
        
        touchCurrentX = e.touches[0].clientX;
        const diff = touchCurrentX - touchStartX;
        
        // Visual feedback - translate the message
        if(Math.abs(diff) > 20 && Math.abs(diff) < 150) {
            swipeTarget.style.transform = `translateX(${diff * 0.5}px)`;
            swipeTarget.style.transition = 'none';
        }
    }, { passive: true });

    document.addEventListener('touchend', function(e) {
        if(!swipeTarget) return;
        
        const diff = touchCurrentX - touchStartX;
        
        // Reset transform
        swipeTarget.style.transform = '';
        
        if (Math.abs(diff) < 20) {
            // It was a tap, not a swipe - let default click happen
             swipeTarget = null;
             return;
        }

        if (Math.abs(diff) > SWIPE_THRESHOLD) {
            // Trigger reply
            const textEl = swipeTarget.querySelector('.main-chat-msg p');
            if(textEl) {
                if(typeof Toastify !== 'undefined') Toastify({ text: "Swipe Action: Coming soon!", backgroundColor: "#17a2b8" }).showToast();
            }
        }
        swipeTarget = null;
        touchStartX = 0;
        touchCurrentX = 0;
    }, { passive: true });

    // ================== HELPER: Update Chat Header UI ==================
    // Redefined here to ensure it overrides any previous definition and handles status correctly
    function updateChatHeader(name, avatar, status) {
        // Main Header Elements
        const chatHeader = document.getElementById('main-chat-header');
        if(!chatHeader) return;
        
        chatHeader.style.setProperty('display', 'flex', 'important');
        
        const avatarEl = chatHeader.querySelector('.chatimageperson');
        const nameEl = chatHeader.querySelector('.chatnameperson');
        const statusEl = chatHeader.querySelector('.chatpersonstatus');
        const statusAvatarContainer = chatHeader.querySelector('.avatar');

        if(avatarEl) avatarEl.src = avatar || '/build/assets/images/faces/9.jpg';
        if(nameEl) nameEl.textContent = name;
        
        if(statusEl) {
            statusEl.textContent = status || 'offline';
        }
        
        // Handle Avatar Online/Offline Status Class
        if(statusAvatarContainer) {
            statusAvatarContainer.classList.remove('online', 'offline');
            if(status === 'online') {
                statusAvatarContainer.classList.add('online');
            } else {
                statusAvatarContainer.classList.add('offline');
            }
        }
    }
</script> 
<!-- Team Chat Logic -->
<script src="/assets/js/team-chat.js"></script>
<script>
    // Initialize Channels
    document.addEventListener('DOMContentLoaded', () => {
        if(typeof loadChannels === 'function') loadChannels();
    });

    // Load Channels Function
    window.loadChannels = async function() {
        const container = document.getElementById('channels-list');
        if(!container) return;
        
        try {
            const token = localStorage.getItem('token');
            const res = await fetch('/api/chat/channels', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            if(data.success && data.channels.length > 0) {
                 window.allChannels = data.channels; // Store globally
                 container.innerHTML = data.channels.map(c => `
                    <li onclick="openChannel('${c.id}', '${escapeHtml(c.name)}', '${c.type}')" class="checkforactive" data-type="channel" data-id="${c.id}">
                        <div class="d-flex align-items-center gap-2 p-2" style="cursor:pointer;">
                             <div class="avatar avatar-sm bg-primary-transparent text-primary">
                                <span style="font-size: 1.2rem;">#</span>
                             </div>
                             <div class="flex-fill">
                                 <span class="d-block fw-semibold">${escapeHtml(c.name)}</span>
                                 <span class="d-block fs-11 text-muted">${c.type === 'private' ? '<i class="ri-lock-line"></i> Private' : 'Company Public'}</span>
                             </div>
                             ${c.unread ? `<span class="badge bg-danger rounded-pill">${c.unread}</span>` : ''}
                        </div>
                    </li>
                 `).join('');
            } else {
                 container.innerHTML = '<li class="p-3 text-center text-muted">No channels found</li>';
            }
        } catch(e) {
            console.error("Error loading channels", e);
            container.innerHTML = '<li class="text-danger p-3 text-center">Failed to load</li>';
        }
    };

    window.openChannel = function(channelId, name, type) {
        // reuse loadChatHistory but for channel
        currentChatId = channelId;
        currentChatType = 'channel';
        currentChatName = '#' + name;
        currentChatAvatar = null;
        
        updateChatHeader('#' + name, null, type === 'private' ? 'Private Channel' : 'Company Channel');
        updateActiveState(channelId);
        
        // Ensure footer is visible
        const footer = document.getElementById('main-chat-footer');
        if(footer) footer.style.display = 'flex';
        
        // Hide mobile sidebar
        const chatWrapper = document.querySelector('.main-chart-wrapper');
        if(chatWrapper) chatWrapper.classList.add('mobile-chat-active');
        
        // Setup Socket Room
        socket.emit('join_channel', channelId);
        
        // Load Messages
        loadChannelMessages(channelId);
        
        // Update Add All Button in Context specific UI if we had one
        // We need a way to trigger "Add All Team".
        // Let's add a button in the header dynamically or ensure "Group Info" button shows channel options.
        updateSidebarInfo(channelId, name, null, 'channel');
    };

    async function loadChannelMessages(channelId) {
        const token = localStorage.getItem('token');
        msgContainer.innerHTML = '<li class="text-center py-5 text-muted">Loading messages...</li>';
        
        try {
            const res = await fetch(`/api/chat/channels/${channelId}/messages`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            msgContainer.innerHTML = '';
            if(data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    const isSent = msg.sender_id === currentUserId;
                    appendMessage(msg.message, isSent ? 'sent' : 'received', msg.sender_name, msg.sender_avatar, msg.createdAt, msg.id, msg.reactions);
                });
            } else {
                 msgContainer.innerHTML = '<li class="text-center py-5 text-muted">No messages yet. Start the conversation!</li>';
            }
            scrollToBottom();
        } catch(e) { console.error(e); }
    }
    
    // Create Channel Form Submit
    window.createChannel = async function() {
        const name = document.getElementById('new-channel-name').value;
        const type = document.getElementById('new-channel-type').value;
        
        if(!name) return alert("Name required");
        
        const token = localStorage.getItem('token');
        try {
             const res = await fetch('/api/chat/channels', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                 body: JSON.stringify({ name, type })
             });
             const data = await res.json();
             if(data.success) {
                 const modal = bootstrap.Modal.getInstance(document.getElementById('createChannelModal'));
                 modal.hide();
                 loadChannels();
                 document.getElementById('new-channel-name').value = '';
             } else {
                 alert(data.message);
             }
        } catch(e) { console.error(e); }
    };
    
    // Handle Info Button Click
    window.handleInfoClick = function() {
        if(window.currentChatType === 'channel') {
            const modal = new bootstrap.Modal(document.getElementById('channelInfoModal'));
            modal.show();
            loadChannelInfoDetails(currentChatId);
        } else if (window.currentChatType === 'group' && typeof showGroupInfo === 'function') {
            showGroupInfo();
        }
    };

    window.loadChannelInfoDetails = async function(channelId) {
        const memberList = document.getElementById('channel-member-list');
        const select = document.getElementById('channel-new-member-select');
        
        memberList.innerHTML = '<li class="list-group-item text-center text-muted">Loading...</li>';
        select.innerHTML = '<option value="">Loading...</option>';
        
        const token = localStorage.getItem('token');
        
        try {
            // 1. Get Channel Members
            const resMembers = await fetch(`/api/chat/channels/${channelId}/members`, { headers: { 'Authorization': `Bearer ${token}` } });
            const dataMembers = await resMembers.json();
            const currentMembers = dataMembers.success ? dataMembers.members : [];
            
            // 2. Get All Team Members (to populate add list)
            const resTeam = await fetch('/api/team/members', { headers: { 'Authorization': `Bearer ${token}` } });
            const dataTeam = await resTeam.json();
            const allTeam = dataTeam.success ? dataTeam.members : [];
            
            // Render Current Members
            if(currentMembers.length > 0) {
                memberList.innerHTML = currentMembers.map(m => `
                    <li class="list-group-item d-flex align-items-center justify-content-between px-0">
                        <div class="d-flex align-items-center">
                            <img src="${m.profile_picture_url || '/assets/images/faces/9.jpg'}" class="avatar avatar-sm rounded-circle me-2"> 
                            <div>
                                <span class="d-block lh-1">${escapeHtml(m.full_name)}</span>
                                <small class="text-muted">${m.role || 'member'}</small>
                            </div>
                        </div>
                    </li>
                `).join('');
            } else {
                memberList.innerHTML = '<li class="list-group-item text-center text-muted">No members yet</li>';
            }
            
            // Render Add Select (Filter out existing)
            const existingIds = currentMembers.map(m => m.id);
            const potentialMembers = allTeam.filter(tm => !existingIds.includes(tm.user.id));
            
            if(potentialMembers.length > 0) {
                select.innerHTML = '<option value="">Select a team member...</option>' + 
                    potentialMembers.map(tm => `<option value="${tm.user.id}">${escapeHtml(tm.user.full_name)} (${tm.user.email})</option>`).join('');
            } else {
                select.innerHTML = '<option value="">All team members added</option>';
            }
            
        } catch(e) {
            console.error(e);
            memberList.innerHTML = '<li class="list-group-item text-center text-danger">Error loading members</li>';
        }
    };
    
    window.addMemberToCurrentChannel = async function() {
        const select = document.getElementById('channel-new-member-select');
        const userId = select.value;
        if(!userId) return;
        
        const token = localStorage.getItem('token');
        try {
            const res = await fetch(`/api/chat/channels/${currentChatId}/members`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ userId })
            });
            const data = await res.json();
            
            if(data.success) {
                if(typeof Toastify !== 'undefined') Toastify({ text: "Member added", backgroundColor: "#28a745" }).showToast();
                loadChannelInfoDetails(currentChatId); // Refresh
            } else {
                if(typeof Toastify !== 'undefined') Toastify({ text: data.message, backgroundColor: "#dc3545" }).showToast();
            }
        } catch(e) { console.error(e); }
    };
    // ================== SIDEBAR UPDATE LOGIC ==================
    window.updateSidebarInfo = function(id, name, avatar, type) {
        const container = document.getElementById('chat-user-details');
        if(!container) return;
        
        // Default Avatar
        const defAvatar = 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg';
        const finalAvatar = avatar || defAvatar;

        let content = '';

        if(type === 'private') {
            // Try to find email from allContacts
            let email = '';
            if(window.allContacts) {
                const user = window.allContacts.find(u => u.id == id || u.partnerId == id);
                if(user) email = user.email || '';
            }

            content = `
                <div class="text-center mb-4">
                    <span class="avatar avatar-rounded online avatar-xxl me-2 mb-3 chatstatusperson">
                        <img class="chatimageperson" src="${finalAvatar}" alt="img">
                    </span>
                    <p class="mb-1 fs-15 fw-medium text-dark lh-1 chatnameperson">${escapeHtml(name)}</p>
                    <p class="fs-12 text-muted chatpersonemail">${escapeHtml(email)}</p>
                    <p class="text-center mb-0 d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-primary-light btn-wave flex-fill waves-effect waves-light"><i class="ri-phone-line me-2 align-middle"></i>Call</button>
                        <button type="button" class="btn btn-success-light btn-wave flex-fill waves-effect waves-light"><i class="ri-video-add-line me-2 align-middle"></i>Video</button>
                        <button type="button" class="btn btn-info-light btn-wave flex-fill waves-effect waves-light"><i class="ri-chat-1-line me-2 align-middle"></i>Message</button>
                    </p>
                </div>
                <div class="mb-4 pt-2">
                    <div class="fw-medium mb-4">Shared Files
                        <span class="badge bg-info ms-1 rounded-pill">0</span>
                    </div>
                </div>
            `;
        } else if (type === 'channel' || type === 'group') {
            let desc = 'No description';
            let memberCount = 0;
            let iconClass = type === 'channel' ? 'ri-hashtag' : 'ri-group-line';
            let badgeClass = type === 'channel' ? 'bg-warning-light' : 'bg-primary-light';

            // Lookup Details
            if(type === 'channel' && window.allChannels) {
                const ch = window.allChannels.find(c => c.id == id);
                if(ch) {
                    desc = ch.description || 'Company Channel';
                    memberCount = ch.members_count || 0; // Assuming backend sends this or we fetch it
                }
            } else if (type === 'group' && window.allGroups) {
                const gr = window.allGroups.find(g => g.id == id);
                if(gr) {
                    desc = 'Group Chat';
                    memberCount = gr.members ? gr.members.length : 0;
                }
            }

            content = `
                 <div class="text-center mb-4">
                    <span class="avatar avatar-rounded avatar-xxl me-2 mb-3 ${badgeClass} text-dark">
                        <i class="${iconClass} fs-2"></i>
                    </span>
                    <p class="mb-1 fs-15 fw-medium text-dark lh-1">${escapeHtml(name)}</p>
                    <p class="fs-12 text-muted">${escapeHtml(desc)}</p>
                    
                    <div class="mt-3">
                         <span class="badge bg-light text-dark border me-2">${memberCount} Members</span>
                         <span class="badge bg-light text-dark border text-uppercase">${type}</span>
                    </div>

                    <div class="mt-4 d-grid">
                         <button class="btn btn-outline-primary btn-sm" onclick="handleInfoClick()">
                            <i class="ri-information-line me-1"></i> View ${type === 'channel' ? 'Channel' : 'Group'} Info
                         </button>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = content;
    };

    // ================== FOOTER ACTIONS ==================
    
    // Upload Helper
    async function uploadAndSendFile(file) {
        if(typeof Toastify !== 'undefined') Toastify({ text: "Uploading...", backgroundColor: "#17a2b8" }).showToast();
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const token = localStorage.getItem('token');
            const res = await fetch('/api/chat/upload-attachment', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
            const data = await res.json();
            
            if(data.success) {
                await sendMessage({ url: data.url, type: data.type });
                if(typeof Toastify !== 'undefined') Toastify({ text: "Sent!", backgroundColor: "#28a745" }).showToast();
            } else {
                 alert("Upload failed: " + (data.message || 'Unknown error'));
            }
        } catch(e) { console.error(e); alert("Error uploading user file"); }
    }

    // 1. File Upload
    const fileInput = document.getElementById('chat-file-input');
    if(fileInput) {
        fileInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if(!file) return;
            uploadAndSendFile(file);
            fileInput.value = ''; // Reset
        });
    }

    // 2. Emoji Picker
    const emojiList = document.getElementById('emoji-list');
    const commonEmojis = ['😀', '😃', '😄', '😁', '😂', '🤣', '😊', '😍', '🥰', '😘', '😎', '🤩', '🥳', '👍', '👎', '👏', '🙏', '💪', '🤝', '👋', '❤️', '💔', '🔥', '⭐', '✨', '💯', '✅', '❌', '🎉', '💡', '🎯', '😭', '😡', '😱', '🤔', '🙌', '👀'];
    
    if(emojiList) {
        emojiList.innerHTML = commonEmojis.map(e => 
            `<span style="font-size: 1.5rem; cursor: pointer; padding: 6px; user-select: none;" onclick="insertEmoji('${e}')">${e}</span>`
        ).join('');
    }

    window.toggleEmojiPicker = function() {
        const picker = document.getElementById('main-emoji-picker');
        if(picker) {
             picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
        }
    };

    window.insertEmoji = function(emoji) {
        const input = document.getElementById('chat-input');
        if(input) {
            input.value += emoji;
            input.focus();
        }
    };

    // 3. Voice Note
    const voiceBtn = document.getElementById('btn-voice-note');
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    if(voiceBtn) {
        voiceBtn.addEventListener('click', async () => {
            if(!isRecording) {
                // Start Recording
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = async () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // or mp3/ogg depending on browser
                            const audioFile = new File([audioBlob], "voice-note.wav", { type: "audio/wav" });
                            
                            // Upload
                            uploadAndSendFile(audioFile);
                        };
                        
                        mediaRecorder.start();
                        isRecording = true;
                        voiceBtn.classList.remove('btn-warning-light');
                        voiceBtn.classList.add('btn-danger'); // Red for recording
                        voiceBtn.innerHTML = '<i class="ri-stop-circle-line"></i>';
                        
                        if(typeof Toastify !== 'undefined') Toastify({ text: "Recording... Click same button to send", backgroundColor: "#dc3545", duration: 5000 }).showToast();

                    } catch (err) {
                        console.error("Mic access denied", err);
                        alert("Microphone access denied. Please allow permissions.");
                    }
                } else {
                    alert("Audio recording not supported in this browser");
                }
            } else {
                // Stop Recording
                if(mediaRecorder) {
                    mediaRecorder.stop();
                    isRecording = false;
                    voiceBtn.classList.remove('btn-danger');
                    voiceBtn.classList.add('btn-warning-light');
                    voiceBtn.innerHTML = '<i class="ri-mic-line"></i>';
                }
            }
        });
    }

    // ================== MOBILE VIEW LOGIC ==================
    function showMobileChat() {
        const wrapper = document.querySelector('.main-chart-wrapper');
        if(wrapper) {
            wrapper.classList.add('mobile-chat-active');
            wrapper.style.display = 'block'; // Ensure wrapper is visible
        }
    }

    function hideMobileChat() {
        const wrapper = document.querySelector('.main-chart-wrapper');
        if(wrapper) wrapper.classList.remove('mobile-chat-active');
        
        // Reset active state in sidebar
        document.querySelectorAll('.checkforactive').forEach(li => li.classList.remove('active'));
    }

    // Bind Back Button & Fix Image Paths
    document.addEventListener('DOMContentLoaded', () => {
        const backBtn = document.querySelector('.responsive-chat-close');
        if(backBtn) {
            backBtn.addEventListener('click', (e) => {
                e.preventDefault();
                hideMobileChat();
            });
        }
        
        // Overwrite global helper to fix paths
        const originalSelectUser = window.selectUser;
        window.selectUser = async function(userId, name, avatar, status) {
            // Fix relative paths
            if(avatar && avatar.startsWith('uploads/') && !avatar.startsWith('/')) {
                avatar = '/' + avatar;
            }
            if(originalSelectUser) await originalSelectUser(userId, name, avatar, status);
        };
        
        // Helper to fix path if needed
        window.fixAvatarPath = function(path) {
            if(path && path.startsWith('uploads/')) return '/' + path;
            return path;
        }

        // ================== CALL LOGIC (Voice/Video) ==================
        let peer;
        let myPeerId;
        let localStream;
        let currentCall;
        let pendingCallData = null; // Store incoming call info
        let isVideo = false;
        
        // Call tracking for saving records
        let callStartTime = null;
        let callPartnerId = null;
        let callType = 'audio';

        // Init PeerJS
        if(typeof Peer !== 'undefined') {
            peer = new Peer(); // Auto-generates ID
            peer.on('open', (id) => { 
                console.log('My Peer ID:', id); 
                myPeerId = id; 
            });
            
            peer.on('call', (call) => {
                // Incoming stream connection (Step 5)
                if(localStream) {
                    call.answer(localStream);
                    handleStream(call);
                    showActiveCallUI();
                }
            });
            
            peer.on('error', (err) => console.error('Peer error:', err));
        }

        // --- Caller Functions ---
        
        window.startVoiceCall = () => initiateCall('audio');
        window.startVideoCall = () => initiateCall('video');

        async function initiateCall(type) {
            // Robustly get Current Chat ID
            let targetId = (typeof currentChatId !== 'undefined') ? currentChatId : null;
            let targetType = (typeof currentChatType !== 'undefined') ? currentChatType : 'private';
            
            // Fallback: Check DOM if variable is null
            if(!targetId) {
                const activeLi = document.querySelector('.chat-users-tab li.active') || document.querySelector('#chat-msg-scroll li.active');
                if(activeLi) {
                    targetId = activeLi.dataset.id || activeLi.getAttribute('onclick')?.match(/selectUser\(['"]([^'"]+)['"]/)?.[1];
                }
            }

            if(!targetId || targetType !== 'private') {
                 console.warn("No user selected or Group chat");
                 alert("Please select a user to call first."); 
                 return;
            }
            
            // Assign for usage
            const callChatId = targetId;
            const callChatName = (typeof currentChatName !== 'undefined') ? currentChatName : "User";
            const callChatAvatar = (typeof currentChatAvatar !== 'undefined') ? currentChatAvatar : "";
            
            // Track call for saving record
            callPartnerId = callChatId;
            callType = type;
            
            isVideo = (type === 'video');
            
            // 1. Get Media
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: isVideo, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = localStream;
                
                // 2. Show UI (Calling state)
                showOverlay(callChatName, callChatAvatar, "Calling...");
                
                // 3. Signal to User
                socket.emit('call_user', {
                    userToCall: callChatId,
                    from: currentUserId,
                    signal: myPeerId, // Send PeerID
                    name: <%- JSON.stringify((typeof user !== "undefined" && user && user.full_name) ? user.full_name : "User") %>,
                    avatar: <%- JSON.stringify((typeof user !== "undefined" && user && user.profile_picture_url) ? user.profile_picture_url : "") %>,
                    type: type
                });
                
            } catch(e) {
                console.error("Media Error:", e);
                alert("Could not access Camera/Microphone");
            }
        }

        // --- Callee (Receiver) Functions ---

        // socket.on('call_incoming') is handled below...

        window.acceptCall = async () => {
            if(!pendingCallData) return;
            
            isVideo = (pendingCallData.type === 'video');
            
            try {
                // 1. Get Media
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: isVideo, 
                    audio: true 
                });
                document.getElementById('local-video').srcObject = localStream;
                
                // 2. Signal Accept
                socket.emit('answer_call', {
                    to: pendingCallData.from, // caller socket ID
                    signal: myPeerId // my peer ID
                });
                
                showActiveCallUI();
                
            } catch(e) {
                console.error("Accept Error", e);
                alert("Could not access media devices");
                rejectCall();
            }
        };

        window.rejectCall = () => {
            if(pendingCallData) {
                socket.emit('reject_call', { to: pendingCallData.from });
                // Note: The caller will save the "declined" record
            }
            closeCallUI('declined');
        };

        window.endCall = () => {
             if(pendingCallData) { // If incoming and not accepted yet
                 socket.emit('reject_call', { to: pendingCallData.from });
             } else {
                 // Active call - calculate duration and save record
                 const partnerId = callPartnerId || currentChatId;
                 if(partnerId) {
                     socket.emit('end_call', { to: partnerId });
                     
                     // Save call record
                     const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
                     socket.emit('save_call_record', {
                         toUserId: partnerId,
                         callType: callType,
                         duration: duration,
                         status: 'completed'
                     });
                 }
             }
             closeCallUI('completed');
        };

        // --- Socket Events for Calls ---
        
        socket.on('call_incoming', (data) => {
            console.log("Incoming Call:", data);
            pendingCallData = data;
            // Play Ringtone? (Optional)
            
            // Show UI
            showOverlay(data.name, data.avatar, `Incoming ${data.type} call...`);
            
            // Show Incoming Actions, Hide Active Controls
            document.getElementById('incoming-actions').classList.remove('d-none');
            document.getElementById('incoming-actions').classList.add('d-flex');
            
            document.getElementById('active-controls').classList.add('d-none');
            document.getElementById('call-status').innerText = `Incoming ${data.type} call...`;
        });
        
        socket.on('call_accepted', (data) => {
            // I am the Caller. The callee accepted.
            // data.signal contains Callee PeerID.
            console.log("Call Accepted by:", data);
            document.getElementById('call-status').innerText = "Connected";
            
            // Connect Peer
            if(peer && localStream) {
                const call = peer.call(data.signal, localStream);
                handleStream(call);
                showActiveCallUI();
            }
        });
        
        socket.on('call_rejected', () => {
            alert("Call Declined");
            // Save declined call record (caller side)
            if(callPartnerId) {
                socket.emit('save_call_record', {
                    toUserId: callPartnerId,
                    callType: callType,
                    duration: 0,
                    status: 'declined'
                });
            }
            closeCallUI('declined');
        });
        
        socket.on('call_ended', () => {
            closeCallUI();
        });

        // --- Helpers ---
        
        function handleStream(call) {
            currentCall = call;
            call.on('stream', (remoteStream) => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            call.on('close', () => closeCallUI());
        }
        
        function showOverlay(name, avatar, status) {
            const overlay = document.getElementById('call-overlay');
            overlay.classList.remove('d-none');
            
            document.getElementById('call-name').innerText = name || 'Unknown';
            document.getElementById('call-avatar').src = avatar || 'https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg';
            document.getElementById('call-status').innerText = status;
            
            // Show/hide video container based on call type
            const videoContainer = document.getElementById('video-container');
            const localVideo = document.getElementById('local-video');
            if(!isVideo) {
                // Audio call - hide video elements
                videoContainer.style.display = 'none';
                localVideo.style.display = 'none';
                document.getElementById('call-info').classList.remove('d-none');
            } else {
                // Video call - show video elements
                videoContainer.style.display = 'block';
                localVideo.style.display = 'block';
            }
            
            // Reset Buttons
            document.getElementById('incoming-actions').classList.add('d-none');
            document.getElementById('incoming-actions').classList.remove('d-flex');
            document.getElementById('active-controls').classList.add('d-none'); // Hidden until connected or calling? 
            // Actually, if Calling, we want "End Call" button visible.
            
            if(status === 'Calling...') {
                 document.getElementById('active-controls').classList.remove('d-none');
                 document.getElementById('active-controls').classList.add('d-flex');
                 document.getElementById('btn-mute').classList.add('d-none');
                 document.getElementById('btn-video').classList.add('d-none');
                 document.getElementById('btn-fullscreen').classList.add('d-none');
            }
        }
        
        function showActiveCallUI() {
             document.getElementById('incoming-actions').classList.add('d-none');
             document.getElementById('active-controls').classList.remove('d-none');
             document.getElementById('active-controls').classList.add('d-flex');
             
             // Show all controls
             document.getElementById('btn-mute').classList.remove('d-none');
             document.getElementById('btn-video').classList.remove('d-none');
             
             // Only show fullscreen for video calls
             if(isVideo) {
                 document.getElementById('btn-fullscreen').classList.remove('d-none');
                 document.getElementById('call-info').classList.add('d-none'); // Hide avatar when video active
                 document.getElementById('video-container').style.display = 'block';
             } else {
                 document.getElementById('btn-fullscreen').classList.add('d-none');
                 document.getElementById('call-info').classList.remove('d-none'); // Show avatar for audio calls
             }
             
             // Start tracking call duration
             callStartTime = Date.now();
        }
        
        function closeCallUI(status) {
            const overlay = document.getElementById('call-overlay');
            overlay.classList.add('d-none');
            
            // Stop tracks
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if(currentCall) currentCall.close();
            currentCall = null;
            pendingCallData = null;
            
            // Reset call tracking
            callStartTime = null;
            callPartnerId = null;
        }
        
        window.toggleMute = () => {
            if(localStream) {
                const track = localStream.getAudioTracks()[0];
                track.enabled = !track.enabled;
                document.getElementById('btn-mute').classList.toggle('btn-dark');
                document.getElementById('btn-mute').classList.toggle('btn-secondary');
            }
        }
        
        window.toggleVideo = () => {
             if(localStream) {
                const track = localStream.getVideoTracks()[0];
                track.enabled = !track.enabled;
                document.getElementById('btn-video').classList.toggle('btn-dark');
                document.getElementById('btn-video').classList.toggle('btn-secondary');
            }
        }

        window.toggleFullscreen = () => {
            const overlay = document.getElementById('call-overlay');
            if (!document.fullscreenElement) {
                overlay.requestFullscreen().catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Bind Header Buttons (Event Delegation with Capture Phase)
        // Use 'true' to capture event before other scripts might stop propagation
        document.addEventListener('click', (e) => {
             // Find closest button or link
             const btn = e.target.closest('button, a');
             if(!btn) return;
             
             // Check for call buttons in main chat header
             // Video: ri-video-add-line, Phone: ti-phone or ti ti-phone
             const hasPhone = btn.querySelector('.ti-phone') || btn.querySelector('[class*="ti-phone"]');
             const hasVideo = btn.querySelector('.ri-video-add-line') || btn.querySelector('[class*="video-add"]');
             
             // Voice Call
             if(hasPhone && btn.closest('.main-chat-head, #main-chat-header')) {
                 e.preventDefault();
                 e.stopPropagation();
                 console.log("Voice Call Clicked");
                 startVoiceCall();
             }
             // Video Call
             if(hasVideo && btn.closest('.main-chat-head, #main-chat-header')) {
                 e.preventDefault();
                 e.stopPropagation();
                 console.log("Video Call Clicked");
                 startVideoCall();
             }
        }, true);
        
        console.log("Chat Call Script Loaded & Ready");
        
        // Expose socket for debugging
        if(typeof socket !== 'undefined') window.socket = socket;

    });
</script>



<!-- Call Overlay UI -->
<div id="call-overlay" class="call-overlay d-none">
    <!-- Video Container -->
    <div id="video-container" class="w-100 h-100 position-absolute top-0 start-0">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
    </div>

    <!-- Call Info (Name/Status) -->
    <div id="call-info" class="call-info-wrapper">
        <div class="avatar avatar-xxl avatar-rounded mb-4 pulse-avatar">
            <img id="call-avatar" src="https://laravelui.spruko.com/zeno/build/assets/images/faces/9.jpg" alt="">
        </div>
        <h3 id="call-name" class="text-white mb-2">User Name</h3>
        <p id="call-status" class="text-white-50 fs-16">Calling...</p>
        
        <!-- Incoming Call Actions -->
        <div id="incoming-actions" class="d-none gap-4 mt-5 justify-content-center">
            <button class="btn btn-danger btn-lg rounded-circle p-4" onclick="rejectCall()">
                <i class="ri-phone-line fs-24" style="transform: rotate(135deg)"></i>
            </button>
            <button class="btn btn-success btn-lg rounded-circle p-4 pulse-avatar" onclick="acceptCall()">
                <i class="ri-phone-fill fs-24"></i>
            </button>
        </div>
    </div>

    <!-- Active Call Controls -->
    <div id="active-controls" class="call-controls-wrapper d-none">
        <button class="btn btn-dark btn-icon rounded-circle btn-lg" id="btn-mute" onclick="toggleMute()">
            <i class="ri-mic-line fs-20"></i>
        </button>
        <button class="btn btn-dark btn-icon rounded-circle btn-lg" id="btn-video" onclick="toggleVideo()">
            <i class="ri-video-on-line fs-20"></i>
        </button>
        <button class="btn btn-dark btn-icon rounded-circle btn-lg" id="btn-fullscreen" onclick="toggleFullscreen()">
            <i class="ri-fullscreen-line fs-20"></i>
        </button>
        <button class="btn btn-danger btn-icon rounded-circle btn-lg" onclick="endCall()" style="width: 50px; height: 50px;">
            <i class="ri-phone-fill fs-20" style="transform: rotate(135deg)"></i>
        </button>
    </div>
</div>

<!-- Create Channel Modal -->
<div class="modal fade" id="createChannelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Create New Channel</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Channel Name</label>
                    <input type="text" class="form-control" id="new-channel-name" placeholder="e.g. general, hiring">
                </div>
                <div class="mb-3">
                    <label class="form-label">Privacy</label>
                    <select class="form-select" id="new-channel-type">
                        <option value="public">Public (All Team Members)</option>
                        <option value="private">Private (Invite Only)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createChannel()">Create Channel</button>
            </div>
        </div>
    </div>
</div> 

<!-- Channel Info Modal -->
<div class="modal fade" id="channelInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Channel Management</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-outline-primary" onclick="addAllTeamToChannel()">
                        <i class="ri-team-line me-2"></i> Add ALL Team Members
                    </button>
                </div>
                
                <h6 class="fw-bold">Add Individual Member</h6>
                <div class="input-group mb-4">
                    <select class="form-select" id="channel-new-member-select">
                        <option value="">Loading members...</option>
                    </select>
                    <button class="btn btn-primary" type="button" onclick="addMemberToCurrentChannel()">Add</button>
                </div>
                
                <h6 class="fw-bold">Current Members</h6>
                <ul class="list-group list-group-flush" id="channel-member-list" style="max-height: 200px; overflow-y: auto;">
                    <li class="list-group-item text-center text-muted">Loading...</li>
                </ul>
            </div>
        </div>
    </div>
</div> 