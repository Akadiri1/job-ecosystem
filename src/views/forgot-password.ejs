<%- include('includes/header', { title: 'Reset Password - Job Ecosystem' }) %>

<style>
    /* --- SAME STYLING AS LOGIN/REGISTER --- */
    /* Force Dark Inputs */
    input:-webkit-autofill,
    input:-webkit-autofill:hover, 
    input:-webkit-autofill:focus, 
    input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px #455a64 inset !important; 
        -webkit-text-fill-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    .input-field input[type=email] {
        border-bottom: 1px solid rgba(255,255,255,0.5) !important;
        color: white !important;
    }

    .input-field input:focus {
        border-bottom: 1px solid #ba68c8 !important;
        box-shadow: 0 1px 0 0 #ba68c8 !important;
    }

    .input-field label {
        color: rgba(255,255,255,0.7) !important;
    }

    .input-field input:focus + label {
        color: #ba68c8 !important;
    }

    /* Button Styling */
    .btn-reset {
        background: #7b1fa2;
        background: linear-gradient(45deg, #7b1fa2, #ba68c8);
        border-radius: 50px;
        font-weight: bold;
        letter-spacing: 1px;
        width: 80%;
    }
</style>

<div class="content-area">
    <div class="login-bg access-forgot"></div>

    <div class="container login-area">
        <div class="section">

            <h3 class="bot-20 center white-text" style="font-weight: 300;">Forgot Password</h3>
            
            <p class="center white-text" style="opacity: 0.8; margin-bottom: 30px;">
                Enter your email address and we will send you an OTP code to reset your password.
            </p>

            <form id="resetForm">
                <div class="row">
                    <div class="input-field col s10 offset-s1">
                        <input id="email3" type="email" class="validate" required>
                        <label for="email3">Email Address</label>
                    </div>
                </div>

                <div class="row">
                    <div class="col s10 offset-s1">
                        <div id="messageBox" style="text-align: center; font-weight: bold; margin-bottom: 15px;"></div>
                    </div>
                </div>

                <div class="row center">
                    <button type="submit" class="waves-effect waves-light btn-large btn-reset">
                        Send OTP
                    </button>
                    
                    <div class="spacer" style="height: 20px;"></div>
                    
                    <div class="links white-text">
                        <a href="/login" style="color: rgba(255,255,255,0.8);">Back to Login</a>
                        <span class="sep" style="margin: 0 10px;">|</span>
                        <a href="/signup" style="color: rgba(255,255,255,0.8);">Register</a>
                    </div>
                    
                    <div class="spacer"></div>
                </div>
            </form>

        </div>
    </div>
</div>
<script>
    document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const messageBox = document.getElementById('messageBox');
        messageBox.innerText = "Sending OTP...";
        messageBox.style.color = "white";

        const email = document.getElementById('email3').value;

        try {
            const response = await fetch('/api/auth/forgot-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await response.json();

            if (response.ok) {
                messageBox.style.color = "#00e676"; 
                messageBox.innerHTML = "‚úÖ OTP Sent! Redirecting...";
                
                // üëá REDIRECT TO RESET PAGE WITH EMAIL
                setTimeout(() => { 
                    // We put the email in the URL so we can auto-fill it on the next page
                    window.location.href = `/reset-password?email=${encodeURIComponent(email)}`; 
                }, 1500);
            } else {
                messageBox.style.color = "#ff5252"; 
                messageBox.innerText = "‚ùå " + (data.error || "Failed to send email");
            }
        } catch (err) {
            console.error(err);
            messageBox.style.color = "#ff5252";
            messageBox.innerText = "‚ùå Server Error";
        }
    });
</script>

<%- include('includes/footer') %>