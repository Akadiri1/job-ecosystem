<aside class="app-sidebar sticky" id="sidebar">
    <div class="main-sidebar-header">
        <a href="/dashboard" class="header-logo">
            <!-- Logo Removed -->
        </a>
    </div>

    <div class="main-sidebar" id="sidebar-scroll">
        <nav class="main-menu-container nav nav-pills flex-column sub-open">
            <div class="slide-left" id="slide-left"><svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z"></path></svg></div>
            
            <ul class="main-menu">
                <!-- DASHBOARD -->
                <li class="slide">
                    <a href="/dashboard/employee" class="side-menu__item">
                        <i class="ri-home-4-line side-menu__icon"></i>
                        <span class="side-menu__label">Dashboard</span>
                    </a>
                </li>

                <!-- EMPLOYEE MENU -->
                <li class="slide__category"><span class="category-name">Team Workspace</span></li>
                <li class="slide">
                    <a href="/dashboard/employee/chat" class="side-menu__item">
                        <i class="ri-chat-1-line side-menu__icon"></i>
                        <span class="side-menu__label">Team Chat</span>
                    </a>
                </li>
                <li class="slide">
                    <a href="/dashboard/employee/tasks" class="side-menu__item">
                        <i class="ri-task-line side-menu__icon"></i>
                        <span class="side-menu__label">My Tasks</span>
                    </a>
                </li>
                <li class="slide">
                    <a href="/dashboard/employee/docs" class="side-menu__item">
                        <i class="ri-book-open-line side-menu__icon"></i>
                        <span class="side-menu__label">Company Docs</span>
                    </a>
                </li>
                <li class="slide">
                    <a href="/dashboard/employee/ai-assistant" class="side-menu__item">
                        <i class="ri-robot-line side-menu__icon"></i>
                        <span class="side-menu__label">AI Assistant</span>
                    </a>
                </li>

                <!-- PRIVILEGED MODULES (Hidden by default) -->
                <li class="slide d-none" id="nav-manage-team">
                    <a href="/dashboard/employee/team" class="side-menu__item">
                        <i class="ri-team-line side-menu__icon"></i>
                        <span class="side-menu__label">Manage Team</span>
                    </a>
                </li>

                <!-- RECRUITMENT (Hidden by default) -->
                <li class="slide__category d-none" id="nav-head-recruitment"><span class="category-name">Recruitment</span></li>
                <li class="slide d-none" id="nav-post-job">
                    <a href="/dashboard/employee/jobs/create" class="side-menu__item">
                        <i class="ri-briefcase-line side-menu__icon"></i>
                        <span class="side-menu__label">Post a Job</span>
                    </a>
                </li>
                <li class="slide d-none" id="nav-candidates">
                    <a href="/dashboard/employee/candidates" class="side-menu__item">
                        <i class="ri-user-search-line side-menu__icon"></i>
                        <span class="side-menu__label">Candidates</span>
                    </a>
                </li>

                <!-- SETTINGS MENU -->
                <li class="slide__category"><span class="category-name">Settings</span></li>
                <li class="slide">
                    <a href="/dashboard/employee/profile" class="side-menu__item">
                        <i class="ri-user-settings-line side-menu__icon"></i>
                        <span class="side-menu__label">User Profile</span>
                    </a>
                </li>
                <li class="slide">
                    <a href="javascript:void(0);" onclick="logout()" class="side-menu__item">
                        <i class="ri-logout-box-r-line side-menu__icon"></i>
                        <span class="side-menu__label">Log Out</span>
                    </a>
                </li>
            </ul>
            <div class="slide-right" id="slide-right"><svg xmlns="http://www.w3.org/2000/svg" fill="#7b8191" width="24" height="24" viewBox="0 0 24 24"><path d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z"></path></svg></div>
        </nav>
    </div>
</aside>

<!-- Script to handle active state & Permissions -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // 1. Active State
    const currentPath = window.location.pathname;
    const menuItems = document.querySelectorAll('.side-menu__item');
    
    menuItems.forEach(item => {
        if (item.getAttribute('href') === currentPath) {
            item.classList.add('active');
            item.parentElement.classList.add('active');
        }
    });

    // 2. Fetch & Apply Permissions
    checkSidebarPermissions();
});

async function checkSidebarPermissions() {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const response = await fetch('/api/team/my-membership', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.success && data.membership) {
            let perms = data.membership.permissions || [];
            // Handle possible string format
            if (typeof perms === 'string') {
                try { perms = JSON.parse(perms); } catch(e) { perms = []; }
            }

            // Toggle Links
            if (perms.includes('manage_team')) {
                document.getElementById('nav-manage-team').classList.remove('d-none');
            }
            
            if (perms.includes('post_jobs') || perms.includes('view_applicants')) {
                document.getElementById('nav-head-recruitment').classList.remove('d-none');
            }

            if (perms.includes('post_jobs')) {
                document.getElementById('nav-post-job').classList.remove('d-none');
            }

            if (perms.includes('view_applicants') || perms.includes('manage_applicants')) {
                document.getElementById('nav-candidates').classList.remove('d-none');
            }
        }
    } catch (e) {
        console.error("Sidebar Permission Check Failed", e);
    }
}
</script>
