<%- include('includes/header2', { title: 'Company Settings' }) %>

<!-- TOASTIFY CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

<style>
    .employer-only, .seeker-only { display: none !important; }
    
    /* Company Hero */
    .company-hero {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        color: #fff;
        position: relative;
        overflow: hidden;
    }
    
    .company-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
    }
    
    .company-hero h1 {
        font-weight: 700;
        font-size: 1.75rem;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 1;
    }
    
    .company-hero p {
        color: rgba(255,255,255,0.8);
        margin-bottom: 0;
        position: relative;
        z-index: 1;
    }
    
    /* Company Card */
    .company-card {
        background: var(--custom-white);
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.08);
        overflow: hidden;
    }
    
    .company-tabs {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .company-tabs .nav-link {
        border-radius: 10px;
        padding: 0.6rem 1.25rem;
        font-weight: 500;
        color: var(--default-text-color);
        transition: all 0.2s ease;
        border: none;
    }
    
    .company-tabs .nav-link.active {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: #fff;
    }
    
    .company-tabs .nav-link:hover:not(.active) {
        background: rgba(240, 147, 251, 0.1);
    }
    
    .company-content {
        padding: 1.5rem;
    }
    
    .logo-upload {
        position: relative;
        display: inline-block;
    }
    
    .logo-upload .logo-preview {
        width: 100px;
        height: 100px;
        border-radius: 16px;
        object-fit: cover;
        border: 3px solid rgba(240, 147, 251, 0.2);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .logo-upload .btn-upload {
        position: absolute;
        bottom: -5px;
        right: -5px;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: #fff;
        border: 3px solid var(--custom-white);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    
    .btn-save-company {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: #fff;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-save-company:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        color: #fff;
    }
    
    .section-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-title i {
        color: #f093fb;
    }
    
    /* Enhanced Form Styles */
    .form-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .form-section-header h6 {
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-section-header h6 i {
        color: #f093fb;
    }
    
    /* Logo Upload Section */
    .logo-upload-section {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1.5rem;
        background: rgba(240, 147, 251, 0.05);
        border-radius: 16px;
        margin-bottom: 1.5rem;
    }
    
    .logo-preview-wrapper {
        position: relative;
    }
    
    .logo-preview-img {
        width: 100px;
        height: 100px;
        border-radius: 16px;
        object-fit: cover;
        border: 3px solid rgba(240, 147, 251, 0.2);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .logo-info h6 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .logo-info p {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }
    
    .btn-upload-logo {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }
    
    .btn-upload-logo:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
        color: #fff;
    }
    
    .btn-remove-logo {
        background: rgba(255, 100, 100, 0.1);
        border: 1px solid rgba(255, 100, 100, 0.2);
        color: #ff6464;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.85rem;
        transition: all 0.2s ease;
    }
    
    .btn-remove-logo:hover {
        background: rgba(255, 100, 100, 0.2);
        color: #ff6464;
    }
    
    /* Form Fields */
    .form-label {
        font-weight: 500;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
        color: var(--default-text-color);
    }
    
    .form-control, .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(255,255,255,0.1);
        background: var(--custom-white);
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #f093fb;
        box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.15);
    }
    
    textarea.form-control {
        min-height: 100px;
    }
    
    /* Notification Items */
    .notification-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .notification-item:last-child {
        border-bottom: none;
    }
    
    .notification-item .info h6 {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .notification-item .info p {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0;
    }
    
    /* Footer Buttons */
    .company-footer {
        padding: 1.25rem 1.5rem;
        border-top: 1px solid rgba(255,255,255,0.05);
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .btn-deactivate {
        background: rgba(255, 100, 100, 0.1);
        border: 1px solid rgba(255, 100, 100, 0.3);
        color: #ff6464;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    
    .btn-deactivate:hover {
        background: rgba(255, 100, 100, 0.2);
        color: #ff6464;
    }
    
    .btn-save-company {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        color: #fff;
        padding: 0.75rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-save-company:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        color: #fff;
    }
    
    /* Ensure bottom padding for scroll */
    .container-fluid {
        padding-bottom: 2rem;
    }
</style>

<div class="page" id="mainPage">

    <div class="main-content app-content">
    <%- include(sidebar) %>
        <div class="container-fluid">

            <!-- Modern Hero Header -->
            <div class="company-hero" style="margin-top: 1.5rem;">
                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                    <div>
                        <h1><i class="ri-building-2-line me-2"></i>Company Settings</h1>
                        <p>Manage your company profile and preferences</p>
                    </div>
                    <a href="/dashboard" class="btn btn-light">
                        <i class="ri-arrow-left-line me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>

                    <!-- Start::row-1 -->
                    <div class="row gap-3 justify-content-center">
                        <div class="col-xl-9">
                            <div class="company-card">
                                <div class="company-tabs">
                                    <ul class="nav nav-pills gap-2 mb-0" id="myTab4" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="account" data-bs-toggle="tab" data-bs-target="#account-pane" type="button" role="tab" aria-selected="true"><i class="ri-building-line me-1"></i>Account</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="notification-tab" data-bs-toggle="tab" data-bs-target="#notification-tab-pane" type="button" role="tab" aria-selected="false"><i class="ri-notification-3-line me-1"></i>Notification</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security-tab-pane" type="button" role="tab" aria-selected="false"><i class="ri-shield-line me-1"></i>Security</button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="company-content tab-content">
                                    <div class="tab-pane overflow-hidden p-0 border-0 active show" id="account-pane" role="tabpanel" aria-labelledby="account" tabindex="0">
                                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-1">
                                            <div class="fw-semibold d-block fs-15">Company Details :</div>
                                            <div class="btn btn-primary btn-sm" id="restoreBtn"><i class="ri-loop-left-line lh-1 me-2"></i>Restore Changes</div>
                                        </div>
                                        <div class="row gy-3">
                                            <div class="col-xl-12">
                                                <div class="d-flex align-items-start flex-wrap gap-3">
                                                    <div>
                                                        <span class="avatar avatar-xxl">
                                                            <img id="company-logo-preview" src="/build/assets/images/brand-logos/desktop-logo.png" alt="Company Logo">
                                                        </span>
                                                    </div>
                                                    <div>
                                                        <span class="fw-medium d-block mb-2">Company Logo</span>
                                                        <input type="file" id="logo-input" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                                                        <div class="btn-list mb-1">
                                                            <button type="button" id="changeImageBtn" class="btn btn-sm btn-primary btn-wave waves-effect waves-light"><i class="ri-upload-2-line me-1"></i>Change Image</button>
                                                            <button type="button" id="removeImageBtn" class="btn btn-sm btn-success-light btn-wave waves-effect waves-light"><i class="ri-delete-bin-line me-1"></i>Remove</button>
                                                        </div>
                                                        <span class="d-block fs-12 text-muted">Use JPEG, PNG, or GIF. Best size: 200x200 pixels. Keep it under 5MB</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-xl-6">
                                                <label for="company-name" class="form-label">Company Name : <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control" id="company-name" value="" placeholder="Enter Company Name" required minlength="2">
                                                <div class="invalid-feedback">Company name is required (min 2 characters)</div>
                                            </div>
                                            <div class="col-xl-6">
                                                <label for="industry" class="form-label">Industry :</label>
                                                <input type="text" class="form-control" id="industry" value="" placeholder="Enter Industry (e.g. Tech, Health)">
                                            </div>
                                            <div class="col-xl-6">
                                                <label for="location" class="form-label">Location :</label>
                                                <input type="text" class="form-control" id="location" value="" placeholder="Enter Location">
                                            </div>
                                            <div class="col-xl-6">
                                                <label for="website" class="form-label">Website :</label>
                                                <input type="url" class="form-control bg-light" id="website" placeholder="https://" value="">
                                                <div class="invalid-feedback">Please enter a valid URL</div>
                                            </div>
                                            <div class="col-xl-12">
                                                <label for="description" class="form-label">Description :</label>
                                                <textarea class="form-control" id="description" rows="3" placeholder="Company Description" minlength="10"></textarea>
                                                <div class="invalid-feedback">Description should be at least 10 characters</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane overflow-hidden p-0 border-0" id="notification-tab-pane" role="tabpanel" aria-labelledby="notification-tab" tabindex="0">
                                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-1">
                                            <div class="fw-semibold d-block fs-15">Notifications Settings:</div>
                                            <div class="btn btn-primary btn-sm"><i class="ri-loop-left-line lh-1 me-2"></i>Restore Changes</div>
                                        </div>
                                        <div class="row gx-5 gy-3">
                                            <div class="col-xl-12">
                                                <p class="fs-14 mb-1 fw-medium">Configure Notifications</p>
                                                <p class="fs-12 mb-0 text-muted">Users can tailor their experience to receive alerts for the types of events that matter to them.</p>
                                            </div>
                                            <div class="col-xl-12">
                                                <div class="d-flex align-items-top justify-content-between mt-3">
                                                    <div class="mail-notification-settings">
                                                        <p class="fs-14 mb-1 fw-medium">Push Notifications</p>
                                                        <p class="fs-12 mb-0 text-muted">Alerts sent to the user's mobile device or desktop.</p>
                                                    </div>
                                                    <div class="toggle on toggle-success mb-0 float-sm-end" id="push-notifications">
                                                        <span></span>
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-top justify-content-between mt-3">
                                                    <div class="mail-notification-settings">
                                                        <p class="fs-14 mb-1 fw-medium">Email Notifications</p>
                                                        <p class="fs-12 mb-0 text-muted">Messages sent to the user's email address.</p>
                                                    </div>
                                                    <div class="toggle toggle-success mb-0 float-sm-end" id="email-notifications">
                                                        <span></span>
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-top justify-content-between mt-3">
                                                    <div class="mail-notification-settings">
                                                        <p class="fs-14 mb-1 fw-medium">In-App Notifications</p>
                                                        <p class="fs-12 mb-0 text-muted">Alerts that appear within the application interface.</p>
                                                    </div>
                                                    <div class="toggle toggle-success mb-0 float-sm-end" id="in-app-notifications">
                                                        <span></span>
                                                    </div>
                                                </div>
                                                <div class="d-flex align-items-top justify-content-between mt-3">
                                                    <div class="mail-notification-settings">
                                                        <p class="fs-14 mb-1 fw-medium">SMS Notifications</p>
                                                        <p class="fs-12 mb-0 text-muted">Text messages sent to the user's mobile phone.</p>
                                                    </div>
                                                    <div class="toggle toggle-success on mb-0 float-sm-end" id="sms-notifications">
                                                        <span></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane overflow-hidden p-0 border-0" id="security-tab-pane" role="tabpanel" aria-labelledby="security-tab" tabindex="0">
                                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-1">
                                            <div class="fw-semibold d-block fs-15">Security Settings :</div>
                                            <div class="btn btn-primary btn-sm"><i class="ri-loop-left-line lh-1 me-2"></i>Restore Changes</div>
                                        </div>
                                        <div class="d-sm-flex d-block align-items-top justify-content-between">
                                            <div class="w-50">
                                                <p class="fs-14 mb-1 fw-medium">Verification</p>
                                                <p class="fs-12 mb-0 text-muted">Control how your profile information is verified for security purposes.</p>
                                            </div>
                                            <div class="d-flex gap-4">
                                                <div class="form-check ">
                                                    <input class="form-check-input" type="checkbox" value="" id="email-notifications01" checked="">
                                                    <label class="form-check-label" for="email-notifications01">
                                                        Email
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="" id="sms-notifications01">
                                                    <label class="form-check-label" for="sms-notifications01">
                                                        SMS
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="" id="phone-notifications">
                                                    <label class="form-check-label" for="phone-notifications">
                                                        Phone
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-sm-flex d-block align-items-top justify-content-between mt-3">
                                            <div class="w-50">
                                                <p class="fs-14 mb-1 fw-medium">Login Verification</p>
                                                <p class="fs-12 mb-0 text-muted">This helps protect accounts from unauthorized access, even if a password is compromised.</p>
                                            </div>
                                            <a href="javascript:void(0);" class="link-primary text-decoration-underline">Set Up Verification</a>
                                        </div>
                                        <div class="d-sm-flex d-block align-items-top justify-content-between mt-3">
                                            <div class="w-50">
                                                <p class="fs-14 mb-1 fw-medium">Password Verification</p>
                                                <p class="fs-12 mb-0 text-muted">This additional step helps ensure that the person attempting to modify account details is the legitimate account owner.</p>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" value="" id="personal-details">
                                                <label class="form-check-label" for="personal-details">
                                                    Require Personal Details
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="company-footer">
                                    <button class="btn btn-deactivate" id="deactivateBtn"><i class="ri-delete-bin-line me-1"></i>Deactivate Account</button>
                                    <button class="btn btn-save-company" id="saveBtn"><i class="ri-save-line me-1"></i>Update Company</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--End::row-1 -->

                    
                </div>
            </div>
</div>

<!-- TOASTIFY JS -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    let isEditMode = false;
    let initialCompanyData = {}; // Store for restore functionality

    // 1. AUTH & DATA LOAD
    document.addEventListener("DOMContentLoaded", async function() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        // Handle Sidebar Roles
        try {
            const res = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if (res.ok) {
                const user = data.user;
                if (user.role === 'employer') {
                    document.querySelectorAll('.employer-only').forEach(el => el.style.setProperty('display', 'block', 'important'));
                } else {
                    document.querySelectorAll('.seeker-only').forEach(el => el.style.setProperty('display', 'block', 'important'));
                }
            }
        } catch(err) { console.error(err); }

        // Fetch Existing Company Data
        try {
            console.log('Fetching company data...');
            const response = await fetch('/api/company/me', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            console.log('Fetch response status:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('Company data received:', data);
                const company = data.company;
                initialCompanyData = company; // Save for restore functionality
                
                // Switch to Edit Mode
                isEditMode = true;
                document.getElementById('saveBtn').innerText = "Update Company";
                
                // Pre-fill Fields
                document.getElementById('company-name').value = company.name || "";
                document.getElementById('industry').value = company.industry || "";
                document.getElementById('location').value = company.location || "";
                document.getElementById('website').value = company.website || "";
                document.getElementById('description').value = company.description || "";
                
                // Load company logo if exists
                if (company.logo_url) {
                    console.log('Setting logo URL:', company.logo_url);
                    document.getElementById('company-logo-preview').src = company.logo_url;
                }
            } else {
                console.log('No existing company found or error fetching.');
            }
            // Show Page
            document.getElementById('mainPage').style.display = 'block';

        } catch (error) {
            console.error("Error fetching company data:", error);
            document.getElementById('mainPage').style.display = 'block';
        }
    });

    // 2. TOAST HELPER
    function showToast(message, type = 'success') {
        let bg = type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)";
        Toastify({
            text: message,
            duration: 3000,
            close: true,
            gravity: "top", 
            position: "right", 
            stopOnFocus: true, 
            style: { background: bg, borderRadius: "10px", fontWeight: "500" },
        }).showToast();
    }

    // 2.5 IMAGE UPLOAD HANDLERS
    document.getElementById('changeImageBtn').addEventListener('click', function() {
        document.getElementById('logo-input').click();
    });

    document.getElementById('logo-input').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file size (5MB)
        if (file.size > 5 * 1024 * 1024) {
            showToast("❌ File is too large. Maximum size is 5MB.", "error");
            return;
        }

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            showToast("❌ Only JPEG, PNG, GIF, and WebP images are allowed.", "error");
            return;
        }

        const token = localStorage.getItem('token');
        const formData = new FormData();
        formData.append('logo', file);

        const btn = document.getElementById('changeImageBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="ri-loader-4-line me-1 spin"></i>Uploading...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/company/logo', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                showToast("✅ Logo uploaded successfully!");
                document.getElementById('company-logo-preview').src = data.logo_url + '?t=' + Date.now();
            } else {
                showToast("❌ " + (data.error || "Failed to upload logo"), "error");
            }
        } catch (error) {
            console.error("Upload error:", error);
            showToast("❌ Network error uploading logo", "error");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            e.target.value = ''; // Reset file input
        }
    });

    document.getElementById('removeImageBtn').addEventListener('click', async function() {
        if (!confirm("Are you sure you want to remove the company logo?")) return;

        const token = localStorage.getItem('token');
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="ri-loader-4-line me-1"></i>Removing...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/company/logo', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (response.ok) {
                showToast("✅ Logo removed successfully!");
                document.getElementById('company-logo-preview').src = '/build/assets/images/brand-logos/desktop-logo.png';
            } else {
                showToast("❌ " + (data.error || "Failed to remove logo"), "error");
            }
        } catch (error) {
            console.error("Remove error:", error);
            showToast("❌ Network error removing logo", "error");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    // 3. FORM VALIDATION
    function validateForm() {
        const companyName = document.getElementById('company-name').value.trim();
        const industry = document.getElementById('industry').value.trim();
        const location = document.getElementById('location').value.trim();
        const website = document.getElementById('website').value.trim();
        const description = document.getElementById('description').value.trim();

        // Clear previous validation states
        clearValidationErrors();

        let isValid = true;
        let errors = [];

        // Company Name - Required
        if (!companyName) {
            isValid = false;
            errors.push("Company Name is required");
            markFieldInvalid('company-name');
        } else if (companyName.length < 2) {
            isValid = false;
            errors.push("Company Name must be at least 2 characters");
            markFieldInvalid('company-name');
        } else {
            markFieldValid('company-name');
        }

        // Industry - Recommended but not required
        if (industry) {
            markFieldValid('industry');
        }

        // Location - Recommended but not required
        if (location) {
            markFieldValid('location');
        }

        // Website - Optional but validate format if provided
        if (website && website !== 'https://') {
            const urlPattern = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/i;
            if (!urlPattern.test(website)) {
                isValid = false;
                errors.push("Please enter a valid website URL (e.g., https://www.example.com)");
                markFieldInvalid('website');
            } else {
                markFieldValid('website');
            }
        }

        // Description - Recommended but not required
        if (description) {
            if (description.length < 10) {
                isValid = false;
                errors.push("Description should be at least 10 characters");
                markFieldInvalid('description');
            } else {
                markFieldValid('description');
            }
        }

        // Show all errors
        if (errors.length > 0) {
            errors.forEach(error => showToast("❌ " + error, "error"));
        }

        return isValid;
    }

    function markFieldInvalid(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        field.style.borderColor = '#dc3545';
    }

    function markFieldValid(fieldId) {
        const field = document.getElementById(fieldId);
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        field.style.borderColor = '#28a745';
    }

    function clearValidationErrors() {
        const fields = ['company-name', 'industry', 'location', 'website', 'description'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.classList.remove('is-invalid', 'is-valid');
            field.style.borderColor = '';
        });
    }

    // Real-time validation on blur
    document.getElementById('company-name').addEventListener('blur', function() {
        const value = this.value.trim();
        if (!value) {
            markFieldInvalid('company-name');
        } else if (value.length < 2) {
            markFieldInvalid('company-name');
        } else {
            markFieldValid('company-name');
        }
    });

    document.getElementById('website').addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && value !== 'https://') {
            const urlPattern = /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/i;
            if (!urlPattern.test(value)) {
                markFieldInvalid('website');
            } else {
                markFieldValid('website');
            }
        }
    });

    document.getElementById('description').addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && value.length < 10) {
            markFieldInvalid('description');
        } else if (value) {
            markFieldValid('description');
        }
    });

    // 4. SAVE LOGIC
    document.getElementById('saveBtn').addEventListener('click', async function() {
        // Validate form before submission
        if (!validateForm()) {
            return; // Stop submission if validation fails
        }

        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.innerText = "Saving...";
        btn.disabled = true;

        const token = localStorage.getItem('token');
        const formData = {
            name: document.getElementById('company-name').value.trim(),
            industry: document.getElementById('industry').value.trim(),
            location: document.getElementById('location').value.trim(),
            website: document.getElementById('website').value.trim(),
            description: document.getElementById('description').value.trim()
        };

        const method = isEditMode ? 'PUT' : 'POST';
        const url = '/api/company';

        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                showToast(isEditMode ? "✅ Company Updated!" : "✅ Company Created Successfully!");
                
                if (!isEditMode) {
                    // Redirect new users to Post Job
                    setTimeout(() => { window.location.href = '/jobs/create'; }, 1500);
                } else {
                    isEditMode = true;
                    btn.innerText = "Update Company";
                }
            } else {
                showToast("❌ " + data.error, "error");
            }
        } catch (error) {
            console.error(error);
            showToast("❌ Network Error", "error");
        } finally {
            if(btn.innerText !== "Update Company") btn.innerText = originalText;
            btn.disabled = false;
        }
    });

    // 5. DEACTIVATE LOGIC (30-day soft delete)
    document.getElementById('deactivateBtn').addEventListener('click', async function() {
        if(!confirm("Are you sure you want to deactivate your company profile?\n\n⚠️ Your profile will be permanently deleted after 30 days.\n✓ You can reactivate it within 30 days from Company Settings.")) return;

        const btn = document.getElementById('deactivateBtn');
        btn.innerText = "Deactivating...";
        btn.disabled = true;

        const token = localStorage.getItem('token');
        try {
            const response = await fetch('/api/company', {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (response.ok) {
                showToast("⏳ Company deactivated. You have 30 days to reactivate.");
                
                // Show reactivation notice instead of clearing form
                setTimeout(() => { 
                    alert("Your company profile has been deactivated.\n\nYou can reactivate it within 30 days by visiting Company Settings.\n\nPermanent deletion date: " + new Date(data.permanent_deletion_date).toLocaleDateString());
                    window.location.reload(); 
                }, 1500);
            } else {
                showToast("❌ " + (data.error || "Failed to deactivate"), "error");
            }
        } catch(err) {
            console.error(err);
            showToast("❌ Network Error", "error");
        } finally {
            btn.innerText = "Deactivate Account";
            btn.disabled = false;
        }
    });

    // 7. RESTORE CHANGES
    document.getElementById('restoreBtn').addEventListener('click', function() {
        if (!isEditMode || !initialCompanyData.name) {
             // If not in edit mode, or no data loaded, just clear fields
             if(confirm("Clear all fields?")) {
                document.getElementById('company-name').value = '';
                document.getElementById('industry').value = '';
                document.getElementById('location').value = '';
                document.getElementById('website').value = '';
                document.getElementById('description').value = '';
             }
             return;
        }

        if(confirm("Discard current changes and restore saved details?")) {
            const company = initialCompanyData;
            document.getElementById('company-name').value = company.name || "";
            document.getElementById('industry').value = company.industry || "";
            document.getElementById('location').value = company.location || "";
            document.getElementById('website').value = company.website || "";
            document.getElementById('description').value = company.description || "";
            
            if (company.logo_url) {
                document.getElementById('company-logo-preview').src = company.logo_url;
            } else {
                 document.getElementById('company-logo-preview').src = "/build/assets/images/brand-logos/desktop-logo.png";
            }
            
            clearValidationErrors();
            showToast("ℹ️ Changes restored from database.");
        }
    });

    // 8. LOGOUT
    function logout() {
        localStorage.clear();
        window.location.href = '/login';
    }
</script>

<%- include('includes/footer2') %>