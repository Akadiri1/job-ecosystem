<%- include('includes/header2', { title: 'Task Board' }) %>

<style>
    /* --- Custom UI Polish --- */
    :root {
        --primary-soft: rgba(13, 110, 253, 0.1);
        --success-soft: rgba(25, 135, 84, 0.1);
        --warning-soft: rgba(255, 193, 7, 0.1);
        --danger-soft: rgba(220, 53, 69, 0.1);
    }

    .main-content-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .main-content-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }

    /* Table Improvements */
    .table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        color: #6c757d;
        border-bottom: 1px solid #dee2e6;
    }

    .table-hover tbody tr:hover {
        background-color: #fcfcfc;
    }

    .task-title {
        font-weight: 600;
        color: #343a40;
        text-decoration: none;
    }

    .task-id-badge {
        font-family: 'Courier New', monospace;
        background: #f1f3f5;
        color: #495057;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
    }

    /* Stacked Avatars */
    .avatar-list-stacked {
        display: flex;
        padding-left: 10px;
    }

    .avatar-list-stacked .avatar {
        margin-left: -12px;
        border: 2px solid #fff;
        transition: transform 0.2s;
        cursor: pointer;
    }

    .avatar-list-stacked .avatar:hover {
        transform: translateY(-2px);
        z-index: 5;
    }

    /* Status Select */
    .status-select {
        border: 1px solid transparent;
        background-color: transparent;
        font-weight: 500;
        cursor: pointer;
        padding: 0.25rem 1.5rem 0.25rem 0.5rem;
        background-position: right 0.2rem center;
        transition: all 0.2s;
        border-radius: 6px;
    }

    .status-select:hover:not(:disabled) {
        background-color: #f8f9fa;
        border-color: #dee2e6;
    }
    
    .status-select:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Skeleton Animation */
    @keyframes shimmer {
        0% { background-position: -1000px 0; }
        100% { background-position: 1000px 0; }
    }

    .skeleton {
        animation: shimmer 2s infinite linear;
        background: linear-gradient(to right, #eff1f3 4%, #e2e2e2 25%, #eff1f3 36%);
        background-size: 1000px 100%;
        border-radius: 4px;
        display: inline-block;
        height: 1rem;
    }
    
    /* Utility */
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
</style>

<div class="page">
    <%- include(sidebar) %>

    <div class="main-content app-content">
        <div class="container-fluid">

            <div class="row mt-4">
                <div class="col-xxl-3 col-xl-6 col-lg-6 col-md-6 mb-3">
                    <div class="card custom-card main-content-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-md bg-primary-transparent text-primary">
                                        <i class="ri-task-line fs-5"></i>
                                    </span>
                                </div>
                                <div class="flex-fill">
                                    <span class="text-muted fs-12 text-uppercase fw-semibold">New Tasks</span>
                                    <h4 class="fw-bold mb-0 mt-1" id="stat-new">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xxl-3 col-xl-6 col-lg-6 col-md-6 mb-3">
                    <div class="card custom-card main-content-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-md bg-secondary-transparent text-secondary">
                                        <i class="ri-loader-line fs-5"></i>
                                    </span>
                                </div>
                                <div class="flex-fill">
                                    <span class="text-muted fs-12 text-uppercase fw-semibold">In Progress</span>
                                    <h4 class="fw-bold mb-0 mt-1" id="stat-inprogress">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xxl-3 col-xl-6 col-lg-6 col-md-6 mb-3">
                    <div class="card custom-card main-content-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-md bg-warning-transparent text-warning">
                                        <i class="ri-time-line fs-5"></i>
                                    </span>
                                </div>
                                <div class="flex-fill">
                                    <span class="text-muted fs-12 text-uppercase fw-semibold">Pending Review</span>
                                    <h4 class="fw-bold mb-0 mt-1" id="stat-pending">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xxl-3 col-xl-6 col-lg-6 col-md-6 mb-3">
                    <div class="card custom-card main-content-card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <span class="avatar avatar-md bg-success-transparent text-success">
                                        <i class="ri-check-double-line fs-5"></i>
                                    </span>
                                </div>
                                <div class="flex-fill">
                                    <span class="text-muted fs-12 text-uppercase fw-semibold">Completed</span>
                                    <h4 class="fw-bold mb-0 mt-1" id="stat-completed">0</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xl-12">
                    <div class="card custom-card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">Task Management</h5>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-wave" data-bs-toggle="modal" data-bs-target="#create-task" id="btnCreateTaskHeader" style="display:none;">
                                    <i class="ri-add-line align-middle me-1"></i> Create Task
                                </button>
                            </div>
                        </div>
                        
                        <div class="p-3 border-bottom bg-light-transparent">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-6 col-lg-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white border-end-0"><i class="ri-search-line text-muted"></i></span>
                                        <input type="text" class="form-control border-start-0 ps-0" id="taskSearch" placeholder="Search tasks..." oninput="handleSearch()">
                                    </div>
                                </div>
                                <div class="col-md-6 col-lg-8 text-end">
                                    <button class="btn btn-danger-light btn-sm" id="btnBulkDelete" onclick="deleteSelectedTasks()" style="display:none;">
                                        <i class="ri-delete-bin-line me-1"></i> Delete Selected
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover text-nowrap align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th scope="col" style="width: 40px;">
                                                <input class="form-check-input check-all" type="checkbox" id="all-tasks">
                                            </th>
                                            <th scope="col">Task Details</th>
                                            <th scope="col">ID</th>
                                            <th scope="col">Priority</th>
                                            <th scope="col">Status</th>
                                            <th scope="col">Assigned To</th>
                                            <th scope="col">Due Date</th>
                                            <th scope="col" class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tasks-tbody">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card-footer border-top-0 d-flex justify-content-between align-items-center">
                            <span class="text-muted fs-12" id="pagination-info">Showing tasks...</span>
                            <nav aria-label="Page navigation">
                                <ul class="pagination pagination-sm mb-0" id="pagination-controls"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="modal fade" id="create-task" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Create New Task</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row gy-3">
                    <div class="col-12">
                        <label for="task-name" class="form-label required fw-semibold">Task Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="task-name" placeholder="e.g. Design Homepage Banner">
                        <div class="invalid-feedback">Title is required.</div>
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label fw-semibold">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3" placeholder="Detailed description..."></textarea>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Assigned Date</label>
                        <div class="input-group">
                            <div class="input-group-text text-muted"><i class="ri-calendar-line"></i></div>
                            <input type="text" class="form-control" id="assignedDate" placeholder="Select date">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Due Date</label>
                        <div class="input-group">
                            <div class="input-group-text text-muted"><i class="ri-calendar-event-line"></i></div>
                            <input type="text" class="form-control" id="dueDate" placeholder="Select date">
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Priority</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Status</label>
                        <select class="form-select" id="taskStatus">
                            <option value="todo">To Do</option>
                            <option value="in_progress">In Progress</option>
                            <option value="review">Review</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Task ID</label>
                        <input type="text" class="form-control bg-light" id="task-id" placeholder="Auto-generated" readonly>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-semibold">Assign Team Members</label>
                        <select class="form-control" id="taskAssignee" name="assigned_to" multiple></select>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-semibold">Attachments</label>
                        <input type="file" class="form-control" id="taskAttachments" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx">
                        <small class="text-muted d-block mt-1">Max size 10MB per file.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnCreateTask" onclick="handleTaskSubmit()">Create Task</button>
            </div>
        </div>
    </div>
</div>

<%- include('includes/footer2') %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
    // --- Global State ---
    let tasks = [];
    let teamMembers = [];
    let assigneeChoices = null; 
    let filteredTasks = [];
    let currentTaskId = null;
    let currentPage = 1;
    const itemsPerPage = 8;
    const token = localStorage.getItem('token');
    
    // --- Permissions State ---
    let userRole = null;
    let userId = null;
    let permissions = {
        create: false,
        edit: false,
        delete: false
    };

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!token) { window.location.href = '/login'; return; }
        
        renderSkeletonTable();
        
        // 1. Fetch User Info & Permissions first
        await fetchUserContext();
        
        // 2. Load Data
        await Promise.all([loadTeamMembers(), loadTasks()]);
        
        // 3. Setup UI Components
        initDatePickers();
        initModalEvents();
        initGlobalListeners();
    });

    // --- Core Logic: Permissions ---
    async function fetchUserContext() {
        try {
            const res = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) throw new Error('Failed to fetch user');
            
            const data = await res.json();
            userRole = data.user.role;
            userId = data.user.id;

            if (userRole === 'employer') {
                // Employer has full access
                permissions.create = true;
                permissions.edit = true;
                permissions.delete = true;
            } else {
                // Fetch specific team permissions for employee
                const teamRes = await fetch('/api/team/my-membership', { headers: { 'Authorization': `Bearer ${token}` } });
                if (teamRes.ok) {
                    const teamData = await teamRes.json();
                    const perms = teamData.membership?.permissions || [];
                    permissions.create = perms.includes('create_tasks');
                    permissions.edit = perms.includes('edit_tasks');
                    permissions.delete = perms.includes('delete_tasks');
                }
            }

            // Update UI based on permissions
            if (permissions.create) {
                document.getElementById('btnCreateTaskHeader').style.display = 'inline-block';
            }

        } catch (e) {
            console.error('Context Error:', e);
            showToast('Error loading user permissions', '#ef4444');
        }
    }

    // --- Core Logic: Data Loading ---
    async function loadTasks() {
        try {
            const res = await fetch('/api/tasks', { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                const data = await res.json();
                tasks = data.tasks || [];
                // Sort by newest first
                tasks.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                handleSearch(); // Triggers render
                updateStats();
            }
        } catch (e) { console.error(e); }
    }

    async function loadTeamMembers() {
        try {
            const res = await fetch('/api/team/members', { headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                teamMembers = (await res.json()).members || [];
                initAssigneeDropdown();
            }
        } catch (e) { console.error(e); }
    }

    // --- Core Logic: CRUD Operations ---
    async function handleTaskSubmit() {
        const btn = document.getElementById('btnCreateTask');
        
        // Validation
        const data = getFormData();
        if (!validateForm(data)) return;

        // UI Loading State
        setLoading(btn, true);

        try {
            // 1. Upload Attachments
            const attachments = await uploadAttachments();
            data.attachments = attachments;

            // 2. Create or Update
            const url = currentTaskId ? `/api/tasks/${currentTaskId}` : '/api/tasks';
            const method = currentTaskId ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                const result = await res.json();
                if (currentTaskId) {
                    const idx = tasks.findIndex(t => t.id === currentTaskId);
                    if (idx !== -1) tasks[idx] = result.task;
                    showToast('Task updated successfully', '#10b981');
                } else {
                    tasks.unshift(result.task);
                    showToast('Task created successfully', '#10b981');
                }
                
                hideModal();
                handleSearch();
                updateStats();
            } else {
                const err = await res.json();
                showToast(err.message || 'Operation failed', '#ef4444');
            }
        } catch (e) {
            console.error(e);
            showToast('Network error occurred', '#ef4444');
        } finally {
            setLoading(btn, false, currentTaskId ? 'Update Task' : 'Create Task');
        }
    }

    async function deleteSelectedTasks() {
        if (!permissions.delete) { showToast('Permission denied', '#ef4444'); return; }

        const checked = Array.from(document.querySelectorAll('.task-check:checked')).map(cb => cb.value);
        if (checked.length === 0) return;
        
        if (!confirm(`Are you sure you want to delete ${checked.length} tasks? This cannot be undone.`)) return;

        try {
            await Promise.all(checked.map(id => 
                fetch(`/api/tasks/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } })
            ));
            
            tasks = tasks.filter(t => !checked.includes(t.id));
            handleSearch();
            updateStats();
            showToast('Tasks deleted successfully', '#10b981');
        } catch (e) {
            showToast('Error deleting tasks', '#ef4444');
        }
    }

    async function deleteTask(id) {
        if (!permissions.delete) return;
        if (!confirm('Delete this task?')) return;
        
        try {
            const res = await fetch(`/api/tasks/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (res.ok) {
                tasks = tasks.filter(t => t.id !== id);
                handleSearch();
                updateStats();
                showToast('Task deleted', '#10b981');
            }
        } catch(e) { console.error(e); }
    }

    // --- UI Rendering ---
    function renderTasksTable() {
        const tbody = document.getElementById('tasks-tbody');
        if (!tbody) return;

        if (filteredTasks.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="d-flex flex-column align-items-center">
                            <i class="ri-clipboard-line fs-1 text-muted mb-2"></i>
                            <h6 class="text-muted">No tasks found</h6>
                        </div>
                    </td>
                </tr>`;
            document.getElementById('pagination-controls').innerHTML = '';
            return;
        }

        // Pagination Logic
        const totalPages = Math.ceil(filteredTasks.length / itemsPerPage);
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * itemsPerPage;
        const pagedTasks = filteredTasks.slice(start, start + itemsPerPage);

        tbody.innerHTML = pagedTasks.map(task => {
            const isAssignedToMe = task.assignees && task.assignees.includes(userId);
            const isAccepted = task.is_accepted;
            
            // Interaction Logic
            const canEdit = permissions.edit || userRole === 'employer';
            const canDelete = permissions.delete || userRole === 'employer';
            
            // Status Select Disabled logic:
            // 1. If user is employee AND task assigned to them AND NOT accepted -> Disabled
            // 2. If user is employee AND NOT assigned to them -> Disabled
            let statusDisabled = false;
            if (userRole !== 'employer') {
                if (!isAssignedToMe) statusDisabled = true;
                if (isAssignedToMe && !isAccepted) statusDisabled = true;
            }

            return `
            <tr>
                <td>
                    <input class="form-check-input task-check" type="checkbox" value="${task.id}" onchange="updateBulkBtn()">
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <div>
                            <span class="d-block task-title text-truncate" style="max-width: 200px;" title="${escapeHtml(task.title)}">
                                ${escapeHtml(task.title)}
                            </span>
                            ${isAssignedToMe && !isAccepted ? '<span class="badge bg-warning-transparent fs-10">Needs Acceptance</span>' : ''}
                        </div>
                    </div>
                </td>
                <td><span class="task-id-badge">TSK-${task.id.slice(-4).toUpperCase()}</span></td>
                <td>${getPriorityBadge(task.priority)}</td>
                <td>
                    <select class="form-select form-select-sm status-select ${getStatusColorClass(task.status)}" 
                            onchange="updateStatus('${task.id}', this.value)" 
                            ${statusDisabled ? 'disabled title="Accept task first or not assigned to you"' : ''}>
                        <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                        <option value="in_progress" ${task.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                        <option value="review" ${task.status === 'review' ? 'selected' : ''}>Review</option>
                        <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
                <td>${renderAssignees(task.assignees)}</td>
                <td><span class="fs-12 text-muted">${formatDate(task.due_date)}</span></td>
                <td class="text-end">
                    <div class="btn-list">
                        ${isAssignedToMe && !isAccepted ? 
                            `<button class="btn btn-sm btn-success-light" onclick="acceptTask('${task.id}')" title="Accept Task"><i class="ri-check-line"></i></button>` 
                        : ''}
                        
                        <button class="btn btn-sm btn-icon btn-light" onclick="viewTask('${task.id}')"><i class="ri-eye-line"></i></button>
                        
                        ${canEdit ? 
                            `<button class="btn btn-sm btn-icon btn-primary-light" onclick="openEditModal('${task.id}')"><i class="ri-edit-line"></i></button>` 
                        : ''}
                        
                        ${canDelete ? 
                            `<button class="btn btn-sm btn-icon btn-danger-light" onclick="deleteTask('${task.id}')"><i class="ri-delete-bin-line"></i></button>` 
                        : ''}
                    </div>
                </td>
            </tr>
            `;
        }).join('');

        renderPagination(totalPages);
        document.getElementById('pagination-info').textContent = `Showing ${start + 1} to ${Math.min(start + itemsPerPage, filteredTasks.length)} of ${filteredTasks.length} entries`;
        document.getElementById('all-tasks').checked = false;
        updateBulkBtn();
    }

    // --- Helper Functions ---

    function getFormData() {
        const title = document.getElementById('task-name').value;
        const description = document.getElementById('taskDescription').value;
        const priority = document.getElementById('taskPriority').value;
        const status = document.getElementById('taskStatus').value;
        const due_date = document.getElementById('dueDate').value;
        const assignees = assigneeChoices ? assigneeChoices.getValue(true) : [];
        
        return { title, description, priority, status, due_date, assignees };
    }

    function validateForm(data) {
        if (!data.title.trim()) {
            document.getElementById('task-name').classList.add('is-invalid');
            return false;
        } else {
            document.getElementById('task-name').classList.remove('is-invalid');
        }
        
        if (data.due_date) {
            const today = new Date();
            today.setHours(0,0,0,0);
            if (new Date(data.due_date) < today) {
                // Optional: warning only, or prevent. Letting it pass for now but toast warning.
                // showToast('Warning: Due date is in the past', '#f59e0b');
            }
        }
        return true;
    }

    async function uploadAttachments() {
        const input = document.getElementById('taskAttachments');
        if (!input.files.length) return [];
        
        const files = [];
        for (const file of input.files) {
            if (file.size > 10 * 1024 * 1024) {
                showToast(`File ${file.name} is too large (Max 10MB)`, '#ef4444');
                continue;
            }
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const res = await fetch('/api/tasks/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                if (res.ok) {
                    const data = await res.json();
                    files.push({ url: data.url, file_name: file.name, file_size: file.size });
                }
            } catch(e) { console.error('Upload failed', e); }
        }
        return files;
    }

    async function updateStatus(id, newStatus) {
        try {
            const res = await fetch(`/api/tasks/${id}/status`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (res.ok) {
                const task = tasks.find(t => t.id === id);
                if (task) task.status = newStatus;
                updateStats();
                showToast('Status updated', '#10b981');
                
                // Re-render specifically to update color class of select
                const row = document.querySelector(`select[onchange="updateStatus('${id}', this.value)"]`);
                if(row) {
                    row.className = `form-select form-select-sm status-select ${getStatusColorClass(newStatus)}`;
                }
            }
        } catch(e) {
            showToast('Failed to update status', '#ef4444');
        }
    }

    async function acceptTask(id) {
        try {
            const res = await fetch(`/api/tasks/${id}/accept`, { 
                method: 'PATCH', 
                headers: { 'Authorization': `Bearer ${token}` } 
            });
            if (res.ok) {
                const task = tasks.find(t => t.id === id);
                if (task) task.is_accepted = true;
                renderTasksTable();
                showToast('Task accepted!', '#10b981');
            }
        } catch(e) { console.error(e); }
    }

    // --- Search & Pagination ---
    function handleSearch() {
        const term = document.getElementById('taskSearch').value.toLowerCase();
        filteredTasks = tasks.filter(t => 
            t.title.toLowerCase().includes(term) || 
            (t.description && t.description.toLowerCase().includes(term))
        );
        currentPage = 1;
        renderTasksTable();
    }

    function renderPagination(total) {
        const ul = document.getElementById('pagination-controls');
        if (total <= 1) { ul.innerHTML = ''; return; }
        
        let html = `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="goToPage(${currentPage - 1})">Prev</a>
            </li>`;
            
        for(let i=1; i<=total; i++) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>
                </li>`;
        }
        
        html += `
            <li class="page-item ${currentPage === total ? 'disabled' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="goToPage(${currentPage + 1})">Next</a>
            </li>`;
            
        ul.innerHTML = html;
    }

    function goToPage(p) {
        currentPage = p;
        renderTasksTable();
    }

    // --- Render Helpers ---
    function getPriorityBadge(p) {
        const colors = { low: 'bg-success', medium: 'bg-primary', high: 'bg-warning', urgent: 'bg-danger' };
        return `<span class="badge ${colors[p] || 'bg-secondary'} bg-opacity-10 text-${(colors[p] || 'bg-secondary').replace('bg-', '')} px-2 py-1">${p.toUpperCase()}</span>`;
    }

    function getStatusColorClass(s) {
        const map = { todo: 'text-primary', in_progress: 'text-secondary', review: 'text-warning', completed: 'text-success' };
        return map[s] || '';
    }

    function renderAssignees(ids) {
        if (!ids || ids.length === 0) return '<span class="text-muted fs-11">Unassigned</span>';
        
        let html = '<div class="avatar-list-stacked">';
        const max = 3;
        
        ids.slice(0, max).forEach(id => {
            const mem = teamMembers.find(m => (m.user?.id || m.user_id) === id);
            const img = mem?.user?.profile_picture_url || mem?.profile_picture_url || '/build/assets/images/faces/9.jpg';
            const name = mem?.user?.full_name || mem?.full_name || 'Unknown';
            html += `<span class="avatar avatar-sm avatar-rounded" data-bs-toggle="tooltip" title="${name}"><img src="${img}" alt="img"></span>`;
        });

        if (ids.length > max) {
            html += `<span class="avatar avatar-sm avatar-rounded bg-light text-muted fs-10">+${ids.length - max}</span>`;
        }
        html += '</div>';
        return html;
    }

    function formatDate(d) {
        return d ? new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }) : '<span class="text-muted">-</span>';
    }

    function updateStats() {
        const counts = { todo: 0, in_progress: 0, review: 0, completed: 0 };
        tasks.forEach(t => { if(counts[t.status] !== undefined) counts[t.status]++; });
        
        document.getElementById('stat-new').textContent = counts.todo;
        document.getElementById('stat-inprogress').textContent = counts.in_progress;
        document.getElementById('stat-pending').textContent = counts.review;
        document.getElementById('stat-completed').textContent = counts.completed;
    }

    function renderSkeletonTable() {
        const tbody = document.getElementById('tasks-tbody');
        tbody.innerHTML = Array(5).fill(0).map(() => `
            <tr>
                <td><div class="skeleton" style="width:20px;"></div></td>
                <td><div class="skeleton" style="width:150px;"></div></td>
                <td><div class="skeleton" style="width:60px;"></div></td>
                <td><div class="skeleton" style="width:80px;"></div></td>
                <td><div class="skeleton" style="width:100px;"></div></td>
                <td><div class="skeleton" style="width:80px;"></div></td>
                <td><div class="skeleton" style="width:80px;"></div></td>
                <td><div class="skeleton" style="width:50px;"></div></td>
            </tr>
        `).join('');
    }

    // --- Components Init ---
    function initDatePickers() {
        flatpickr("#dueDate", { dateFormat: "Y-m-d", minDate: "today" });
        flatpickr("#assignedDate", { dateFormat: "Y-m-d", defaultDate: "today" });
    }

    function initAssigneeDropdown() {
        const el = document.getElementById('taskAssignee');
        if (assigneeChoices) assigneeChoices.destroy();
        
        const options = teamMembers.map(m => ({
            value: m.user?.id || m.user_id,
            label: m.user?.full_name || m.full_name || 'Member',
        }));

        assigneeChoices = new Choices(el, {
            removeItemButton: true,
            placeholderValue: 'Select members',
            searchPlaceholderValue: 'Search...',
            choices: options
        });
    }

    function initModalEvents() {
        const modal = document.getElementById('create-task');
        modal.addEventListener('hidden.bs.modal', () => {
            currentTaskId = null;
            document.querySelector('.modal-title').textContent = 'Create New Task';
            document.getElementById('btnCreateTask').textContent = 'Create Task';
            document.getElementById('task-name').value = '';
            document.getElementById('task-name').classList.remove('is-invalid');
            document.getElementById('taskDescription').value = '';
            document.getElementById('task-id').value = '';
            document.getElementById('dueDate')._flatpickr.clear();
            if(assigneeChoices) assigneeChoices.removeActiveItems();
            document.getElementById('taskStatus').value = 'todo';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskAttachments').value = '';
        });
    }

    function openEditModal(id) {
        const task = tasks.find(t => t.id === id);
        if(!task) return;
        
        currentTaskId = id;
        document.querySelector('.modal-title').textContent = 'Edit Task';
        document.getElementById('btnCreateTask').textContent = 'Update Task';
        
        document.getElementById('task-name').value = task.title;
        document.getElementById('taskDescription').value = task.description || '';
        document.getElementById('task-id').value = 'TSK-' + task.id.slice(-4).toUpperCase();
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('taskStatus').value = task.status;
        
        if (task.due_date) document.getElementById('dueDate')._flatpickr.setDate(task.due_date);
        
        if (assigneeChoices && task.assignees) {
            assigneeChoices.setChoiceByValue(task.assignees);
        }
        
        new bootstrap.Modal(document.getElementById('create-task')).show();
    }

    function initGlobalListeners() {
        document.getElementById('all-tasks').addEventListener('change', (e) => {
            document.querySelectorAll('.task-check').forEach(cb => cb.checked = e.target.checked);
            updateBulkBtn();
        });
    }

    function updateBulkBtn() {
        const count = document.querySelectorAll('.task-check:checked').length;
        document.getElementById('btnBulkDelete').style.display = count > 0 && permissions.delete ? 'inline-block' : 'none';
    }

    // --- Utils ---
    function showToast(text, color) {
        Toastify({ 
            text, 
            backgroundColor: color, 
            gravity: "top", 
            position: "right", 
            duration: 3000,
            close: true
        }).showToast();
    }

    function setLoading(btn, isLoading, text) {
        if(isLoading) {
            btn.innerHTML = '<i class="ri-loader-4-line spin me-1"></i> Processing...';
            btn.disabled = true;
        } else {
            btn.innerHTML = text;
            btn.disabled = false;
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function viewTask(id) {
        const prefix = userRole === 'employer' ? 'employer' : 'employee';
        window.location.href = `/dashboard/${prefix}/tasks/${id}`;
    }
</script>