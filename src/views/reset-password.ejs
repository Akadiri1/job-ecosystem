<%- include('includes/header', { title: 'Set New Password' }) %>

<style>
    /* --- STYLING (Same as Login/Register) --- */
    input:-webkit-autofill,
    input:-webkit-autofill:hover, 
    input:-webkit-autofill:focus, 
    input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px #455a64 inset !important; 
        -webkit-text-fill-color: white !important;
        transition: background-color 5000s ease-in-out 0s;
    }

    .input-field input {
        border-bottom: 1px solid rgba(255,255,255,0.5) !important;
        color: white !important;
    }

    .input-field input:focus {
        border-bottom: 1px solid #ba68c8 !important;
        box-shadow: 0 1px 0 0 #ba68c8 !important;
    }

    .input-field label { color: rgba(255,255,255,0.7) !important; }
    .input-field input:focus + label { color: #ba68c8 !important; }

    .btn-save {
        background: linear-gradient(45deg, #7b1fa2, #ba68c8);
        border-radius: 50px;
        font-weight: bold;
        width: 80%;
    }
</style>

<div class="content-area">
    <div class="login-bg access-reset"></div>

    <div class="container login-area">
        <div class="section">

            <h3 class="bot-20 center white-text" style="font-weight: 300;">Reset Password</h3>
            <p class="center white-text" style="opacity: 0.8; margin-bottom: 20px;">
                Check your email for the OTP code.
            </p>

            <form id="newPasswordForm">
                
                <input type="hidden" id="emailHidden">

                <div class="row">
                    <div class="input-field col s10 offset-s1">
                        <input id="otpCode" type="text" class="validate" required maxlength="6" pattern="\d*">
                        <label for="otpCode">Enter 6-Digit OTP</label>
                    </div>
                </div>

                <div class="row">
                    <div class="input-field col s10 offset-s1">
                        <input id="pass3" type="password" class="validate" required minlength="6">
                        <label for="pass3">New Password</label>
                    </div>
                </div>

                <div class="row">
                    <div class="input-field col s10 offset-s1">
                        <input id="pass31" type="password" class="validate" required>
                        <label for="pass31">Confirm New Password</label>
                    </div>
                </div>

                <div class="row">
                    <div class="col s10 offset-s1">
                        <div id="messageBox" style="text-align: center; font-weight: bold; margin-bottom: 15px;"></div>
                    </div>
                </div>

                <div class="row center">
                    <button type="submit" class="waves-effect waves-light btn-large btn-save">
                        Save Password
                    </button>
                    
                    <div class="spacer" style="height: 20px;"></div>
                    <div class="links white-text">
                        <a href="/login" style="color: rgba(255,255,255,0.8);">Back to Login</a>
                    </div>
                    <div class="spacer"></div>
                </div>

            </form>

        </div>
    </div>
</div>

<script>
    // 1. Auto-fill email from URL logic
    // When page loads, check if ?email=... is in the address bar
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        if (email) {
            document.getElementById('emailHidden').value = email;
        } else {
            document.getElementById('messageBox').innerText = "⚠️ Missing Email. Please go back to 'Forgot Password'.";
            document.getElementById('messageBox').style.color = "orange";
        }
    });

    // 2. Handle Form Submit
    document.getElementById('newPasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const messageBox = document.getElementById('messageBox');
        messageBox.innerText = "Updating password...";
        messageBox.style.color = "white";

        // Get values
        const email = document.getElementById('emailHidden').value;
        const otp = document.getElementById('otpCode').value;
        const newPassword = document.getElementById('pass3').value;
        const confirmPassword = document.getElementById('pass31').value;

        // Basic Validation
        if (!email) return messageBox.innerText = "❌ Email missing. Restart process.";
        if (newPassword !== confirmPassword) {
            messageBox.style.color = "#ff5252";
            messageBox.innerText = "❌ Passwords do not match!";
            return;
        }

        const formData = { email, otp, newPassword };

        try {
            const response = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                // SUCCESS
                messageBox.style.color = "#00e676"; 
                messageBox.innerHTML = "✅ Password Reset Successful! Redirecting...";
                
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                // ERROR (Wrong OTP, Expired, etc.)
                messageBox.style.color = "#ff5252"; 
                messageBox.innerText = "❌ " + (data.error || "Reset failed");
            }
        } catch (err) {
            console.error(err);
            messageBox.style.color = "#ff5252";
            messageBox.innerText = "❌ Server Error.";
        }
    });
</script>

<%- include('includes/footer') %>